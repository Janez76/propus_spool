---
import Layout from '../../layouts/Layout.astro'
---

<Layout title="FilaMan - Manufacturers">
  <style>
    .sortable { cursor: pointer; user-select: none; }
    .sortable:hover { background: var(--bg-hover); }
    .sortable::after { content: ' \2195'; opacity: 0.3; font-size: 0.8em; }
    .sortable.sort-asc::after { content: ' \2191'; opacity: 1; }
    .sortable.sort-desc::after { content: ' \2193'; opacity: 1; }
    .filter-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 16px;
      align-items: center;
    }
    .filter-bar .fm-input-search {
      flex: 1;
      min-width: 200px;
      max-width: 400px;
    }
  </style>
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
    <h1 style="font-size: 1.8rem; font-weight: 700;" data-i18n="manufacturers.title">Manufacturers</h1>
    <button id="btn-new" class="fm-btn fm-btn-primary" data-i18n="manufacturers.addManufacturer">
      Add Manufacturer
    </button>
  </div>

  <div class="filter-bar">
    <input
      type="text"
      id="filter-search"
      class="fm-input fm-input-search"
      data-i18n-placeholder="manufacturers.searchPlaceholder"
      placeholder="Search manufacturers..."
    />
    <select id="filter-material" class="fm-select" style="width: auto; min-width: 160px;">
      <option value="" data-i18n="manufacturers.allMaterials">All Materials</option>
    </select>
  </div>

  <div class="fm-card" style="padding: 0; overflow: hidden;">
    <table class="fm-table">
      <thead>
        <tr>
          <th data-i18n="manufacturers.name" data-sort="name" class="sortable">Name</th>
          <th data-i18n="manufacturers.url" data-sort="url" class="sortable">URL</th>
          <th data-i18n="manufacturers.filaments" data-sort="filament_count" class="sortable">Filaments</th>
          <th data-i18n="manufacturers.spools" data-sort="spool_count" class="sortable">Spools</th>
          <th data-i18n="manufacturers.materials">Materials</th>
          <th style="text-align: right;" data-i18n="common.actions">Actions</th>
        </tr>
      </thead>
      <tbody id="manufacturers-table">
        <tr>
          <td colspan="6" style="text-align: center; color: var(--text-muted); padding: 24px;" data-i18n="common.loading">Loading...</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Modal -->
  <div id="modal-container" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 50;">
    <div class="fm-card" style="width: 100%; max-width: 480px; margin: 16px;">
      <h3 id="modal-title" style="font-size: 1.1rem; font-weight: 600; margin-bottom: 16px;" data-i18n="manufacturers.addManufacturer">Add Manufacturer</h3>
      <form id="modal-form" style="display: grid; gap: 16px;">
        <input type="hidden" id="manufacturer-id" />
        <div>
          <label for="manufacturer-name" class="fm-label">
            <span data-i18n="manufacturers.name">Name</span> *
          </label>
          <input
            type="text"
            id="manufacturer-name"
            required
            class="fm-input"
            data-i18n-placeholder="manufacturers.namePlaceholder"
            placeholder="e.g. Bambu Lab"
          />
        </div>
        <div>
          <label for="manufacturer-url" class="fm-label" data-i18n="manufacturers.url">
            URL
          </label>
          <input
            type="url"
            id="manufacturer-url"
            class="fm-input"
            data-i18n-placeholder="manufacturers.urlPlaceholder"
            placeholder="e.g. https://bambulab.com"
          />
        </div>
        <div id="modal-error" class="fm-alert-error hidden"></div>
        <div style="display: flex; gap: 12px;">
          <button type="submit" id="modal-submit" class="fm-btn fm-btn-primary" data-i18n="common.save">
            Save
          </button>
          <button type="button" id="modal-cancel" class="fm-btn fm-btn-outline" data-i18n="common.cancel">
            Cancel
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
    import { t, initI18n } from '../../lib/i18n'
    await initI18n()

    let manufacturers: any[] = []
    let sortKey: string | null = null
    let sortDirection: 'asc' | 'desc' | null = null
    let searchTimeout: ReturnType<typeof setTimeout> | null = null

    function setupSortableHeaders() {
      document.querySelectorAll('th[data-sort]').forEach(th => {
        th.addEventListener('click', () => {
          const key = (th as HTMLElement).dataset.sort!
          if (sortKey === key) {
            if (sortDirection === 'asc') sortDirection = 'desc'
            else if (sortDirection === 'desc') { sortKey = null; sortDirection = null }
            else sortDirection = 'asc'
          } else {
            sortKey = key
            sortDirection = 'asc'
          }
          updateSortIndicators()
          renderManufacturers()
        })
      })
    }

    function updateSortIndicators() {
      document.querySelectorAll('th[data-sort]').forEach(th => {
        const key = (th as HTMLElement).dataset.sort!
        th.classList.remove('sort-asc', 'sort-desc')
        if (sortKey === key && sortDirection) {
          th.classList.add(sortDirection === 'asc' ? 'sort-asc' : 'sort-desc')
        }
      })
    }

    function sortManufacturers(items: any[]): any[] {
      if (!sortKey || !sortDirection) return items
      return [...items].sort((a, b) => {
        const aVal = a[sortKey] ?? ''
        const bVal = b[sortKey] ?? ''
        let cmp = 0
        if (typeof aVal === 'string') cmp = aVal.localeCompare(bVal)
        else cmp = aVal - bVal
        return sortDirection === 'asc' ? cmp : -cmp
      })
    }

    function getCsrfToken(): string {
      const match = document.cookie.match(/(?:^|;\s*)csrf_token=([^;]*)/)
      return match ? decodeURIComponent(match[1]) : ''
    }

    function getFilterValues() {
      const search = (document.getElementById('filter-search') as HTMLInputElement).value.toLowerCase().trim()
      const material = (document.getElementById('filter-material') as HTMLSelectElement).value
      return { search, material }
    }

    function filterManufacturers(items: any[]): any[] {
      const { search, material } = getFilterValues()

      return items.filter(mf => {
        // Material filter
        if (material) {
          const hasMaterial = mf.materials && mf.materials.some((m: string) => m === material)
          if (!hasMaterial) return false
        }

        // Text search across name, url, materials
        if (search) {
          const name = (mf.name || '').toLowerCase()
          const url = (mf.url || '').toLowerCase()
          const materials = (mf.materials || []).join(' ').toLowerCase()
          const haystack = `${name} ${url} ${materials}`
          if (!haystack.includes(search)) return false
        }

        return true
      })
    }

    function populateMaterialFilter(items: any[]) {
      const materialSelect = document.getElementById('filter-material') as HTMLSelectElement
      const materials = new Set<string>()
      items.forEach(mf => {
        if (mf.materials) {
          mf.materials.forEach((m: string) => materials.add(m))
        }
      })
      const sortedMaterials = [...materials].sort()
      sortedMaterials.forEach(mat => {
        const opt = document.createElement('option')
        opt.value = mat
        opt.textContent = mat
        materialSelect.appendChild(opt)
      })
    }

    async function loadManufacturers() {
      try {
        const mfRes = await fetch('/api/v1/manufacturers?page_size=200', { credentials: 'include' })
        if (!mfRes.ok) throw new Error('Failed to fetch manufacturers')
        manufacturers = await mfRes.json().then(d => d.items)
        populateMaterialFilter(manufacturers)
        renderManufacturers()
      } catch (error) {
        console.error('Failed to load manufacturers:', error)
        document.getElementById('manufacturers-table')!.innerHTML = `
          <tr>
            <td colspan="6" style="text-align: center; color: var(--error-text); padding: 24px;">${t('manufacturers.failedLoad')}</td>
          </tr>
        `
      }
    }

    function escapeHtml(str: string): string {
      const div = document.createElement('div')
      div.textContent = str
      return div.innerHTML
    }

    function renderManufacturers() {
      const tbody = document.getElementById('manufacturers-table')!
      const filtered = filterManufacturers(manufacturers)
      const sorted = sortManufacturers(filtered)

      if (sorted.length === 0) {
        const { search, material } = getFilterValues()
        const hasFilters = search || material
        tbody.innerHTML = `
          <tr>
            <td colspan="6" style="text-align: center; color: var(--text-muted); padding: 24px;">
              ${hasFilters ? t('manufacturers.noResults') : t('manufacturers.noManufacturers')}
            </td>
          </tr>
        `
        return
      }

      tbody.innerHTML = sorted.map(mf => `
        <tr>
          <td style="font-weight: 500;">${escapeHtml(mf.name)}</td>
          <td>${mf.url ? `<a href="${escapeHtml(mf.url)}" target="_blank" rel="noopener" style="color: var(--accent); text-decoration: none;">${escapeHtml(mf.url)}</a>` : '<span style="color: var(--text-muted);">-</span>'}</td>
          <td><a href="/filaments?manufacturer_id=${mf.id}" style="color: var(--accent); text-decoration: none; font-weight: 500;">${mf.filament_count || 0}</a></td>
          <td><a href="/spools?manufacturer_id=${mf.id}" style="color: var(--accent); text-decoration: none; font-weight: 500;">${mf.spool_count || 0}</a></td>
          <td>${mf.materials && mf.materials.length > 0 ? mf.materials.map(m => escapeHtml(m)).join(', ') : '<span style="color: var(--text-muted);">-</span>'}</td>
          <td style="text-align: right; white-space: nowrap;">
            <button data-id="${mf.id}" data-name="${escapeHtml(mf.name)}" data-url="${escapeHtml(mf.url || '')}" class="btn-edit fm-btn fm-btn-outline" style="padding: 5px 12px; font-size: 0.8rem;">${t('common.edit')}</button>
            <button data-id="${mf.id}" class="btn-delete fm-btn fm-btn-danger" style="padding: 5px 12px; font-size: 0.8rem; margin-left: 6px;">${t('common.delete')}</button>
          </td>
        </tr>
      `).join('')

      document.querySelectorAll('.btn-edit').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const target = e.currentTarget as HTMLButtonElement
          openModal(
            parseInt(target.dataset.id!),
            target.dataset.name!,
            target.dataset.url!
          )
        })
      })

      document.querySelectorAll('.btn-delete').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const target = e.currentTarget as HTMLButtonElement
          const id = parseInt(target.dataset.id!)

          if (!(await (window as any).__fmConfirm(t('manufacturers.confirmDelete')))) return

          try {
            const response = await fetch(`/api/v1/manufacturers/${id}`, {
              method: 'DELETE',
              headers: { 'X-CSRF-Token': getCsrfToken() },
              credentials: 'include',
            })

            if (!response.ok) {
              const data = await response.json()
              await (window as any).__fmAlert(data.detail?.message || data.message || t('manufacturers.failedDelete'))
              return
            }

            loadManufacturers()
          } catch {
            await (window as any).__fmAlert(t('manufacturers.failedDelete'))
          }
        })
      })
    }

    function openModal(id: number | null = null, name: string = '', url: string = '') {
      const container = document.getElementById('modal-container')!
      const title = document.getElementById('modal-title')!
      const idInput = document.getElementById('manufacturer-id') as HTMLInputElement
      const nameInput = document.getElementById('manufacturer-name') as HTMLInputElement
      const urlInput = document.getElementById('manufacturer-url') as HTMLInputElement
      const error = document.getElementById('modal-error')!

      title.textContent = id ? t('manufacturers.editManufacturer') : t('manufacturers.addManufacturer')
      idInput.value = id ? String(id) : ''
      nameInput.value = name
      urlInput.value = url
      error.classList.add('hidden')

      container.style.display = 'flex'
      nameInput.focus()
    }

    function closeModal() {
      document.getElementById('modal-container')!.style.display = 'none'
    }

    document.getElementById('btn-new')?.addEventListener('click', () => openModal())
    document.getElementById('modal-cancel')?.addEventListener('click', closeModal)

    // Close modal on backdrop click
    document.getElementById('modal-container')?.addEventListener('click', (e) => {
      if (e.target === e.currentTarget) closeModal()
    })

    // Close modal on Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeModal()
    })

    document.getElementById('modal-form')?.addEventListener('submit', async (e) => {
      e.preventDefault()

      const id = (document.getElementById('manufacturer-id') as HTMLInputElement).value
      const name = (document.getElementById('manufacturer-name') as HTMLInputElement).value
      const url = (document.getElementById('manufacturer-url') as HTMLInputElement).value || null
      const error = document.getElementById('modal-error') as HTMLDivElement
      const submitBtn = document.getElementById('modal-submit') as HTMLButtonElement

      const data: Record<string, any> = { name }
      if (url !== null) data.url = url
      else data.url = null

      error.classList.add('hidden')
      submitBtn.disabled = true
      submitBtn.textContent = t('common.saving')

      try {
        const apiUrl = id ? `/api/v1/manufacturers/${id}` : '/api/v1/manufacturers'
        const method = id ? 'PATCH' : 'POST'

        const response = await fetch(apiUrl, {
          method,
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': getCsrfToken(),
          },
          credentials: 'include',
          body: JSON.stringify(data),
        })

        if (!response.ok) {
          const errorData = await response.json()
          throw new Error(errorData.detail?.message || errorData.message || t('manufacturers.failedSave'))
        }

        closeModal()
        loadManufacturers()
      } catch (err: any) {
        error.textContent = err.message
        error.classList.remove('hidden')
      } finally {
        submitBtn.disabled = false
        submitBtn.textContent = t('common.save')
      }
    })

    // Wire up filter events
    document.getElementById('filter-search')?.addEventListener('input', () => {
      if (searchTimeout) clearTimeout(searchTimeout)
      searchTimeout = setTimeout(() => renderManufacturers(), 250)
    })
    document.getElementById('filter-material')?.addEventListener('change', () => renderManufacturers())

    setupSortableHeaders()
    loadManufacturers()
  </script>
</Layout>
