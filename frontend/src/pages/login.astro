---
import '../styles/global.css'

interface Props {
  error?: string
}

const { error } = Astro.props
---

<html lang="en" data-theme="brand">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/png" href="/logo.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <title>Login - Propus Spool</title>
    <script is:inline>
      (function() {
        var t = localStorage.getItem('theme') || 'brand';
        document.documentElement.setAttribute('data-theme', t);
        var l = localStorage.getItem('lang') || 'en';
        document.documentElement.setAttribute('lang', l);
      })();
    </script>
    <style>
      .login-page {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--gradient-hero);
        position: relative;
        overflow: hidden;
      }
      .login-page::before {
        content: "";
        position: absolute;
        width: 500px;
        height: 500px;
        border-radius: 50%;
        background: var(--accent);
        opacity: 0.03;
        top: -200px;
        right: -100px;
        pointer-events: none;
      }
      .login-page::after {
        content: "";
        position: absolute;
        width: 400px;
        height: 400px;
        border-radius: 50%;
        background: var(--accent-2);
        opacity: 0.03;
        bottom: -150px;
        left: -100px;
        pointer-events: none;
      }
      .login-container {
        width: 100%;
        max-width: 400px;
        padding: 16px;
        position: relative;
        z-index: 1;
      }
      .login-card {
        background: var(--bg-elevated);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        padding: 32px;
        box-shadow: var(--shadow-lg);
      }
      .login-logo {
        text-align: center;
        margin-bottom: 28px;
      }
      .login-logo img {
        width: 52px;
        height: 52px;
        border-radius: 14px;
        margin-bottom: 12px;
      }
      .login-logo h1 {
        font-size: 1.3rem;
        font-weight: 700;
        margin: 0;
        background: var(--gradient-accent);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }
      .login-logo p {
        color: var(--text-muted);
        font-size: 0.8rem;
        margin: 4px 0 0;
      }
    </style>
  </head>
  <body>
    <div class="login-page">
      <div class="login-container">
        <div class="login-card">
          <div class="login-logo">
            <img src="/logo.png" alt="Propus Spool" />
            <h1 data-i18n="login.heading">Propus Spool</h1>
            <p data-i18n="login.subtitle">Filament Management System</p>
          </div>

          {error && (
            <div class="fm-alert-error" style="margin-bottom: 16px;">
              {error}
            </div>
          )}

          <form id="login-form" style="display: grid; gap: 14px;">
            <div>
              <label for="email" class="fm-label" data-i18n="login.email">Email</label>
              <input type="email" id="email" name="email" required autocomplete="email" class="fm-input" />
            </div>
            <div>
              <label for="password" class="fm-label" data-i18n="login.password">Password</label>
              <input type="password" id="password" name="password" required autocomplete="current-password" class="fm-input" />
            </div>
            <div id="error-message" class="fm-alert-error hidden"></div>
            <button type="submit" id="submit-btn" class="fm-btn fm-btn-primary" style="width: 100%; padding: 10px 20px; margin-top: 4px; justify-content: center;" data-i18n="login.signIn">
              Sign in
            </button>
          </form>
        </div>
      </div>
    </div>

    <script>
      import { t, initI18n } from '../lib/i18n'

      async function init() {
        await initI18n()
        document.title = t('login.title')

        document.querySelectorAll('[data-i18n]').forEach(el => {
          el.textContent = t(el.getAttribute('data-i18n')!)
        })

        const form = document.getElementById('login-form') as HTMLFormElement
        const errorMessage = document.getElementById('error-message') as HTMLDivElement
        const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement

        form.addEventListener('submit', async (e) => {
          e.preventDefault()

          const email = (document.getElementById('email') as HTMLInputElement).value
          const password = (document.getElementById('password') as HTMLInputElement).value

          errorMessage.classList.add('hidden')
          submitBtn.disabled = true
          submitBtn.textContent = t('login.signingIn')

          try {
            const response = await fetch('/auth/login', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify({ email, password }),
            })

            if (response.ok) {
              window.location.href = '/'
              return
            }

            const data = await response.json()
            errorMessage.textContent = data.message || t('login.failed')
            errorMessage.classList.remove('hidden')
          } catch (err) {
            errorMessage.textContent = t('login.networkError')
            errorMessage.classList.remove('hidden')
          } finally {
            submitBtn.disabled = false
            submitBtn.textContent = t('login.signIn')
          }
        })
      }

      init()
    </script>
  </body>
</html>
