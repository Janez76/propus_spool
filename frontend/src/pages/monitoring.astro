---
import Layout from '../layouts/Layout.astro'
---

<Layout title="Propus Spool - Monitoring">
  <style is:global>
    .mon-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 12px;
    }
    .mon-header h1 {
      font-size: 1.5rem;
      font-weight: 700;
      margin: 0;
    }
    .mon-refresh-info {
      font-size: 0.75rem;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .mon-pulse {
      width: 8px; height: 8px; border-radius: 50%;
      background: #10b981;
      animation: pulse-ring 2s ease-out infinite;
    }
    @keyframes pulse-ring {
      0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); }
      70% { box-shadow: 0 0 0 6px rgba(16, 185, 129, 0); }
      100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
    }

    .mon-list { display: flex; flex-direction: column; gap: 14px; }

    /* ── Printer card (horizontal bar) ── */
    .mc {
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      overflow: hidden;
      transition: border-color 0.2s;
    }
    .mc:hover { border-color: var(--accent); }

    /* Top row: name + badge */
    .mc-head {
      display: flex; align-items: center; gap: 8px;
      padding: 7px 12px;
      border-bottom: 1px solid var(--border-subtle);
    }
    .mc-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
    .mc-name { font-weight: 600; font-size: 0.82rem; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .mc-model { font-size: 0.68rem; color: var(--text-muted); margin-left: 4px; }
    .mc-badge {
      font-size: 0.6rem; font-weight: 700; padding: 2px 8px;
      border-radius: 10px; text-transform: uppercase; letter-spacing: 0.04em;
      white-space: nowrap;
    }
    .mc-badge.printing { background: rgba(16,185,129,.15); color: #10b981; }
    .mc-badge.idle { background: rgba(107,114,128,.15); color: #6b7280; }
    .mc-badge.paused { background: rgba(251,191,36,.15); color: #eab308; }
    .mc-badge.error { background: rgba(239,68,68,.15); color: #ef4444; }
    .mc-badge.preparing { background: rgba(56,189,248,.15); color: #38bdf8; }
    .mc-badge.offline { background: rgba(107,114,128,.1); color: #4b5563; }

    /* Body – horizontal layout */
    .mc-body {
      display: grid;
      grid-template-columns: auto 1fr auto auto;
      gap: 0;
      align-items: stretch;
    }

    /* Camera panel */
    .mc-cam {
      width: 160px;
      background: #0a0a0a;
      display: flex; align-items: center; justify-content: center;
      overflow: hidden;
      border-right: 1px solid var(--border-subtle);
    }
    .mc-cam img {
      width: 100%; height: 100%;
      object-fit: cover; display: block;
    }
    .mc-cam-none {
      width: 40px;
      display: flex; align-items: center; justify-content: center;
      border-right: 1px solid var(--border-subtle);
      color: var(--text-muted); opacity: 0.3;
    }

    /* Info center */
    .mc-info {
      padding: 8px 12px;
      display: flex; flex-direction: column; gap: 4px;
      min-width: 0;
    }
    .mc-job {
      display: flex; align-items: center; gap: 5px;
      font-size: 0.78rem; font-weight: 600;
      overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    .mc-job svg { flex-shrink: 0; opacity: 0.5; }
    .mc-times {
      display: flex; gap: 6px;
    }
    .mc-time-box {
      background: var(--bg-soft);
      border-radius: var(--radius-sm);
      padding: 3px 8px;
      display: flex; flex-direction: column;
    }
    .mc-time-label {
      font-size: 0.55rem; color: var(--text-muted);
      text-transform: uppercase; letter-spacing: 0.04em;
    }
    .mc-time-val {
      font-size: 0.78rem; font-weight: 700;
      font-family: var(--font-mono);
    }
    .mc-progress {
      height: 6px;
      background: var(--bg-soft);
      border-radius: 3px; overflow: hidden;
    }
    .mc-progress-fill {
      height: 100%; border-radius: 3px;
      background: linear-gradient(90deg, #3b82f6, #60a5fa);
      transition: width 0.5s ease;
    }

    /* Temps panel */
    .mc-temps {
      display: flex; flex-direction: column; gap: 0;
      border-left: 1px solid var(--border-subtle);
      min-width: 100px;
    }
    .mc-temp {
      flex: 1;
      padding: 6px 10px;
      display: flex; flex-direction: column; justify-content: center;
    }
    .mc-temp + .mc-temp { border-top: 1px solid var(--border-subtle); }
    .mc-temp-head {
      display: flex; align-items: center; gap: 4px;
      font-size: 0.58rem; color: var(--text-muted);
      text-transform: uppercase; letter-spacing: 0.04em;
      margin-bottom: 1px;
    }
    .mc-temp-head svg { flex-shrink: 0; opacity: 0.5; }
    .mc-temp-val {
      font-size: 0.88rem; font-weight: 700;
      font-family: var(--font-mono);
      line-height: 1.2;
    }
    .mc-temp-val small { font-size: 0.68rem; font-weight: 400; color: var(--text-muted); }

    /* AMS panel */
    .mc-ams {
      border-left: 1px solid var(--border-subtle);
      padding: 8px 10px;
      display: flex; flex-direction: column; gap: 4px;
      min-width: 0;
    }
    .mc-ams-head {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 2px;
    }
    .mc-ams-title {
      font-size: 0.68rem; font-weight: 700;
      text-transform: uppercase; letter-spacing: 0.04em;
    }
    .mc-ams-sub {
      font-size: 0.6rem; color: var(--text-muted);
    }
    .mc-slots {
      display: flex; gap: 4px; flex-wrap: wrap;
    }
    .mc-slot {
      width: 68px;
      background: var(--bg);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-sm);
      padding: 4px 4px 3px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    .mc-slot.filled { border-color: var(--border); }
    .mc-slot-top {
      display: flex; align-items: center; justify-content: center; gap: 3px;
      margin-bottom: 2px;
    }
    .mc-slot-no {
      font-size: 0.55rem; color: var(--text-muted); font-weight: 700;
    }
    .mc-slot-dot {
      width: 10px; height: 10px; border-radius: 50%;
      border: 1.5px solid var(--border);
      flex-shrink: 0;
    }
    .mc-slot-mat {
      font-size: 0.62rem; font-weight: 600;
      overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    .mc-slot-name {
      font-size: 0.52rem; color: var(--text-muted);
      overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    .mc-slot-pct-wrap {
      margin-top: 2px;
      height: 3px; background: var(--bg-soft);
      border-radius: 2px; overflow: hidden;
    }
    .mc-slot-pct-bar {
      height: 100%; border-radius: 2px;
      transition: width 0.3s;
    }
    .mc-slot-pct-text {
      font-size: 0.55rem; font-family: var(--font-mono);
      margin-top: 1px;
    }
    .mc-slot-empty {
      font-size: 0.6rem; color: var(--text-muted); opacity: 0.5;
      padding: 3px 0;
    }

    /* Idle card */
    .mc-idle {
      padding: 10px;
      display: flex; align-items: center; justify-content: center;
      color: var(--text-muted); font-size: 0.78rem; gap: 6px;
    }

    /* Idle AMS below */
    .mc-ams-standalone {
      padding: 6px 12px 10px;
      border-top: 1px solid var(--border-subtle);
    }
    .mc-ams-standalone .mc-ams-head { margin-bottom: 4px; }
    .mc-ams-standalone .mc-slots { justify-content: flex-start; }

    /* ── Responsive ── */
    @media (max-width: 900px) {
      .mc-body { grid-template-columns: 1fr; }
      .mc-cam { width: 100%; height: 150px; border-right: none; border-bottom: 1px solid var(--border-subtle); }
      .mc-cam-none { display: none; }
      .mc-temps { flex-direction: row; border-left: none; border-top: 1px solid var(--border-subtle); min-width: 0; }
      .mc-temp + .mc-temp { border-top: none; border-left: 1px solid var(--border-subtle); }
      .mc-temp { flex: 1; }
      .mc-ams { border-left: none; border-top: 1px solid var(--border-subtle); }
    }
    @media (max-width: 520px) {
      .mon-header h1 { font-size: 1.1rem; }
      .mc-cam { height: 120px; }
      .mc-slot { width: 60px; }
      .mc-slot-mat { font-size: 0.58rem; }
      .mc-temp-val { font-size: 0.8rem; }
    }
  </style>

  <div class="mon-header">
    <h1>Drucker Monitoring</h1>
    <div class="mon-refresh-info">
      <div class="mon-pulse"></div>
      <span>Live · alle 3s</span>
    </div>
  </div>

  <div class="mon-list" id="mon-grid">
    <p style="color: var(--text-muted); font-size: 0.85rem; text-align: center; padding: 40px 0;">Laden...</p>
  </div>

  <script>
    const SC: Record<string, string> = {
      printing: '#10b981', idle: '#6b7280', paused: '#eab308',
      error: '#ef4444', preparing: '#38bdf8', offline: '#4b5563'
    }
    const SL: Record<string, string> = {
      printing: 'Druckt', idle: 'Bereit', paused: 'Pause',
      error: 'Fehler', preparing: 'Vorbereitung', offline: 'Offline'
    }

    function fmtMin(min: number | null | undefined): string {
      if (min == null || min <= 0) return '--'
      const h = Math.floor(min / 60); const m = min % 60
      return h > 0 ? `${h}h ${m.toString().padStart(2, '0')}m` : `${m}m`
    }
    function fmtSec(min: number | null | undefined): string {
      if (min == null || min <= 0) return '0m 0s'
      const h = Math.floor(min / 60); const m = min % 60
      return h > 0 ? `${h}h ${m.toString().padStart(2, '0')}m ${0}s` : `${m}m ${0}s`
    }
    function isActive(s: string): boolean {
      return s === 'printing' || s === 'paused' || s === 'preparing'
    }

    const SVG_NOZZLE = `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 14.76V3.5a2.5 2.5 0 00-5 0v11.26a4.5 4.5 0 105 0z"/></svg>`
    const SVG_BED = `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="6" width="20" height="12" rx="2"/></svg>`
    const SVG_FILE = `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>`
    const SVG_CLOCK = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" opacity="0.4"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>`

    function renderSlot(s: any): string {
      if (!s.present) {
        return `<div class="mc-slot">
          <div class="mc-slot-top"><span class="mc-slot-no">${s.slot_no}</span></div>
          <div class="mc-slot-empty">Leer</div>
        </div>`
      }
      const clr = s.color_hex || '#555'
      const pct = s.remain_percent
      const barColor = pct != null && pct < 20 ? '#ef4444' : (pct != null && pct < 50 ? '#eab308' : clr)
      return `<div class="mc-slot filled">
        <div class="mc-slot-top">
          <span class="mc-slot-no">${s.slot_no}</span>
          <span class="mc-slot-dot" style="background: ${clr}; border-color: ${clr};"></span>
        </div>
        <div class="mc-slot-mat">${s.material || '?'}</div>
        ${s.designation ? `<div class="mc-slot-name">${s.designation}</div>` : ''}
        ${pct != null ? `<div class="mc-slot-pct-wrap"><div class="mc-slot-pct-bar" style="width:${pct}%;background:${barColor};"></div></div><div class="mc-slot-pct-text">${pct}%</div>` : ''}
      </div>`
    }

    function renderAmsBlocks(p: any, standalone = false): string {
      const units = p.ams_units || []
      if (units.length === 0) return ''
      const cls = standalone ? 'mc-ams-standalone' : 'mc-ams'
      return units.map((u: any) => {
        const title = p.driver_key === 'klipper' ? 'Spulenhalter' : (u.name || 'AMS')
        const active = (u.slots || []).filter((s: any) => s.present).length
        const slotsHtml = (u.slots || []).map(renderSlot).join('')
        return `<div class="${cls}">
          <div class="mc-ams-head">
            <span class="mc-ams-title">${title}</span>
            <span class="mc-ams-sub">${active} Slots · Aktiv: ${active > 0 ? active : '–'}</span>
          </div>
          <div class="mc-slots">${slotsHtml}</div>
        </div>`
      }).join('')
    }

    function renderCard(p: any): string {
      const dotColor = SC[p.state] || '#6b7280'
      const label = SL[p.state] || p.state
      const badgeCls = p.state || 'offline'
      const active = isActive(p.state)

      const head = `<div class="mc-head">
        <span class="mc-dot" style="background:${dotColor};"></span>
        <span class="mc-name">${p.name}</span>
        ${p.model ? `<span class="mc-model">${p.model}</span>` : ''}
        <span class="mc-badge ${badgeCls}" data-f="badge">${label}</span>
      </div>`

      if (!active) {
        const ams = renderAmsBlocks(p, true)
        return `<div class="mc" data-mon-id="${p.id}">
          ${head}
          <div class="mc-idle">${SVG_CLOCK} Kein aktiver Druck</div>
          ${ams}
        </div>`
      }

      const pct = p.progress_pct ?? 0

      const camHtml = p.has_camera
        ? `<div class="mc-cam"><img data-cam="${p.id}" src="/api/v1/printers/${p.id}/camera?t=${Date.now()}" alt="" onerror="this.style.opacity='0.2'" /></div>`
        : `<div class="mc-cam-none"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/><circle cx="12" cy="13" r="4"/></svg></div>`

      const elapsed = p.elapsed_min != null ? fmtMin(p.elapsed_min) : '–'
      const total = p.remaining_min != null && p.elapsed_min != null ? fmtMin(p.elapsed_min + p.remaining_min) : (p.remaining_min != null ? fmtMin(p.remaining_min) : '–')

      const infoHtml = `<div class="mc-info">
        <div class="mc-job" data-f="job">${SVG_FILE} ${p.job_name || 'Unbekannt'}</div>
        <div class="mc-times">
          <div class="mc-time-box"><span class="mc-time-label">Laufzeit</span><span class="mc-time-val" data-f="elapsed">${elapsed}</span></div>
          <div class="mc-time-box"><span class="mc-time-label">Gesamt</span><span class="mc-time-val" data-f="total">${total}</span></div>
        </div>
        <div class="mc-progress"><div class="mc-progress-fill" data-f="bar" style="width:${pct}%;"></div></div>
      </div>`

      const tempsHtml = `<div class="mc-temps">
        ${p.nozzle_temp != null ? `<div class="mc-temp"><div class="mc-temp-head">${SVG_NOZZLE} Düse</div><div class="mc-temp-val" data-f="nozzle">${Math.round(p.nozzle_temp)}° <small>/ ${p.nozzle_target ? Math.round(p.nozzle_target) : '–'}°</small></div></div>` : ''}
        ${p.bed_temp != null ? `<div class="mc-temp"><div class="mc-temp-head">${SVG_BED} Bett</div><div class="mc-temp-val" data-f="bed">${Math.round(p.bed_temp)}° <small>/ ${p.bed_target ? Math.round(p.bed_target) : '–'}°</small></div></div>` : ''}
        ${p.layer != null && p.total_layers != null ? `<div class="mc-temp"><div class="mc-temp-head">Layer</div><div class="mc-temp-val" data-f="layer">${p.layer} <small>/ ${p.total_layers}</small></div></div>` : ''}
      </div>`

      const amsHtml = renderAmsBlocks(p)

      return `<div class="mc" data-mon-id="${p.id}">
        ${head}
        <div class="mc-body">
          ${camHtml}
          ${infoHtml}
          ${tempsHtml}
          ${amsHtml}
        </div>
      </div>`
    }

    let monLastIds = ''
    let monLastStates: Record<number, string> = {}

    function patchCard(card: HTMLElement, p: any) {
      const prev = monLastStates[p.id]
      if (prev !== p.state || (isActive(p.state) !== isActive(prev || ''))) {
        card.outerHTML = renderCard(p)
        monLastStates[p.id] = p.state
        return
      }
      monLastStates[p.id] = p.state
      if (!isActive(p.state)) return

      const q = (f: string) => card.querySelector(`[data-f="${f}"]`) as HTMLElement | null
      const pct = p.progress_pct ?? 0
      const jobEl = q('job'); if (jobEl) jobEl.innerHTML = `${SVG_FILE} ${p.job_name || 'Unbekannt'}`
      const barEl = q('bar'); if (barEl) barEl.style.width = `${pct}%`
      const elapsed = p.elapsed_min != null ? fmtMin(p.elapsed_min) : '–'
      const total = p.remaining_min != null && p.elapsed_min != null ? fmtMin(p.elapsed_min + p.remaining_min) : (p.remaining_min != null ? fmtMin(p.remaining_min) : '–')
      const elapsedEl = q('elapsed'); if (elapsedEl) elapsedEl.textContent = elapsed
      const totalEl = q('total'); if (totalEl) totalEl.textContent = total
      const nozzleEl = q('nozzle'); if (nozzleEl && p.nozzle_temp != null) nozzleEl.innerHTML = `${Math.round(p.nozzle_temp)}° <small>/ ${p.nozzle_target ? Math.round(p.nozzle_target) : '–'}°</small>`
      const bedEl = q('bed'); if (bedEl && p.bed_temp != null) bedEl.innerHTML = `${Math.round(p.bed_temp)}° <small>/ ${p.bed_target ? Math.round(p.bed_target) : '–'}°</small>`
      const layerEl = q('layer'); if (layerEl && p.layer != null) layerEl.innerHTML = `${p.layer} <small>/ ${p.total_layers}</small>`

      const camImg = card.querySelector(`img[data-cam="${p.id}"]`) as HTMLImageElement | null
      if (camImg) camImg.src = `/api/v1/printers/${p.id}/camera?t=${Date.now()}`
    }

    async function loadMonitoring() {
      try {
        const res = await fetch('/api/v1/printers/status', { credentials: 'include' })
        if (!res.ok) return
        const printers = await res.json() as any[]
        const grid = document.getElementById('mon-grid')
        if (!grid) return

        if (printers.length === 0) {
          grid.innerHTML = '<p style="color: var(--text-muted); font-size: 0.85rem; text-align: center; padding: 40px 0;">Keine Drucker konfiguriert</p>'
          return
        }

        const sorted = [...printers.filter(p => isActive(p.state)), ...printers.filter(p => !isActive(p.state))]
        const newIdKey = sorted.map(p => `${p.id}:${isActive(p.state)?1:0}`).join(',')

        if (newIdKey !== monLastIds) {
          grid.innerHTML = sorted.map(renderCard).join('')
          for (const p of sorted) monLastStates[p.id] = p.state
          monLastIds = newIdKey
        } else {
          for (const p of sorted) {
            const el = grid.querySelector(`[data-mon-id="${p.id}"]`) as HTMLElement | null
            if (el) patchCard(el, p)
          }
        }
      } catch (e) {
        console.debug('Monitoring fetch error:', e)
      }
    }

    loadMonitoring()
    setInterval(loadMonitoring, 3000)

    setInterval(() => {
      document.querySelectorAll<HTMLImageElement>('img[data-cam]').forEach(img => {
        const pid = img.getAttribute('data-cam')
        if (pid) img.src = `/api/v1/printers/${pid}/camera?t=${Date.now()}`
      })
    }, 1500)
  </script>
</Layout>
