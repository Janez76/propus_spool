---
import Layout from '../layouts/Layout.astro'
---

<Layout title="Propus Spool - Monitoring">
  <style>
    .mon-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 12px;
    }
    .mon-header h1 {
      font-size: 1.5rem;
      font-weight: 700;
      margin: 0;
    }
    .mon-refresh-info {
      font-size: 0.75rem;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .mon-pulse {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #10b981;
      animation: pulse-ring 2s ease-out infinite;
    }
    @keyframes pulse-ring {
      0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); }
      70% { box-shadow: 0 0 0 6px rgba(16, 185, 129, 0); }
      100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
    }
    .mon-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(420px, 1fr));
      gap: 16px;
    }
    @media (max-width: 520px) {
      .mon-grid { grid-template-columns: 1fr; }
      .mon-header h1 { font-size: 1.2rem; }
    }

    .mon-card {
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      overflow: hidden;
      transition: all 0.2s ease;
    }
    .mon-card:hover {
      border-color: var(--accent);
      box-shadow: var(--shadow-sm);
    }
    .mon-card-head {
      padding: 14px 16px;
      display: flex;
      align-items: center;
      gap: 10px;
      border-bottom: 1px solid var(--border-subtle);
    }
    .mon-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .mon-card-name {
      font-weight: 600;
      font-size: 0.95rem;
      flex: 1;
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .mon-card-model {
      font-size: 0.72rem;
      color: var(--text-muted);
    }
    .mon-badge {
      font-size: 0.7rem;
      font-weight: 600;
      padding: 3px 10px;
      border-radius: 12px;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }
    .mon-badge.printing { background: rgba(16, 185, 129, 0.15); color: #10b981; }
    .mon-badge.idle { background: rgba(107, 114, 128, 0.15); color: #6b7280; }
    .mon-badge.paused { background: rgba(251, 191, 36, 0.15); color: #eab308; }
    .mon-badge.error { background: rgba(239, 68, 68, 0.15); color: #ef4444; }
    .mon-badge.preparing { background: rgba(56, 189, 248, 0.15); color: #38bdf8; }
    .mon-badge.offline { background: rgba(107, 114, 128, 0.1); color: #4b5563; }

    .mon-card-body {
      padding: 16px;
    }
    .mon-camera-wrap {
      position: relative;
      margin-bottom: 14px;
      border-radius: var(--radius-sm);
      overflow: hidden;
      background: var(--bg);
      border: 1px solid var(--border-subtle);
    }
    .mon-camera {
      width: 100%;
      height: auto;
      max-height: 300px;
      object-fit: contain;
      display: block;
    }
    .mon-no-camera {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 120px;
      color: var(--text-muted);
      font-size: 0.82rem;
      gap: 8px;
    }
    .mon-job {
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 10px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .mon-progress-bar {
      height: 10px;
      background: var(--bg-soft);
      border-radius: 5px;
      overflow: hidden;
      margin-bottom: 4px;
    }
    .mon-progress-fill {
      height: 100%;
      border-radius: 5px;
      background: linear-gradient(90deg, #10b981, #34d399);
      transition: width 0.5s ease;
    }
    .mon-progress-text {
      display: flex;
      justify-content: space-between;
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-bottom: 14px;
    }
    .mon-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 10px;
    }
    .mon-stat {
      background: var(--bg-soft);
      border-radius: var(--radius-sm);
      padding: 10px;
      text-align: center;
    }
    .mon-stat-label {
      font-size: 0.65rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.04em;
      margin-bottom: 4px;
    }
    .mon-stat-val {
      font-size: 1rem;
      font-weight: 700;
      font-family: var(--font-mono);
    }
    .mon-stat-sub {
      font-size: 0.65rem;
      color: var(--text-muted);
      margin-top: 1px;
    }

    .mon-idle-body {
      padding: 20px 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      font-size: 0.85rem;
      gap: 8px;
    }

    .mon-ams {
      margin-top: 14px;
      border-top: 1px solid var(--border-subtle);
      padding-top: 12px;
    }
    .mon-ams-title {
      font-size: 0.7rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.04em;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .mon-ams-title span {
      font-size: 0.65rem;
      opacity: 0.7;
    }
    .mon-slots {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
      gap: 6px;
    }
    .mon-slot {
      background: var(--bg);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-sm);
      padding: 8px 6px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    .mon-slot.filled { border-color: var(--border); }
    .mon-slot-color {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
    }
    .mon-slot-no {
      font-size: 0.6rem;
      color: var(--text-muted);
      margin-bottom: 2px;
    }
    .mon-slot-material {
      font-size: 0.72rem;
      font-weight: 600;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .mon-slot-name {
      font-size: 0.6rem;
      color: var(--text-muted);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      margin-top: 1px;
    }
    .mon-slot-pct {
      font-size: 0.62rem;
      font-family: var(--font-mono);
      margin-top: 2px;
    }
    .mon-slot-empty {
      font-size: 0.68rem;
      color: var(--text-muted);
      opacity: 0.5;
    }
    .mon-slot-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
      border: 1px solid var(--border);
      margin-bottom: 2px;
    }
  </style>

  <div class="mon-header">
    <h1>Drucker Monitoring</h1>
    <div class="mon-refresh-info">
      <div class="mon-pulse"></div>
      <span>Live · alle 3s</span>
    </div>
  </div>

  <div class="mon-grid" id="mon-grid">
    <p style="color: var(--text-muted); font-size: 0.85rem; grid-column: 1/-1; text-align: center; padding: 40px 0;">Laden...</p>
  </div>

  <script>
    const STATE_COLORS: Record<string, string> = {
      printing: '#10b981', idle: '#6b7280', paused: '#eab308',
      error: '#ef4444', preparing: '#38bdf8', offline: '#4b5563'
    }
    const STATE_LABELS: Record<string, string> = {
      printing: 'Druckt', idle: 'Bereit', paused: 'Pause',
      error: 'Fehler', preparing: 'Vorbereitung', offline: 'Offline'
    }

    function fmtMin(min: number | null | undefined): string {
      if (min == null || min <= 0) return '--'
      const h = Math.floor(min / 60)
      const m = min % 60
      return h > 0 ? `${h}h ${m}m` : `${m}m`
    }

    function monIsActive(state: string): boolean {
      return state === 'printing' || state === 'paused' || state === 'preparing'
    }

    let monLastIds = ''
    let monLastStates: Record<number, string> = {}

    function monBuildCard(p: any): HTMLDivElement {
      const card = document.createElement('div')
      card.className = 'mon-card'
      card.setAttribute('data-mon-id', String(p.id))
      monRenderCard(card, p)
      return card
    }

    function renderAmsHtml(p: any): string {
      const units = p.ams_units || []
      if (units.length === 0) return ''
      return units.map((u: any) => {
        const title = p.driver_key === 'klipper' ? 'Spulenhalter' : (u.name || `AMS #${u.unit_no}`)
        const activeCount = (u.slots || []).filter((s: any) => s.present).length
        const slotsHtml = (u.slots || []).map((s: any) => {
          if (!s.present) {
            return `<div class="mon-slot"><div class="mon-slot-no">${s.slot_no}</div><div class="mon-slot-empty">Leer</div></div>`
          }
          const colorBar = s.color_hex ? `<div class="mon-slot-color" style="background: ${s.color_hex};"></div>` : ''
          const dotStyle = s.color_hex ? `background: ${s.color_hex};` : ''
          return `<div class="mon-slot filled">
            ${colorBar}
            <div class="mon-slot-no">${s.slot_no}</div>
            <div class="mon-slot-dot" style="${dotStyle}"></div>
            <div class="mon-slot-material">${s.material || '?'}</div>
            ${s.designation ? `<div class="mon-slot-name">${s.designation}</div>` : ''}
            ${s.remain_percent != null ? `<div class="mon-slot-pct">${s.remain_percent}%</div>` : ''}
          </div>`
        }).join('')
        return `<div class="mon-ams"><div class="mon-ams-title">${title} <span>${activeCount}/${u.slots_total} belegt</span></div><div class="mon-slots">${slotsHtml}</div></div>`
      }).join('')
    }

    function monRenderCard(card: HTMLElement, p: any) {
      const dotColor = STATE_COLORS[p.state] || '#6b7280'
      const label = STATE_LABELS[p.state] || p.state
      const badgeCls = p.state || 'offline'
      const active = monIsActive(p.state)
      const amsHtml = renderAmsHtml(p)

      let bodyHtml: string
      if (!active) {
        bodyHtml = `<div class="mon-idle-body" style="flex-direction: column; gap: 4px;"><div style="display: flex; align-items: center; gap: 8px;"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" opacity="0.4"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>Kein aktiver Druck</div></div>${amsHtml ? `<div style="padding: 0 16px 16px;">${amsHtml}</div>` : ''}`
      } else {
        const pct = p.progress_pct ?? 0
        const camHtml = p.has_camera
          ? `<div class="mon-camera-wrap"><img class="mon-camera" data-cam="${p.id}" src="/api/v1/printers/${p.id}/camera?t=${Date.now()}" alt="Kamera" onerror="this.style.display='none'" /></div>`
          : ''

        bodyHtml = `
          <div class="mon-card-body">
            ${camHtml}
            <div class="mon-job" data-f="job">${p.job_name || 'Unbekannter Druckjob'}</div>
            <div class="mon-progress-bar"><div class="mon-progress-fill" data-f="bar" style="width: ${pct}%;"></div></div>
            <div class="mon-progress-text">
              <span data-f="pct">${pct}% abgeschlossen</span>
              <span data-f="time">${p.remaining_min != null ? fmtMin(p.remaining_min) + ' verbleibend' : ''}</span>
            </div>
            <div class="mon-stats">
              ${p.nozzle_temp != null ? `<div class="mon-stat"><div class="mon-stat-label">Düse</div><div class="mon-stat-val" data-f="nozzle">${p.nozzle_temp}°C</div>${p.nozzle_target ? `<div class="mon-stat-sub" data-f="nozzle-t">Ziel: ${p.nozzle_target}°C</div>` : ''}</div>` : ''}
              ${p.bed_temp != null ? `<div class="mon-stat"><div class="mon-stat-label">Bett</div><div class="mon-stat-val" data-f="bed">${p.bed_temp}°C</div>${p.bed_target ? `<div class="mon-stat-sub" data-f="bed-t">Ziel: ${p.bed_target}°C</div>` : ''}</div>` : ''}
              ${p.remaining_min != null ? `<div class="mon-stat"><div class="mon-stat-label">Restzeit</div><div class="mon-stat-val" data-f="remain">${fmtMin(p.remaining_min)}</div></div>` : (p.elapsed_min != null ? `<div class="mon-stat"><div class="mon-stat-label">Vergangen</div><div class="mon-stat-val" data-f="elapsed">${fmtMin(p.elapsed_min)}</div></div>` : '')}
              ${(p.layer != null && p.total_layers != null) ? `<div class="mon-stat"><div class="mon-stat-label">Layer</div><div class="mon-stat-val" data-f="layer">${p.layer}/${p.total_layers}</div></div>` : ''}
            </div>
            ${amsHtml}
          </div>`
      }

      card.innerHTML = `
        <div class="mon-card-head">
          <span class="mon-dot" style="background: ${dotColor};"></span>
          <span class="mon-card-name">${p.name}</span>
          ${p.model ? `<span class="mon-card-model">${p.model}</span>` : ''}
          <span class="mon-badge ${badgeCls}" data-f="badge">${label}</span>
        </div>
        ${bodyHtml}`
    }

    function monPatchCard(card: HTMLElement, p: any) {
      const prev = monLastStates[p.id]
      if (prev !== p.state || (monIsActive(p.state) !== monIsActive(prev || ''))) {
        monRenderCard(card, p)
        monLastStates[p.id] = p.state
        return
      }
      monLastStates[p.id] = p.state
      if (!monIsActive(p.state)) return

      const q = (f: string) => card.querySelector(`[data-f="${f}"]`) as HTMLElement | null
      const pct = p.progress_pct ?? 0

      const jobEl = q('job'); if (jobEl) jobEl.textContent = p.job_name || 'Unbekannter Druckjob'
      const barEl = q('bar'); if (barEl) barEl.style.width = `${pct}%`
      const pctEl = q('pct'); if (pctEl) pctEl.textContent = `${pct}% abgeschlossen`
      const timeEl = q('time'); if (timeEl) timeEl.textContent = p.remaining_min != null ? fmtMin(p.remaining_min) + ' verbleibend' : ''
      const nozzleEl = q('nozzle'); if (nozzleEl && p.nozzle_temp != null) nozzleEl.textContent = `${p.nozzle_temp}°C`
      const nozzleTEl = q('nozzle-t'); if (nozzleTEl && p.nozzle_target != null) nozzleTEl.textContent = `Ziel: ${p.nozzle_target}°C`
      const bedEl = q('bed'); if (bedEl && p.bed_temp != null) bedEl.textContent = `${p.bed_temp}°C`
      const bedTEl = q('bed-t'); if (bedTEl && p.bed_target != null) bedTEl.textContent = `Ziel: ${p.bed_target}°C`
      const remainEl = q('remain'); if (remainEl) remainEl.textContent = fmtMin(p.remaining_min)
      const elapsedEl = q('elapsed'); if (elapsedEl) elapsedEl.textContent = fmtMin(p.elapsed_min)
      const layerEl = q('layer'); if (layerEl && p.layer != null) layerEl.textContent = `${p.layer}/${p.total_layers}`

      const camImg = card.querySelector(`img[data-cam="${p.id}"]`) as HTMLImageElement | null
      if (camImg) camImg.src = `/api/v1/printers/${p.id}/camera?t=${Date.now()}`
    }

    async function loadMonitoring() {
      try {
        const res = await fetch('/api/v1/printers/status', { credentials: 'include' })
        if (!res.ok) return
        const printers = await res.json() as any[]
        const grid = document.getElementById('mon-grid')
        if (!grid) return

        if (printers.length === 0) {
          if (!grid.querySelector('p')) {
            grid.innerHTML = '<p style="color: var(--text-muted); font-size: 0.85rem; grid-column: 1/-1; text-align: center; padding: 40px 0;">Keine Drucker konfiguriert</p>'
          }
          return
        }

        const sorted = [...printers.filter(p => monIsActive(p.state)), ...printers.filter(p => !monIsActive(p.state))]
        const newIdKey = sorted.map(p => `${p.id}:${monIsActive(p.state)?1:0}`).join(',')

        if (newIdKey !== monLastIds) {
          grid.innerHTML = ''
          for (const p of sorted) {
            grid.appendChild(monBuildCard(p))
            monLastStates[p.id] = p.state
          }
          monLastIds = newIdKey
        } else {
          for (const p of sorted) {
            const existing = grid.querySelector(`[data-mon-id="${p.id}"]`) as HTMLElement | null
            if (existing) monPatchCard(existing, p)
          }
        }
      } catch (e) {
        console.debug('Monitoring fetch error:', e)
      }
    }

    loadMonitoring()
    setInterval(loadMonitoring, 3000)

    setInterval(() => {
      document.querySelectorAll<HTMLImageElement>('img[data-cam]').forEach(img => {
        const pid = img.getAttribute('data-cam')
        if (pid) img.src = `/api/v1/printers/${pid}/camera?t=${Date.now()}`
      })
    }, 1500)
  </script>
</Layout>
