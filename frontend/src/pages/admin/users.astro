---
import Layout from '../../layouts/Layout.astro'
---

<Layout title="FilaMan - Admin Users">
  <div style="margin-bottom: 24px;">
    <a href="/admin" style="color: var(--accent); text-decoration: none;">&larr; <span data-i18n="admin.backToAdmin">Back to Admin</span></a>
  </div>
  
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
    <h1 style="font-size: 1.8rem; font-weight: 700; margin: 0; font-family: var(--font-serif);" data-i18n="admin.users">Users</h1>
    <button
      id="btn-new"
      class="fm-btn fm-btn-primary"
      data-i18n="admin.addUser"
    >
      Add User
    </button>
  </div>
  
  <div class="fm-card" style="padding: 0; overflow: hidden;">
    <table class="fm-table">
      <thead style="background: var(--bg-soft);">
        <tr>
          <th data-i18n="admin.email">Email</th>
          <th data-i18n="admin.displayName">Display Name</th>
          <th data-i18n="common.status">Status</th>
          <th data-i18n="admin.roles">Roles</th>
          <th style="text-align: right;" data-i18n="common.actions">Actions</th>
        </tr>
      </thead>
      <tbody id="users-table">
        <tr>
          <td colspan="5" style="text-align: center; color: var(--text-muted);" data-i18n="common.loading">Loading...</td>
        </tr>
      </tbody>
    </table>
  </div>
  
  <div id="modal-container" class="fm-modal-overlay hidden">
    <div class="fm-card" style="width: 100%; max-width: 28rem; margin: 0 1rem; padding: 24px; max-height: 90vh; overflow-y: auto;">
      <h3 id="modal-title" style="font-size: 1.15rem; font-weight: 600; margin-bottom: 16px;" data-i18n="admin.addUser">Add User</h3>
      <form id="modal-form" style="display: flex; flex-direction: column; gap: 16px;">
        <input type="hidden" id="user-id" />
        <div>
          <label for="user-email" class="fm-label"><span data-i18n="admin.email">Email</span> *</label>
          <input type="email" id="user-email" required class="fm-input" />
        </div>
        <div id="password-field">
          <label for="user-password" class="fm-label" data-i18n="admin.password">Password *</label>
          <input type="password" id="user-password" class="fm-input" />
        </div>
        <div>
          <label for="user-display-name" class="fm-label" data-i18n="admin.displayName">Display Name</label>
          <input type="text" id="user-display-name" class="fm-input" />
        </div>
        <div>
          <label class="fm-label" data-i18n="admin.roles">Roles</label>
          <div id="roles-checkboxes" style="display: flex; flex-direction: column; gap: 8px;"></div>
        </div>
        <div>
          <label style="display: flex; align-items: center; gap: 8px;">
            <input type="checkbox" id="user-superadmin" />
            <span style="font-size: 0.875rem; color: var(--text);" data-i18n="admin.superadmin">Superadmin</span>
          </label>
        </div>
        <div id="modal-error" class="fm-alert-error hidden"></div>
        <div style="display: flex; gap: 12px;">
          <button type="submit" id="modal-submit" class="fm-btn fm-btn-primary" data-i18n="common.save">Save</button>
          <button type="button" id="modal-cancel" class="fm-btn fm-btn-outline" data-i18n="common.cancel">Cancel</button>
        </div>
      </form>
    </div>
  </div>
  
  <script>
    import { t, initI18n } from '../../lib/i18n'
    await initI18n()

    let users: any[] = []
    let roles: any[] = []
    
    function getCsrfToken(): string {
      const match = document.cookie.match(/(?:^|;\s*)csrf_token=([^;]*)/)
      return match ? decodeURIComponent(match[1]) : ''
    }
    
    async function loadData() {
      try {
        const [usersRes, rolesRes] = await Promise.all([
          fetch('/api/v1/admin/users', { credentials: 'include' }),
          fetch('/api/v1/admin/roles', { credentials: 'include' }),
        ])
        
        if (!usersRes.ok) throw new Error('Failed to fetch users')
        
        users = await usersRes.json().then(d => d.items)
        roles = await rolesRes.json()
        renderUsers()
        renderRoleCheckboxes()
      } catch (error) {
        console.error('Failed to load data:', error)
      }
    }
    
    function renderUsers() {
      const tbody = document.getElementById('users-table')!
      
      if (users.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" style="text-align: center; color: var(--text-muted);">${t('admin.noUsers')}</td></tr>`
        return
      }
      
      tbody.innerHTML = users.map(u => `
        <tr>
          <td>${u.email}</td>
          <td style="color: var(--text-muted);">${u.display_name || '-'}</td>
          <td>
            <span style="padding: 2px 8px; font-size: 0.75rem; border-radius: 999px; background: var(--bg-soft); color: ${u.is_active ? 'var(--accent-2)' : 'var(--error-text)'};">
              ${u.is_active ? t('common.active') : t('common.inactive')}
            </span>
            ${u.is_superadmin ? `<span style="margin-left: 4px; padding: 2px 8px; font-size: 0.75rem; border-radius: 999px; background: var(--bg-soft); color: var(--accent);">${t('admin.superadmin')}</span>` : ''}
          </td>
          <td style="color: var(--text-muted);">-</td>
          <td style="text-align: right;">
            <button data-id="${u.id}" class="btn-edit" style="color: var(--accent); background: none; border: none; cursor: pointer; margin-right: 12px;">${t('common.edit')}</button>
            <button data-id="${u.id}" class="btn-reset" style="color: var(--accent); background: none; border: none; cursor: pointer; margin-right: 12px;">${t('admin.resetPw')}</button>
          </td>
        </tr>
      `).join('')
      
      document.querySelectorAll('.btn-edit').forEach(btn => {
        btn.addEventListener('click', (e) => openModal(parseInt((e.currentTarget as HTMLButtonElement).dataset.id!)))
      })
      
      document.querySelectorAll('.btn-reset').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const id = parseInt((e.currentTarget as HTMLButtonElement).dataset.id!)
          const newPassword = prompt(t('admin.resetPwPrompt'))
          if (!newPassword || newPassword.length < 8) {
            if (newPassword !== null) await (window as any).__fmAlert(t('admin.resetPwTooShort'))
            return
          }
          
          try {
            const response = await fetch(`/api/v1/admin/users/${id}/reset-password?new_password=${encodeURIComponent(newPassword)}`, {
              method: 'POST',
              headers: { 'X-CSRF-Token': getCsrfToken() },
              credentials: 'include',
            })
            
            if (!response.ok) throw new Error('Failed to reset password')
            await (window as any).__fmAlert(t('admin.resetPwSuccess'))
          } catch {
            await (window as any).__fmAlert(t('admin.resetPwFailed'))
          }
        })
      })
    }
    
    function renderRoleCheckboxes(selectedRoles: string[] = []) {
      const container = document.getElementById('roles-checkboxes')!
      container.innerHTML = roles.map(r => `
        <label style="display: flex; align-items: center; gap: 8px;">
          <input type="checkbox" value="${r.key}" class="role-checkbox" ${selectedRoles.includes(r.key) ? 'checked' : ''} />
          <span style="font-size: 0.875rem; color: var(--text);">${r.name}</span>
        </label>
      `).join('')
    }
    
    async function openModal(id: number | null = null) {
      const container = document.getElementById('modal-container')!
      const title = document.getElementById('modal-title')!
      const idInput = document.getElementById('user-id') as HTMLInputElement
      const emailInput = document.getElementById('user-email') as HTMLInputElement
      const passwordInput = document.getElementById('user-password') as HTMLInputElement
      const passwordField = document.getElementById('password-field')!
      const displayNameInput = document.getElementById('user-display-name') as HTMLInputElement
      const superadminInput = document.getElementById('user-superadmin') as HTMLInputElement
      const error = document.getElementById('modal-error')!
      
      error.classList.add('hidden')
      
      if (id) {
        title.textContent = t('admin.editUser')
        passwordField.classList.add('hidden')
        passwordInput.required = false
        
        const response = await fetch(`/api/v1/admin/users/${id}`, { credentials: 'include' })
        const user = await response.json()
        
        idInput.value = String(id)
        emailInput.value = user.email
        displayNameInput.value = user.display_name || ''
        superadminInput.checked = user.is_superadmin
        renderRoleCheckboxes(user.roles || [])
      } else {
        title.textContent = t('admin.addUser')
        passwordField.classList.remove('hidden')
        passwordInput.required = true
        
        idInput.value = ''
        emailInput.value = ''
        passwordInput.value = ''
        displayNameInput.value = ''
        superadminInput.checked = false
        renderRoleCheckboxes()
      }
      
      container.classList.remove('hidden')
    }
    
    function closeModal() {
      document.getElementById('modal-container')!.classList.add('hidden')
    }
    
    document.getElementById('btn-new')?.addEventListener('click', () => openModal())
    document.getElementById('modal-cancel')?.addEventListener('click', closeModal)
    
    document.getElementById('modal-form')?.addEventListener('submit', async (e) => {
      e.preventDefault()
      
      const id = (document.getElementById('user-id') as HTMLInputElement).value
      const email = (document.getElementById('user-email') as HTMLInputElement).value
      const password = (document.getElementById('user-password') as HTMLInputElement).value
      const displayName = (document.getElementById('user-display-name') as HTMLInputElement).value || null
      const isSuperadmin = (document.getElementById('user-superadmin') as HTMLInputElement).checked
      const selectedRoles = Array.from(document.querySelectorAll('.role-checkbox:checked')).map((cb: any) => cb.value)
      
      const error = document.getElementById('modal-error') as HTMLDivElement
      const submitBtn = document.getElementById('modal-submit') as HTMLButtonElement
      
      error.classList.add('hidden')
      submitBtn.disabled = true
      submitBtn.textContent = t('common.saving')
      
      try {
        if (id) {
await fetch(`/api/v1/admin/users/${id}`, {
              method: 'DELETE',
              headers: { 'X-CSRF-Token': getCsrfToken() },
              credentials: 'include',
            })
          
          await fetch(`/api/v1/admin/users/${id}/roles`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': getCsrfToken() },
            credentials: 'include',
            body: JSON.stringify(selectedRoles),
          })
        } else {
          const response = await fetch('/api/v1/admin/users', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': getCsrfToken() },
            credentials: 'include',
            body: JSON.stringify({ email, password, display_name: displayName, is_superadmin: isSuperadmin }),
          })
          
          if (!response.ok) {
            const data = await response.json()
            throw new Error(data.message || t('admin.failedCreateUser'))
          }
          
          const user = await response.json()
          await fetch(`/api/v1/admin/users/${user.id}/roles`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': getCsrfToken() },
            credentials: 'include',
            body: JSON.stringify(selectedRoles),
          })
        }
        
        closeModal()
        loadData()
      } catch (err: any) {
        error.textContent = err.message
        error.classList.remove('hidden')
      } finally {
        submitBtn.disabled = false
        submitBtn.textContent = t('common.save')
      }
    })
    
    loadData()
  </script>
</Layout>
