---
import Layout from '../../layouts/Layout.astro'
---

<Layout title="FilaMan - New Filament">
  <div style="margin-bottom: 24px;">
    <a href="/filaments" style="color: var(--accent); text-decoration: none;">&larr; <span data-i18n="filaments.backToFilaments">Back to Filaments</span></a>
  </div>
  
  <h1 style="font-size: 1.8rem; font-weight: 700; margin-bottom: 24px; font-family: var(--font-serif);" data-i18n="filaments.newFilament">New Filament</h1>
  
  <div class="fm-card" style="max-width: 720px; padding: 24px;">
    <form id="filament-form" style="display: grid; gap: 16px;">
      
      <!-- Manufacturer -->
      <div>
        <label for="manufacturer_id" class="fm-label" data-i18n="filaments.manufacturer">Manufacturer *</label>
        <select 
          id="manufacturer_id" 
          name="manufacturer_id" 
          required
          class="fm-select"
        >
          <option value="" data-i18n="filaments.selectManufacturer">Select manufacturer...</option>
        </select>
      </div>
      
      <!-- Designation -->
      <div>
        <label for="designation" class="fm-label" data-i18n="filaments.designation">Designation *</label>
        <input
          type="text"
          id="designation"
          name="designation"
          required
          placeholder="e.g. PLA Basic Red"
          data-i18n-placeholder="filaments.designationPlaceholder"
          class="fm-input"
        />
      </div>
      
      <!-- Type + Diameter row -->
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
        <div>
          <label for="type" class="fm-label" data-i18n="filaments.type">Type *</label>
          <select 
            id="type" 
            name="type" 
            required
            class="fm-select"
          >
            <option value="" data-i18n="filaments.selectType">Select type...</option>
          </select>
          <div id="custom-type-wrapper" class="hidden" style="margin-top: 8px;">
            <label for="custom_type" class="fm-label" data-i18n="filaments.customTypeLabel">Custom Type *</label>
            <input
              type="text"
              id="custom_type"
              name="custom_type"
              placeholder="e.g. HIPS"
              data-i18n-placeholder="filaments.customTypePlaceholder"
              class="fm-input"
              maxlength="50"
              style="text-transform: uppercase;"
            />
          </div>
        </div>
        
        <div>
          <label for="diameter_mm" class="fm-label" data-i18n="filaments.diameterMm">Diameter (mm) *</label>
          <input
            type="number"
            id="diameter_mm"
            name="diameter_mm"
            step="0.01"
            value="1.75"
            required
            class="fm-input"
          />
        </div>
      </div>
      
      <!-- Material Subgroup + Finish Type row -->
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
        <div>
          <label for="material_subgroup" class="fm-label" data-i18n="filaments.materialSubgroup">Material Subgroup</label>
          <input
            type="text"
            id="material_subgroup"
            name="material_subgroup"
            placeholder="e.g. Silk, Matte, CF, PLA+"
            data-i18n-placeholder="filaments.materialSubgroupPlaceholder"
            class="fm-input"
          />
        </div>
        
        <div>
          <label for="finish_type" class="fm-label" data-i18n="filaments.finishType">Finish Type</label>
          <select 
            id="finish_type" 
            name="finish_type"
            class="fm-select"
          >
            <option value="">-</option>
            <option value="solid" data-i18n="filaments.finishSolid">Solid</option>
            <option value="translucent" data-i18n="filaments.finishTranslucent">Translucent</option>
            <option value="neon" data-i18n="filaments.finishNeon">Neon</option>
            <option value="glow" data-i18n="filaments.finishGlow">Glow in the Dark</option>
          </select>
        </div>
      </div>
      
      <!-- Color Mode -->
      <div>
        <label class="fm-label" data-i18n="filaments.colorMode">Color Mode *</label>
        <div style="display: flex; gap: 16px; margin-top: 4px;">
          <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; color: var(--text);">
            <input type="radio" name="color_mode" value="single" checked style="accent-color: var(--accent);" />
            <span data-i18n="filaments.colorModeSingle">Single Color</span>
          </label>
          <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; color: var(--text);">
            <input type="radio" name="color_mode" value="multi" style="accent-color: var(--accent);" />
            <span data-i18n="filaments.colorModeMulti">Multi Color</span>
          </label>
        </div>
      </div>
      
      <!-- Multi Color Style (only visible when multi selected) -->
      <div id="multi-color-options" class="hidden">
        <label for="multi_color_style" class="fm-label" data-i18n="filaments.multiColorStyle">Multi Color Style *</label>
        <select
          id="multi_color_style"
          name="multi_color_style"
          class="fm-select"
        >
          <option value="striped" data-i18n="filaments.styleStriped">Striped</option>
          <option value="gradient" data-i18n="filaments.styleGradient">Gradient</option>
        </select>
      </div>
      
      <!-- Color Selection -->
      <div>
        <label class="fm-label" data-i18n="filaments.colors">Colors *</label>
        <p style="font-size: 0.8rem; color: var(--text-muted); margin: 0 0 4px;" id="color-hint" data-i18n="filaments.colorHintSingle">Select the filament color.</p>
        <div id="selected-colors" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 8px;"></div>
        <div id="color-grid" class="fm-color-grid" style="max-height: 160px; overflow-y: auto; padding: 8px; background: var(--bg-soft); border: 1px solid var(--border); border-radius: var(--radius-sm);">
          <p style="color: var(--text-muted); font-size: 0.85rem;" data-i18n="common.loading">Loading...</p>
        </div>
        <!-- Inline new color form -->
        <div id="new-color-toggle" style="margin-top: 8px;">
          <button type="button" id="btn-add-new-color" class="fm-btn fm-btn-outline" style="font-size: 0.8rem; padding: 6px 14px;">
            + <span data-i18n="filaments.addNewColor">Add New Color</span>
          </button>
        </div>
        <div id="new-color-form" class="fm-inline-color-form hidden">
          <div>
            <label class="fm-label" data-i18n="filaments.colorPickerLabel">Color</label>
            <input type="color" id="new-color-hex" value="#FF0000" style="width: 44px; height: 36px; padding: 2px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-soft); cursor: pointer;" />
          </div>
          <div>
            <label class="fm-label" data-i18n="filaments.colorNameLabel">Name *</label>
            <input type="text" id="new-color-name" placeholder="e.g. Red" data-i18n-placeholder="filaments.colorNamePlaceholder" class="fm-input" />
          </div>
          <div style="display: flex; gap: 6px;">
            <button type="button" id="btn-save-new-color" class="fm-btn fm-btn-primary" style="font-size: 0.8rem; padding: 8px 14px;" data-i18n="common.save">Save</button>
            <button type="button" id="btn-cancel-new-color" class="fm-btn fm-btn-outline" style="font-size: 0.8rem; padding: 8px 14px;" data-i18n="common.cancel">Cancel</button>
          </div>
        </div>
      </div>
      
      <!-- Manufacturer Color Name -->
      <div>
        <label for="manufacturer_color_name" class="fm-label" data-i18n="filaments.manufacturerColorName">Manufacturer Color Name</label>
        <input
          type="text"
          id="manufacturer_color_name"
          name="manufacturer_color_name"
          placeholder="e.g. Fire Engine Red"
          data-i18n-placeholder="filaments.colorNamePlaceholder"
          class="fm-input"
        />
      </div>
      
      <!-- Weights row -->
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
        <div>
          <label for="raw_material_weight_g" class="fm-label" data-i18n="filaments.rawMaterialWeight">Raw Material Weight (g)</label>
          <input
            type="number"
            id="raw_material_weight_g"
            name="raw_material_weight_g"
            step="1"
            placeholder="e.g. 1000"
            data-i18n-placeholder="filaments.rawMaterialPlaceholder"
            class="fm-input"
          />
        </div>
        
        <div>
          <label for="default_spool_weight_g" class="fm-label" data-i18n="filaments.defaultSpoolWeight">Default Spool Weight (g)</label>
          <input
            type="number"
            id="default_spool_weight_g"
            name="default_spool_weight_g"
            step="1"
            placeholder="e.g. 250"
            data-i18n-placeholder="filaments.defaultSpoolWeightPlaceholder"
            class="fm-input"
          />
        </div>
      </div>
      
      <!-- Price + Density row -->
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
        <div>
          <label for="price" class="fm-label" data-i18n="filaments.price">Price</label>
          <input
            type="number"
            id="price"
            name="price"
            step="0.01"
            placeholder="e.g. 24.99"
            data-i18n-placeholder="filaments.pricePlaceholder"
            class="fm-input"
          />
        </div>
        
        <div>
          <label for="density_g_cm3" class="fm-label" data-i18n="filaments.density">Density (g/cm³)</label>
          <input
            type="number"
            id="density_g_cm3"
            name="density_g_cm3"
            step="0.01"
            placeholder="e.g. 1.24"
            data-i18n-placeholder="filaments.densityPlaceholder"
            class="fm-input"
          />
        </div>
      </div>
      
      <!-- Shop URL -->
      <div>
        <label for="shop_url" class="fm-label" data-i18n="filaments.shopUrl">Shop URL</label>
        <input
          type="url"
          id="shop_url"
          name="shop_url"
          placeholder="e.g. https://shop.example.com/filament"
          data-i18n-placeholder="filaments.shopUrlPlaceholder"
          class="fm-input"
        />
      </div>

      <!-- Custom Fields -->
      <div style="border-top: 1px solid var(--border); margin-top: 16px; padding-top: 16px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
          <label class="fm-label" style="margin: 0;">Extra Fields (JSON)</label>
          <button type="button" id="btn-add-field" class="fm-btn fm-btn-outline" style="font-size: 0.8rem; padding: 4px 10px;">
            + Add Field
          </button>
        </div>
        <div id="custom-fields-container" style="display: grid; gap: 8px;">
          <!-- Dynamic fields go here -->
        </div>
      </div>
      
      <div id="error-message" class="fm-alert-error hidden"></div>
      
      <div style="display: flex; gap: 12px; padding-top: 8px;">
        <button
          type="submit"
          id="submit-btn"
          class="fm-btn fm-btn-primary"
          data-i18n="filaments.createFilament"
        >
          Create Filament
        </button>
        <a
          href="/filaments"
          class="fm-btn fm-btn-outline"
          data-i18n="common.cancel"
        >
          Cancel
        </a>
      </div>
    </form>
  </div>
  
  <script>
    import { t, initI18n } from '../../lib/i18n'
    await initI18n()

    const CUSTOM_TYPE_VALUE = '__custom__'

    // ── State ──
    let allColors: Array<{ id: number; name: string; hex_code: string }> = []
    let selectedColorIds: number[] = []  // ordered by position

    // ── DOM refs ──
    const form = document.getElementById('filament-form') as HTMLFormElement
    const errorMessage = document.getElementById('error-message') as HTMLDivElement
    const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement
    const typeSelect = document.getElementById('type') as HTMLSelectElement
    const customTypeWrapper = document.getElementById('custom-type-wrapper') as HTMLDivElement
    const customTypeInput = document.getElementById('custom_type') as HTMLInputElement
    const colorGrid = document.getElementById('color-grid') as HTMLDivElement
    const selectedColorsContainer = document.getElementById('selected-colors') as HTMLDivElement
    const colorHint = document.getElementById('color-hint') as HTMLParagraphElement
    const multiColorOptions = document.getElementById('multi-color-options') as HTMLDivElement
    const newColorForm = document.getElementById('new-color-form') as HTMLDivElement
    const btnAddNewColor = document.getElementById('btn-add-new-color') as HTMLButtonElement
    const btnSaveNewColor = document.getElementById('btn-save-new-color') as HTMLButtonElement
    const btnCancelNewColor = document.getElementById('btn-cancel-new-color') as HTMLButtonElement
    const newColorHex = document.getElementById('new-color-hex') as HTMLInputElement
    const newColorName = document.getElementById('new-color-name') as HTMLInputElement

    // Custom Fields
    const customFieldsContainer = document.getElementById('custom-fields-container') as HTMLDivElement
    const btnAddField = document.getElementById('btn-add-field') as HTMLButtonElement

    // ── Custom Fields Logic ──
    let customFields: Array<{ key: string, value: string }> = []

    function unflattenObject(data: Record<string, any>) {
      const result: any = {}
      for (const key in data) {
        if (Object.prototype.hasOwnProperty.call(data, key)) {
          const keys = key.split('.')
          let current = result
          for (let i = 0; i < keys.length; i++) {
            const k = keys[i]
            if (i === keys.length - 1) {
              const val = data[key]
              const num = Number(val)
              current[k] = !isNaN(num) && val.trim() !== '' ? num : val
            } else {
              current[k] = current[k] || {}
              current = current[k]
            }
          }
        }
      }
      return result
    }

    function renderCustomFields() {
      customFieldsContainer.innerHTML = ''
      customFields.forEach((field, index) => {
        const row = document.createElement('div')
        row.style.display = 'grid'
        row.style.gridTemplateColumns = '1fr 1fr auto'
        row.style.gap = '8px'
        row.style.alignItems = 'center'
        
        row.innerHTML = `
          <input type="text" placeholder="Key" class="fm-input custom-field-key" data-index="${index}" value="${field.key}" />
          <input type="text" placeholder="Value" class="fm-input custom-field-value" data-index="${index}" value="${field.value}" />
          <button type="button" class="fm-btn fm-btn-danger custom-field-remove" data-index="${index}" style="padding: 6px 10px;">&times;</button>
        `
        customFieldsContainer.appendChild(row)
      })

      // Wire up inputs to update state
      document.querySelectorAll('.custom-field-key').forEach((input: any) => {
        input.addEventListener('input', (e: any) => {
          customFields[parseInt(e.target.dataset.index)].key = e.target.value
        })
      })
      document.querySelectorAll('.custom-field-value').forEach((input: any) => {
        input.addEventListener('input', (e: any) => {
          customFields[parseInt(e.target.dataset.index)].value = e.target.value
        })
      })
      
      // Wire up remove buttons
      document.querySelectorAll('.custom-field-remove').forEach((btn: any) => {
        btn.addEventListener('click', (e: any) => {
          const index = parseInt(e.target.closest('button').dataset.index)
          customFields.splice(index, 1)
          renderCustomFields()
        })
      })
    }

    btnAddField.addEventListener('click', () => {
      customFields.push({ key: '', value: '' })
      renderCustomFields()
    })

    // ── Color mode radio handling ──
    const colorModeRadios = document.querySelectorAll<HTMLInputElement>('input[name="color_mode"]')

    function getColorMode(): string {
      for (const r of colorModeRadios) { if (r.checked) return r.value }
      return 'single'
    }

    function onColorModeChange() {
      const mode = getColorMode()
      if (mode === 'multi') {
        multiColorOptions.classList.remove('hidden')
        colorHint.textContent = t('filaments.colorHintMulti')
      } else {
        multiColorOptions.classList.add('hidden')
        colorHint.textContent = t('filaments.colorHintSingle')
        // If more than 1 color selected in single mode, keep only the last
        if (selectedColorIds.length > 1) {
          selectedColorIds = [selectedColorIds[selectedColorIds.length - 1]]
          renderSelectedColors()
          renderColorGrid()
        }
      }
    }

    colorModeRadios.forEach(r => r.addEventListener('change', onColorModeChange))

    // ── Type handling ──
    typeSelect.addEventListener('change', () => {
      if (typeSelect.value === CUSTOM_TYPE_VALUE) {
        customTypeWrapper.classList.remove('hidden')
        customTypeInput.required = true
        customTypeInput.focus()
      } else {
        customTypeWrapper.classList.add('hidden')
        customTypeInput.required = false
        customTypeInput.value = ''
      }
    })

    customTypeInput.addEventListener('input', () => {
      customTypeInput.value = customTypeInput.value.toUpperCase()
    })

    // ── Load data ──
    async function loadManufacturers() {
      try {
        const response = await fetch('/api/v1/manufacturers?page_size=200', { credentials: 'include' })
        if (!response.ok) throw new Error('Failed to fetch manufacturers')
        const data = await response.json()
        const select = document.getElementById('manufacturer_id') as HTMLSelectElement
        data.items.forEach((m: any) => {
          const option = document.createElement('option')
          option.value = m.id
          option.textContent = m.name || t('common.unknown')
          select.appendChild(option)
        })
      } catch (error) {
        console.error('Failed to load manufacturers:', error)
      }
    }

    async function loadTypes() {
      try {
        const response = await fetch('/api/v1/filaments/types', { credentials: 'include' })
        if (!response.ok) throw new Error('Failed to fetch filament types')
        const types: string[] = await response.json()
        types.forEach((typeName: string) => {
          const option = document.createElement('option')
          option.value = typeName
          option.textContent = typeName
          typeSelect.appendChild(option)
        })
      } catch (error) {
        console.error('Failed to load filament types:', error)
        for (const typeName of ['PLA', 'PETG', 'ABS', 'ASA', 'TPU', 'NYLON', 'PC']) {
          const option = document.createElement('option')
          option.value = typeName
          option.textContent = typeName
          typeSelect.appendChild(option)
        }
      }
      const customOption = document.createElement('option')
      customOption.value = CUSTOM_TYPE_VALUE
      customOption.textContent = t('filaments.addCustomType')
      typeSelect.appendChild(customOption)
    }

    async function loadColors() {
      try {
        const response = await fetch('/api/v1/colors?page_size=200', { credentials: 'include' })
        if (!response.ok) throw new Error('Failed to fetch colors')
        const data = await response.json()
        allColors = data.items
        renderColorGrid()
      } catch (error) {
        console.error('Failed to load colors:', error)
        colorGrid.innerHTML = `<p style="color: var(--error-text); font-size: 0.85rem;">${t('filaments.failedLoadColors')}</p>`
      }
    }

    // ── Render color grid (all available colors) ──
    function renderColorGrid() {
      if (allColors.length === 0) {
        colorGrid.innerHTML = `<p style="color: var(--text-muted); font-size: 0.85rem;">${t('filaments.noColorsAvailable')}</p>`
        return
      }

      colorGrid.innerHTML = ''
      allColors.forEach(c => {
        const isSelected = selectedColorIds.includes(c.id)
        const swatch = document.createElement('button')
        swatch.type = 'button'
        swatch.className = `fm-color-swatch ${isSelected ? 'selected' : ''}`
        swatch.style.backgroundColor = c.hex_code
        swatch.title = `${c.name} (${c.hex_code})`
        swatch.addEventListener('click', () => toggleColor(c.id))
        colorGrid.appendChild(swatch)
      })
    }

    // ── Toggle color selection ──
    function toggleColor(colorId: number) {
      const mode = getColorMode()
      const idx = selectedColorIds.indexOf(colorId)
      if (idx >= 0) {
        // Deselect
        selectedColorIds.splice(idx, 1)
      } else {
        if (mode === 'single') {
          // Replace
          selectedColorIds = [colorId]
        } else {
          // Add
          selectedColorIds.push(colorId)
        }
      }
      renderSelectedColors()
      renderColorGrid()
    }

    // ── Render selected colors (chips below label) ──
    function renderSelectedColors() {
      selectedColorsContainer.innerHTML = ''
      selectedColorIds.forEach((cid, idx) => {
        const color = allColors.find(c => c.id === cid)
        if (!color) return
        const entry = document.createElement('div')
        entry.className = 'fm-color-entry'
        entry.innerHTML = `
          <span class="fm-color-swatch-lg" style="background-color: ${color.hex_code};"></span>
          <span style="font-size: 0.85rem; color: var(--text);">${color.name}</span>
          <span style="font-size: 0.75rem; color: var(--text-muted);">${color.hex_code}</span>
          ${getColorMode() === 'multi' ? `<span style="font-size: 0.75rem; color: var(--text-muted);">#${idx + 1}</span>` : ''}
          <button type="button" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:1.1rem;padding:0 4px;" data-remove-color="${cid}">&times;</button>
        `
        selectedColorsContainer.appendChild(entry)
      })

      // Wire remove buttons
      selectedColorsContainer.querySelectorAll<HTMLButtonElement>('[data-remove-color]').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = parseInt(btn.dataset.removeColor!)
          selectedColorIds = selectedColorIds.filter(c => c !== id)
          renderSelectedColors()
          renderColorGrid()
        })
      })
    }

    // ── New color form ──
    btnAddNewColor.addEventListener('click', () => {
      newColorForm.classList.remove('hidden')
      btnAddNewColor.parentElement!.classList.add('hidden')
      newColorName.focus()
    })

    btnCancelNewColor.addEventListener('click', () => {
      newColorForm.classList.add('hidden')
      btnAddNewColor.parentElement!.classList.remove('hidden')
      newColorName.value = ''
    })

    btnSaveNewColor.addEventListener('click', async () => {
      const name = newColorName.value.trim()
      const hex = newColorHex.value
      if (!name) { newColorName.focus(); return }

      btnSaveNewColor.disabled = true
      try {
        const response = await fetch('/api/v1/colors', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': getCsrfToken(),
          },
          credentials: 'include',
          body: JSON.stringify({ name, hex_code: hex }),
        })
        if (!response.ok) {
          const err = await response.json()
          throw new Error(err.detail?.message || t('filaments.failedCreateColor'))
        }
        const newColor = await response.json()
        allColors.push(newColor)
        // Auto-select the new color
        toggleColor(newColor.id)
        // Reset form
        newColorName.value = ''
        newColorForm.classList.add('hidden')
        btnAddNewColor.parentElement!.classList.remove('hidden')
      } catch (error: any) {
        await (window as any).__fmAlert?.(error.message) || alert(error.message)
      } finally {
        btnSaveNewColor.disabled = false
      }
    })

    // ── CSRF ──
    function getCsrfToken(): string {
      const match = document.cookie.match(/(?:^|;\s*)csrf_token=([^;]*)/)
      return match ? decodeURIComponent(match[1]) : ''
    }

    // ── Form Submit ──
    form.addEventListener('submit', async (e) => {
      e.preventDefault()
      
      const formData = new FormData(form)

      // Resolve type
      let filamentType = formData.get('type') as string
      if (filamentType === CUSTOM_TYPE_VALUE) {
        filamentType = (formData.get('custom_type') as string || '').trim().toUpperCase()
        if (!filamentType) {
          errorMessage.textContent = t('filaments.customTypeLabel')
          errorMessage.classList.remove('hidden')
          customTypeInput.focus()
          return
        }
      }

      // Validate at least one color selected
      if (selectedColorIds.length === 0) {
        errorMessage.textContent = t('filaments.colorRequired')
        errorMessage.classList.remove('hidden')
        return
      }

      const colorMode = getColorMode()

      const data: any = {
        manufacturer_id: parseInt(formData.get('manufacturer_id') as string),
        designation: formData.get('designation'),
        type: filamentType,
        diameter_mm: parseFloat(formData.get('diameter_mm') as string),
        color_mode: colorMode,
        colors: selectedColorIds.map((cid, idx) => ({
          color_id: cid,
          position: idx + 1,
        })),
      }

      // Optional fields
      const materialSubgroup = formData.get('material_subgroup')
      if (materialSubgroup) data.material_subgroup = materialSubgroup

      const finishType = formData.get('finish_type')
      if (finishType) data.finish_type = finishType

      if (colorMode === 'multi') {
        data.multi_color_style = formData.get('multi_color_style')
      }

      const manufacturerColorName = formData.get('manufacturer_color_name')
      if (manufacturerColorName) data.manufacturer_color_name = manufacturerColorName

      const rawWeight = formData.get('raw_material_weight_g')
      if (rawWeight) data.raw_material_weight_g = parseFloat(rawWeight as string)

      const spoolWeight = formData.get('default_spool_weight_g')
      if (spoolWeight) data.default_spool_weight_g = parseFloat(spoolWeight as string)

      const price = formData.get('price')
      if (price) data.price = parseFloat(price as string)

      const density = formData.get('density_g_cm3')
      if (density) data.density_g_cm3 = parseFloat(density as string)

      const shopUrl = formData.get('shop_url')
      if (shopUrl) data.shop_url = shopUrl

      // Custom Fields
      if (customFields.length > 0) {
        const fieldsObj: Record<string, any> = {}
        customFields.forEach(f => {
          if (f.key.trim()) {
            fieldsObj[f.key.trim()] = f.value
          }
        })
        data.custom_fields = Object.keys(fieldsObj).length > 0 ? unflattenObject(fieldsObj) : null
      }

      errorMessage.classList.add('hidden')
      submitBtn.disabled = true
      submitBtn.textContent = t('common.creating')

      try {
        const response = await fetch('/api/v1/filaments', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': getCsrfToken(),
          },
          credentials: 'include',
          body: JSON.stringify(data),
        })

        if (!response.ok) {
          const errorData = await response.json()
          throw new Error(errorData.detail?.message || errorData.message || t('filaments.failedCreate'))
        }

        const filament = await response.json()
        window.location.href = `/filaments/${filament.id}`
      } catch (error: any) {
        errorMessage.textContent = error.message || t('filaments.failedCreate')
        errorMessage.classList.remove('hidden')
      } finally {
        submitBtn.disabled = false
        submitBtn.textContent = t('filaments.createFilament')
      }
    })

    // ── Init ──
    loadManufacturers()
    loadTypes()
    loadColors()
  </script>
</Layout>
