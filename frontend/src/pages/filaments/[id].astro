---
import Layout from '../../layouts/Layout.astro'

const { id } = Astro.params
---

<Layout title="FilaMan - Filament">
  <div style="margin-bottom: 24px;">
    <a href="/filaments" style="color: var(--accent); text-decoration: none;">&larr; <span data-i18n="filaments.backToFilaments">Back to Filaments</span></a>
  </div>
  
  <div id="filament-content">
    <p style="color: var(--text-muted);" data-i18n="common.loading">Loading...</p>
  </div>
  
  <div id="spools-section" class="hidden" style="margin-top: 32px;">
    <h2 style="font-weight: 600; margin-bottom: 16px;" data-i18n="filaments.spools">Spools</h2>
    <div class="fm-card" style="padding: 0; overflow: hidden;">
      <table class="fm-table">
        <thead>
          <tr style="background: var(--bg-soft);">
            <th data-i18n="spools.id">ID</th>
            <th data-i18n="spools.status">Status</th>
            <th data-i18n="spools.remaining">Remaining</th>
            <th data-i18n="spools.location">Location</th>
          </tr>
        </thead>
        <tbody id="spools-table">
          <tr>
            <td colspan="4" style="text-align: center; color: var(--text-muted);" data-i18n="common.loading">Loading...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
  
  <script>
    import { t, initI18n } from '../../lib/i18n'
    await initI18n()

    const id = window.location.pathname.split('/').filter(Boolean).pop()!

    const finishLabels: Record<string, string> = {
      solid: 'filaments.finishSolid',
      translucent: 'filaments.finishTranslucent',
      neon: 'filaments.finishNeon',
      glow: 'filaments.finishGlow',
    }

    const colorModeLabels: Record<string, string> = {
      single: 'filaments.colorModeSingle',
      multi: 'filaments.colorModeMulti',
    }

    const multiStyleLabels: Record<string, string> = {
      striped: 'filaments.styleStriped',
      gradient: 'filaments.styleGradient',
    }

    async function loadFilament() {
      try {
        const response = await fetch(`/api/v1/filaments/${id}`, {
          credentials: 'include',
        })
        
        if (!response.ok) {
          if (response.status === 404) {
            document.getElementById('filament-content')!.innerHTML = `
              <div style="color: var(--error-text);">${t('filaments.notFound')}</div>
            `
            return
          }
          throw new Error('Failed to fetch filament')
        }
        
        const filament = await response.json()
        renderFilament(filament)
        loadSpools(filament.id)
      } catch (error) {
        console.error('Failed to load filament:', error)
        document.getElementById('filament-content')!.innerHTML = `
          <div style="color: var(--error-text);">${t('filaments.failedLoadSingle')}</div>
        `
      }
    }

    function renderColorSwatches(colors: any[]): string {
      if (!colors || colors.length === 0) return '-'
      return colors.map(fc => {
        const c = fc.color
        if (!c) return ''
        const label = fc.display_name_override || c.name
        return `<span style="display: inline-flex; align-items: center; gap: 6px; margin-right: 10px;">
          <span style="display: inline-block; width: 22px; height: 22px; border-radius: 50%; background: ${c.hex_code}; border: 2px solid var(--border); vertical-align: middle;"></span>
          <span>${label}</span>
        </span>`
      }).join('')
    }

    function renderDetailCard(label: string, value: string): string {
      return `<div class="fm-card">
        <div style="font-size: 0.85rem; color: var(--text-muted);">${label}</div>
        <div style="font-size: 1.1rem; font-weight: 600;">${value}</div>
      </div>`
    }
    
    function renderFilament(f: any) {
      // Build the secondary info cards grid
      const cards: string[] = []
      cards.push(renderDetailCard(t('filaments.type'), f.type))
      if (f.material_subgroup) {
        cards.push(renderDetailCard(t('filaments.materialSubgroup'), f.material_subgroup))
      }
      cards.push(renderDetailCard(t('filaments.diameter'), f.diameter_mm + 'mm'))
      if (f.finish_type) {
        const finishKey = finishLabels[f.finish_type]
        cards.push(renderDetailCard(t('filaments.finishType'), finishKey ? t(finishKey) : f.finish_type))
      }
      cards.push(renderDetailCard(t('filaments.rawMaterial'), f.raw_material_weight_g ? f.raw_material_weight_g + 'g' : '-'))
      cards.push(renderDetailCard(t('filaments.spoolWeight'), f.default_spool_weight_g ? f.default_spool_weight_g + 'g' : '-'))
      if (f.price != null) {
        cards.push(renderDetailCard(t('filaments.price'), f.price.toFixed(2)))
      }
      if (f.density_g_cm3 != null) {
        cards.push(renderDetailCard(t('filaments.density'), f.density_g_cm3.toString()))
      }

      // Color mode info
      const colorModeKey = colorModeLabels[f.color_mode]
      let colorModeDisplay = colorModeKey ? t(colorModeKey) : f.color_mode
      if (f.color_mode === 'multi' && f.multi_color_style) {
        const styleKey = multiStyleLabels[f.multi_color_style]
        colorModeDisplay += ` (${styleKey ? t(styleKey) : f.multi_color_style})`
      }

      // Colors section
      const colorsHtml = f.colors && f.colors.length > 0
        ? `<div class="fm-card" style="margin-top: 16px;">
            <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 8px;">
              ${t('filaments.colors')} &mdash; ${colorModeDisplay}
            </div>
            <div style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center;">
              ${renderColorSwatches(f.colors)}
            </div>
          </div>`
        : ''

      // Manufacturer color name
      const mfgColorHtml = f.manufacturer_color_name
        ? `<div class="fm-card" style="margin-top: 16px;">
            <div style="font-size: 0.85rem; color: var(--text-muted);">${t('filaments.manufacturerColorName')}</div>
            <div style="font-size: 1.1rem; font-weight: 600;">${f.manufacturer_color_name}</div>
          </div>`
        : ''

      // Shop URL
      const shopHtml = f.shop_url
        ? `<div class="fm-card" style="margin-top: 16px;">
            <div style="font-size: 0.85rem; color: var(--text-muted);">${t('filaments.shopUrl')}</div>
            <div style="font-size: 1.1rem;">
              <a href="${f.shop_url}" target="_blank" rel="noopener noreferrer" style="color: var(--accent); word-break: break-all;">${f.shop_url}</a>
            </div>
          </div>`
        : ''

      document.getElementById('filament-content')!.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 24px;">
          <div>
            <h1 style="font-size: 1.8rem; font-weight: 700; margin: 0; font-family: var(--font-serif);">${f.designation}</h1>
            <p style="color: var(--text-muted); margin: 4px 0 0;">${f.manufacturer?.name || t('filaments.unknownManufacturer')}</p>
          </div>
          <a href="/filaments/${f.id}/edit" class="fm-btn fm-btn-outline">
            ${t('common.edit')}
          </a>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 16px;">
          ${cards.join('\n')}
        </div>

        ${colorsHtml}
        ${mfgColorHtml}
        ${shopHtml}
      `
    }
    
    async function loadSpools(filamentId: number) {
      try {
        const response = await fetch(`/api/v1/spools?filament_id=${filamentId}&page_size=100`, {
          credentials: 'include',
        })
        
        if (!response.ok) throw new Error('Failed to fetch spools')
        
        const data = await response.json()
        document.getElementById('spools-section')!.classList.remove('hidden')
        renderSpools(data.items)
      } catch (error) {
        console.error('Failed to load spools:', error)
      }
    }
    
    function renderSpools(spools: any[]) {
      const tbody = document.getElementById('spools-table')!
      
      if (spools.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="4" style="text-align: center; color: var(--text-muted);">
              ${t('filaments.noSpools')} <a href="/spools/new?filament_id=${id}" style="color: var(--accent);">${t('filaments.addOne')}</a>.
            </td>
          </tr>
        `
        return
      }
      
      tbody.innerHTML = spools.map(s => `
        <tr style="cursor: pointer;" onclick="window.location='/spools/${s.id}'">
          <td style="padding: 12px; font-weight: 500;">${t('spools.spoolId', { id: s.id })}</td>
          <td style="padding: 12px;">${s.status_id || '-'}</td>
          <td style="padding: 12px; ${s.remaining_weight_g !== null && s.remaining_weight_g <= s.low_weight_threshold_g ? 'color: var(--accent-3); font-weight: 500;' : ''}">
            ${s.remaining_weight_g !== null ? s.remaining_weight_g.toFixed(0) + 'g' : '-'}
          </td>
          <td style="padding: 12px; color: var(--text-muted);">${s.location_id || t('spools.noLocation')}</td>
        </tr>
      `).join('')
    }
    
    loadFilament()
  </script>
</Layout>
