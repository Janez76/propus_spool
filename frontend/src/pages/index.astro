---
import Layout from '../layouts/Layout.astro'

interface Spool {
  id: number
  filament_id: number
  status_id: number
  remaining_weight_g: number | null
  low_weight_threshold_g: number
  lot_number: string | null
  rfid_uid: string | null
  external_id: string | null
}

interface Filament {
  id: number
  designation: string
  type: string
  manufacturer_id: number
}

interface Status {
  id: number
  key: string
  label: string
}

interface SpoolWithFilament extends Spool {
  filament?: Filament
  status?: Status
}

interface PaginatedResponse<T> {
  items: T[]
  total: number
  page: number
  page_size: number
}
---

<Layout title="FilaMan - Dashboard">
  <h1 style="font-size: 1.8rem; font-weight: 700; margin-bottom: 24px; font-family: var(--font-serif);" data-i18n="dashboard.title">Dashboard</h1>
  
  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 16px;">
    <div class="fm-card">
      <div style="font-size: 1.6rem; font-weight: 700;" id="stat-total-spools">-</div>
      <div style="font-size: 0.85rem; color: var(--text-muted);" data-i18n="dashboard.totalSpools">Total Spools</div>
    </div>
    <div class="fm-card">
      <div style="font-size: 1.6rem; font-weight: 700;" id="stat-total-filaments">-</div>
      <div style="font-size: 0.85rem; color: var(--text-muted);" data-i18n="dashboard.filaments">Filaments</div>
    </div>
    <div class="fm-card" style="cursor: pointer;" onclick="openSpoolModal('low')">
      <div style="font-size: 1.6rem; font-weight: 700;" id="stat-low-spools">-</div>
      <div style="font-size: 0.85rem; color: var(--text-muted);" data-i18n="dashboard.lowSpools">Low Spools</div>
    </div>
    <div class="fm-card" style="cursor: pointer;" onclick="openSpoolModal('empty')">
      <div style="font-size: 1.6rem; font-weight: 700;" id="stat-empty-spools">-</div>
      <div style="font-size: 0.85rem; color: var(--text-muted);" data-i18n="dashboard.emptySpools">Empty Spools</div>
    </div>
  </div>
  
  <div style="margin-top: 24px; display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
    <div class="fm-card">
      <h2 style="font-weight: 600; margin: 0 0 16px 0; color: var(--accent-3);" data-i18n="dashboard.lowStockSpools">Spulen (fast leer)</h2>
      <div id="low-stock-spools" style="max-height: 280px; overflow-y: auto;">
        <p style="color: var(--text-muted);" data-i18n="common.loading">Loading...</p>
      </div>
    </div>
    
    <div class="fm-card">
      <h2 style="font-weight: 600; margin: 0 0 16px 0;" data-i18n="dashboard.manufacturersWithSpools">Hersteller (nicht leer)</h2>
      <div id="manufacturers-with-spools" style="max-height: 280px; overflow-y: auto;">
        <p style="color: var(--text-muted);" data-i18n="common.loading">Loading...</p>
      </div>
    </div>
    
    <div class="fm-card">
      <h2 style="font-weight: 600; margin: 0 0 16px 0;" data-i18n="dashboard.filamentTypes">Filament-Arten</h2>
      <div id="filament-types" style="max-height: 280px; overflow-y: auto;">
        <p style="color: var(--text-muted);" data-i18n="common.loading">Loading...</p>
      </div>
    </div>
  </div>

  <div class="grid grid-cols-2 gap-5" style="margin-top: 24px;">
    <div class="flex flex-col gap-5">
      <div class="fm-card">
        <h2 style="font-weight: 600; margin: 0 0 16px 0;" data-i18n="dashboard.spoolStatus">Spulen-Status</h2>
        <div id="spool-status" style="display: flex; gap: 16px; flex-wrap: wrap; justify-content: center;">
          <p style="color: var(--text-muted);" data-i18n="common.loading">Loading...</p>
        </div>
      </div>
      
      <div class="fm-card">
        <h2 style="font-weight: 600; margin: 0 0 16px 0;" data-i18n="dashboard.locationStats">Lagerorte</h2>
        <div id="location-stats" style="overflow-y: auto;">
          <p style="color: var(--text-muted);" data-i18n="common.loading">Loading...</p>
        </div>
      </div>
    </div>
    
    <div class="fm-card overflow-y-auto" style="max-height: 400px;">
      <h2 style="font-weight: 600; margin: 0 0 16px 0;" data-i18n="dashboard.filamentStats">Filament-Statistik</h2>
      <div id="filament-stats">
        <p style="color: var(--text-muted);" data-i18n="common.loading">Loading...</p>
      </div>
    </div>
  </div>
  
  <!-- Spool Modal -->
  <div id="spool-modal" class="fm-modal-overlay">
    <div class="fm-modal" style="max-width: 800px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <h2 id="modal-title" style="margin: 0; font-weight: 600; font-size: 1.1rem;">Spulen</h2>
        <button onclick="closeSpoolModal()" style="background: none; border: none; font-size: 1.2rem; cursor: pointer; padding: 4px 8px; color: var(--text-muted);">✕</button>
      </div>
      <div id="modal-content" style="max-height: 60vh; overflow-y: auto;">
        <p style="color: var(--text-muted);">Loading...</p>
      </div>
    </div>
  </div>
  <script>
    import { t, initI18n } from '../lib/i18n'

    let allSpools: any[] = []
    let allFilaments: any[] = []

    function getFilamentName(filamentId: number): string {
      const f = allFilaments.find(fil => fil.id === filamentId)
      if (!f) return '-'
      return `${f.designation} (${f.type || '-'})`
    }

    function formatWeight(g: number): string {
      if (g >= 1000000) return (g / 1000000).toFixed(1) + ' t'
      if (g >= 1000) return (g / 1000).toFixed(1) + ' kg'
      return g.toFixed(0) + ' g'
    }

    // Modal functions
    (window as any).openSpoolModal = function(type: 'low' | 'empty') {
      const modal = document.getElementById('spool-modal') as HTMLElement
      const title = document.getElementById('modal-title') as HTMLElement
      const content = document.getElementById('modal-content') as HTMLElement

      let filteredSpools: any[] = []
      
      if (type === 'low') {
        title.textContent = t('dashboard.lowSpools')
        filteredSpools = allSpools.filter(s => 
          s.remaining_weight_g !== null && 
          s.remaining_weight_g <= s.low_weight_threshold_g &&
          s.remaining_weight_g > 0
        )
      } else {
        title.textContent = t('dashboard.emptySpools')
        filteredSpools = allSpools.filter(s => 
          s.remaining_weight_g !== null && 
          s.remaining_weight_g <= 0
        )
      }

      if (filteredSpools.length === 0) {
        content.innerHTML = `<p style="color: var(--text-muted); text-align: center; padding: 20px;">${t('dashboard.noData')}</p>`
      } else {
        content.innerHTML = `
          <table class="fm-table">
            <thead>
              <tr>
                <th style="padding: 8px;">ID</th>
                <th style="padding: 8px;">${t('dashboard.filament')}</th>
                <th style="padding: 8px; text-align: right;">${t('dashboard.remaining')}</th>
              </tr>
            </thead>
            <tbody>
              ${filteredSpools.map(s => `
                <tr style="cursor: pointer;" onclick="window.location.href='/spools/${s.id}'">
                  <td style="padding: 8px;">#${s.id}</td>
                  <td style="padding: 8px;">${getFilamentName(s.filament_id)}</td>
                  <td style="padding: 8px; text-align: right; font-family: monospace;">${s.remaining_weight_g?.toFixed(0)}g</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `
      }

      modal.classList.add('open')
    }

    ;(window as any).closeSpoolModal = function() {
      const modal = document.getElementById('spool-modal') as HTMLElement
      modal.classList.remove('open')
    }

    // Close on escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') (window as any).closeSpoolModal()
    })

    // Close on backdrop click
    document.getElementById('spool-modal')?.addEventListener('click', (e) => {
      if (e.target === e.currentTarget) (window as any).closeSpoolModal()
    })

    async function init() {
      await initI18n()

      try {
        const [spoolsRes, filamentsRes, dashboardRes] = await Promise.all([
          fetch('/api/v1/spools?page_size=200', { credentials: 'include' }),
          fetch('/api/v1/filaments?page_size=200', { credentials: 'include' }),
          fetch('/api/v1/dashboard/stats?limit=20', { credentials: 'include' }),
        ])
        
        if (!spoolsRes.ok || !filamentsRes.ok) {
          throw new Error('Failed to fetch data')
        }
        
        const spoolsData = await spoolsRes.json()
        const filamentsData = await filamentsRes.json()
        const dashboardData = dashboardRes.ok ? await dashboardRes.json() : null
        
        allSpools = spoolsData.items
        allFilaments = filamentsData.items
        const spools = allSpools
        const filaments = allFilaments
        
        document.getElementById('stat-total-spools')!.textContent = spools.length
        document.getElementById('stat-total-filaments')!.textContent = filaments.length
        
        if (dashboardData) {
          const dist = dashboardData.spool_distribution || { full: 0, normal: 0, low: 0, critical: 0, empty: 0 }
          document.getElementById('stat-low-spools')!.textContent = (dist.low + dist.critical).toString()
          document.getElementById('stat-empty-spools')!.textContent = dist.empty.toString()
          
          // Spulen-Status Indikatoren
          const statusContainer = document.getElementById('spool-status')!
          const statusItems = [
            { key: 'full', label: t('dashboard.statusFull'), color: '#22c55e', count: dist.full, hint: '>75%' },
            { key: 'normal', label: t('dashboard.statusNormal'), color: '#3b82f6', count: dist.normal, hint: '50-75%' },
            { key: 'low', label: t('dashboard.statusLow'), color: '#eab308', count: dist.low, hint: '>½min' },
            { key: 'critical', label: t('dashboard.statusCritical'), color: '#ef4444', count: dist.critical, hint: '≤½min' },
            { key: 'empty', label: t('dashboard.statusEmpty'), color: '#6b7280', count: dist.empty, hint: '0g' },
          ]
          statusContainer.innerHTML = statusItems.map(s => `
            <div style="text-align: center; min-width: 60px;">
              <div style="font-size: 1.5rem; font-weight: 700; color: ${s.color};">${s.count}</div>
              <div style="font-size: 0.7rem; color: var(--text-muted);">${s.label}</div>
              <div style="font-size: 0.6rem; color: var(--text-muted); opacity: 0.7;">${s.hint}</div>
            </div>
          `).join('')

          // Lagerorte-Statistik
          const locationStatsContainer = document.getElementById('location-stats')!
          if (!dashboardData.location_stats || dashboardData.location_stats.length === 0) {
            locationStatsContainer.innerHTML = `<p style="color: var(--text-muted);">${t('dashboard.noData')}</p>`
          } else {
            locationStatsContainer.innerHTML = `<table class="fm-table" style="font-size: 0.85rem;">
              <thead><tr>
                <th style="padding: 6px 8px;">${t('locations.name') || 'Location'}</th>
                <th style="padding: 6px 8px; text-align: right;">${t('dashboard.spools')}</th>
                <th style="padding: 6px 8px; text-align: right;">${t('dashboard.remaining')}</th>
              </tr></thead>
              <tbody>` + 
              dashboardData.location_stats.map((l: any) => 
                `<tr>
                  <td style="padding: 6px 8px;">${l.location_name}</td>
                  <td style="padding: 6px 8px; text-align: right; font-family: monospace;">${l.spool_count}</td>
                  <td style="padding: 6px 8px; text-align: right; font-family: monospace;">${formatWeight(l.total_weight_g)}</td>
                </tr>`
              ).join('') +
              `</tbody></table>`
          }

          // Filament-Statistik
          const filamentStatsContainer = document.getElementById('filament-stats')!
          if (!dashboardData.filament_stats || dashboardData.filament_stats.length === 0) {
            filamentStatsContainer.innerHTML = `<p style="color: var(--text-muted);">${t('dashboard.noData')}</p>`
          } else {
            filamentStatsContainer.innerHTML = `<table class="fm-table" style="font-size: 0.85rem;">
              <thead><tr>
                <th style="padding: 6px 8px;">${t('dashboard.filament')}</th>
                <th style="padding: 6px 8px; text-align: right;">${t('dashboard.spools')}</th>
                <th style="padding: 6px 8px; text-align: right;">${t('dashboard.remaining')}</th>
              </tr></thead>
              <tbody>` + 
              dashboardData.filament_stats.map((f: any) => 
                `<tr>
                  <td style="padding: 6px 8px;">${f.filament_type}</td>
                  <td style="padding: 6px 8px; text-align: right; font-family: monospace;">${f.spool_count}</td>
                  <td style="padding: 6px 8px; text-align: right; font-family: monospace;">${formatWeight(f.total_weight_g)}</td>
                </tr>`
              ).join('') +
              `</tbody></table>`
          }

          // Hersteller mit Spulen
          const mfrContainer = document.getElementById('manufacturers-with-spools')!
          if (dashboardData.manufacturers_with_spools.length === 0) {
            mfrContainer.innerHTML = `<p style="color: var(--text-muted);">${t('dashboard.noData')}</p>`
          } else {
            mfrContainer.innerHTML = `<table class="fm-table" style="font-size: 0.85rem;"><tbody>` + 
              dashboardData.manufacturers_with_spools.map((m: any) => 
                `<tr><td>${m.name}</td><td style="text-align: right; font-family: monospace;">${m.spool_count}</td></tr>`
              ).join('') +
              `</tbody></table>`
          }

          // Low-stock Spulen
          const mfrLowStockContainer = document.getElementById('low-stock-spools')!
          if (dashboardData.low_stock_spools.length === 0) {
            mfrLowStockContainer.innerHTML = `<p style="color: var(--accent);">${t('dashboard.allSufficient')}</p>`
          } else {
            mfrLowStockContainer.innerHTML = `<table class="fm-table" style="font-size: 0.85rem;">
              <thead><tr>
                <th style="padding: 6px 8px;">${t('dashboard.spool')}</th>
                <th style="padding: 6px 8px;">${t('dashboard.filament')}</th>
                <th style="padding: 6px 8px;">${t('dashboard.manufacturer')}</th>
                <th style="padding: 6px 8px; text-align: right;">${t('dashboard.remaining')}</th>
              </tr></thead>
              <tbody>` + 
              dashboardData.low_stock_spools.map((s: any) => 
                `<tr style="cursor: pointer;" onclick="window.location.href='/spools/${s.spool_id}'">
                  <td style="padding: 6px 8px;">#${s.spool_id}</td>
                  <td style="padding: 6px 8px;">${s.filament_designation} (${s.filament_type})</td>
                  <td style="padding: 6px 8px;">${s.manufacturer_name}</td>
                  <td style="padding: 6px 8px; text-align: right; font-family: monospace; color: var(--accent-3);">${s.remaining_weight_g.toFixed(0)}g</td>
                </tr>`
              ).join('') +
              `</tbody></table>`
          }

          // Filament-Typen
          const typesContainer = document.getElementById('filament-types')!
          if (dashboardData.filament_types.length === 0) {
            typesContainer.innerHTML = `<p style="color: var(--text-muted);">${t('dashboard.noData')}</p>`
          } else {
            typesContainer.innerHTML = `<table class="fm-table" style="font-size: 0.85rem;"><tbody>` + 
              dashboardData.filament_types.map((t: any) => 
                `<tr><td>${t.type}</td><td style="text-align: right; font-family: monospace;">${t.count}</td></tr>`
              ).join('') +
              `</tbody></table>`
          }
        }
      } catch (error) {
        console.error('Failed to load dashboard:', error)
      }
    }
    
    init()
  </script>
</Layout>
