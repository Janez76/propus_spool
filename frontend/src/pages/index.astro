---
import Layout from '../layouts/Layout.astro'

interface Spool {
  id: number
  filament_id: number
  status_id: number
  remaining_weight_g: number | null
  low_weight_threshold_g: number
  lot_number: string | null
  rfid_uid: string | null
  external_id: string | null
}

interface Filament {
  id: number
  designation: string
  type: string
  manufacturer_id: number
}

interface Status {
  id: number
  key: string
  label: string
}

interface SpoolWithFilament extends Spool {
  filament?: Filament
  status?: Status
}

interface PaginatedResponse<T> {
  items: T[]
  total: number
  page: number
  page_size: number
}
---

<Layout title="Propus Spool - Dashboard">
  <style>
    .db-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 12px;
    }
    .db-header h1 {
      font-size: 1.5rem;
      font-weight: 700;
      margin: 0;
    }
    .db-customize-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background: var(--bg-soft);
      color: var(--text-muted);
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      transition: all var(--transition);
      font-family: var(--font-sans);
    }
    .db-customize-btn:hover { color: var(--accent); border-color: var(--accent); }

    .stat-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }
    .stat-card {
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: 16px;
      display: flex;
      align-items: center;
      gap: 14px;
      cursor: pointer;
      transition: all var(--transition);
    }
    .stat-card:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-sm);
    }
    .stat-icon {
      width: 40px;
      height: 40px;
      border-radius: var(--radius-sm);
      display: grid;
      place-items: center;
      flex-shrink: 0;
    }
    .stat-icon svg { width: 20px; height: 20px; }
    .stat-value { font-size: 1.4rem; font-weight: 700; line-height: 1; }
    .stat-label { font-size: 0.75rem; color: var(--text-muted); margin-top: 2px; }

    .widget-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 16px;
    }
    .widget {
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      overflow: hidden;
      transition: opacity var(--transition);
    }
    .widget.hidden-widget { display: none; }
    .widget-header {
      padding: 14px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--border-subtle);
    }
    .widget-title {
      font-weight: 600;
      font-size: 0.875rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .widget-title .dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      display: inline-block;
    }
    .widget-body {
      padding: 12px 16px;
      max-height: 260px;
      overflow-y: auto;
    }

    .customize-panel {
      position: fixed;
      top: 0;
      right: -360px;
      width: 340px;
      height: 100vh;
      background: var(--bg-elevated);
      border-left: 1px solid var(--border);
      z-index: 9998;
      transition: right 300ms cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      flex-direction: column;
      box-shadow: var(--shadow-lg);
    }
    .customize-panel.open { right: 0; }
    .customize-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.4);
      z-index: 9997;
      opacity: 0;
      pointer-events: none;
      transition: opacity 200ms ease;
    }
    .customize-backdrop.open { opacity: 1; pointer-events: auto; }
    .customize-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .customize-header h3 { margin: 0; font-size: 1rem; font-weight: 600; }
    .customize-list { padding: 12px 20px; flex: 1; overflow-y: auto; }
    .customize-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid var(--border-subtle);
    }
    .customize-item-label { font-size: 0.85rem; font-weight: 500; }

    .status-bar {
      display: flex;
      gap: 2px;
      border-radius: var(--radius-sm);
      overflow: hidden;
      height: 32px;
      margin-bottom: 8px;
    }
    .status-segment {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: 600;
      color: white;
      min-width: 28px;
      transition: flex var(--transition);
    }
  </style>

  <!-- Header -->
  <div class="db-header">
    <h1 data-i18n="dashboard.title">Dashboard</h1>
    <button class="db-customize-btn" id="btn-customize">
      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
      <span data-i18n="dashboard.customize">Customize</span>
    </button>
  </div>

  <!-- Stats -->
  <div class="stat-grid">
    <div class="stat-card" onclick="window.location.href='/spools'">
      <div class="stat-icon" style="background: rgba(0, 212, 170, 0.1);">
        <svg style="fill: var(--accent);"><use href="/icons.svg#icon-spools"></use></svg>
      </div>
      <div>
        <div class="stat-value" id="stat-total-spools">-</div>
        <div class="stat-label" data-i18n="dashboard.totalSpools">Total Spools</div>
      </div>
    </div>
    <div class="stat-card" onclick="window.location.href='/filaments'">
      <div class="stat-icon" style="background: rgba(56, 189, 248, 0.1);">
        <svg style="fill: var(--accent-2);"><use href="/icons.svg#icon-filaments"></use></svg>
      </div>
      <div>
        <div class="stat-value" id="stat-total-filaments">-</div>
        <div class="stat-label" data-i18n="dashboard.filaments">Filaments</div>
      </div>
    </div>
    <div class="stat-card" onclick="openSpoolModal('low')">
      <div class="stat-icon" style="background: rgba(251, 191, 36, 0.1);">
        <svg style="fill: var(--accent-3);"><use href="/icons.svg#icon-spools"></use></svg>
      </div>
      <div>
        <div class="stat-value" id="stat-low-spools">-</div>
        <div class="stat-label" data-i18n="dashboard.lowSpools">Low Spools</div>
      </div>
    </div>
    <div class="stat-card" onclick="openSpoolModal('empty')">
      <div class="stat-icon" style="background: rgba(239, 68, 68, 0.1);">
        <svg style="fill: var(--error-text);"><use href="/icons.svg#icon-spools"></use></svg>
      </div>
      <div>
        <div class="stat-value" id="stat-empty-spools">-</div>
        <div class="stat-label" data-i18n="dashboard.emptySpools">Empty Spools</div>
      </div>
    </div>
  </div>

  <!-- Widgets -->
  <div class="widget-grid" id="widget-grid">
    <div class="widget" data-widget="spool-status">
      <div class="widget-header">
        <div class="widget-title"><span class="dot" style="background: var(--accent);"></span> <span data-i18n="dashboard.spoolStatus">Spool Status</span></div>
      </div>
      <div class="widget-body" id="spool-status">
        <p style="color: var(--text-muted); font-size: 0.85rem;" data-i18n="common.loading">Loading...</p>
      </div>
    </div>

    <div class="widget" data-widget="low-stock">
      <div class="widget-header">
        <div class="widget-title"><span class="dot" style="background: var(--accent-3);"></span> <span data-i18n="dashboard.lowStockSpools">Low Stock</span></div>
      </div>
      <div class="widget-body" id="low-stock-spools">
        <p style="color: var(--text-muted); font-size: 0.85rem;" data-i18n="common.loading">Loading...</p>
      </div>
    </div>

    <div class="widget" data-widget="manufacturers">
      <div class="widget-header">
        <div class="widget-title"><span class="dot" style="background: var(--accent-2);"></span> <span data-i18n="dashboard.manufacturersWithSpools">Manufacturers</span></div>
      </div>
      <div class="widget-body" id="manufacturers-with-spools">
        <p style="color: var(--text-muted); font-size: 0.85rem;" data-i18n="common.loading">Loading...</p>
      </div>
    </div>

    <div class="widget" data-widget="filament-types">
      <div class="widget-header">
        <div class="widget-title"><span class="dot" style="background: #a78bfa;"></span> <span data-i18n="dashboard.filamentTypes">Filament Types</span></div>
      </div>
      <div class="widget-body" id="filament-types">
        <p style="color: var(--text-muted); font-size: 0.85rem;" data-i18n="common.loading">Loading...</p>
      </div>
    </div>

    <div class="widget" data-widget="location-stats">
      <div class="widget-header">
        <div class="widget-title"><span class="dot" style="background: #f472b6;"></span> <span data-i18n="dashboard.locationStats">Locations</span></div>
      </div>
      <div class="widget-body" id="location-stats">
        <p style="color: var(--text-muted); font-size: 0.85rem;" data-i18n="common.loading">Loading...</p>
      </div>
    </div>

    <div class="widget" data-widget="filament-stats">
      <div class="widget-header">
        <div class="widget-title"><span class="dot" style="background: #fb923c;"></span> <span data-i18n="dashboard.filamentStats">Filament Stats</span></div>
      </div>
      <div class="widget-body" id="filament-stats">
        <p style="color: var(--text-muted); font-size: 0.85rem;" data-i18n="common.loading">Loading...</p>
      </div>
    </div>
  </div>

  <!-- Customize Panel -->
  <div class="customize-backdrop" id="customize-backdrop"></div>
  <div class="customize-panel" id="customize-panel">
    <div class="customize-header">
      <h3 data-i18n="dashboard.customizeWidgets">Widgets</h3>
      <button id="close-customize" style="background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 4px;">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="customize-list" id="customize-list"></div>
  </div>

  <!-- Spool Modal -->
  <div id="spool-modal" class="fm-modal-overlay">
    <div class="fm-modal" style="max-width: 700px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px;">
        <h2 id="modal-title" style="margin: 0; font-weight: 600; font-size: 1rem;">Spulen</h2>
        <button onclick="closeSpoolModal()" style="background: none; border: none; font-size: 1.1rem; cursor: pointer; padding: 4px 8px; color: var(--text-muted);">âœ•</button>
      </div>
      <div id="modal-content" style="max-height: 60vh; overflow-y: auto;">
        <p style="color: var(--text-muted);">Loading...</p>
      </div>
      <div id="modal-footer" style="margin-top: 14px; border-top: 1px solid var(--border); padding-top: 14px;" class="hidden">
        <button id="btn-archive-all" class="fm-btn fm-btn-warning" style="width: 100%;"></button>
      </div>
    </div>
  </div>

  <script>
    import { t, initI18n } from '../lib/i18n'

    let allSpools: any[] = []
    let allFilaments: any[] = []

    const WIDGET_NAMES: Record<string, string> = {
      'spool-status': 'Spool Status',
      'low-stock': 'Low Stock',
      'manufacturers': 'Manufacturers',
      'filament-types': 'Filament Types',
      'location-stats': 'Locations',
      'filament-stats': 'Filament Stats',
    }

    function getWidgetVisibility(): Record<string, boolean> {
      try {
        const stored = localStorage.getItem('dashboard-widgets')
        if (stored) return JSON.parse(stored)
      } catch {}
      return Object.fromEntries(Object.keys(WIDGET_NAMES).map(k => [k, true]))
    }

    function saveWidgetVisibility(vis: Record<string, boolean>) {
      localStorage.setItem('dashboard-widgets', JSON.stringify(vis))
    }

    function applyWidgetVisibility() {
      const vis = getWidgetVisibility()
      document.querySelectorAll('[data-widget]').forEach(el => {
        const key = el.getAttribute('data-widget')!
        if (vis[key] === false) {
          el.classList.add('hidden-widget')
        } else {
          el.classList.remove('hidden-widget')
        }
      })
    }

    function renderCustomizeList() {
      const vis = getWidgetVisibility()
      const container = document.getElementById('customize-list')!
      container.innerHTML = Object.entries(WIDGET_NAMES).map(([key, name]) => {
        const isOn = vis[key] !== false
        return `
          <div class="customize-item">
            <span class="customize-item-label">${name}</span>
            <div class="fm-widget-toggle ${isOn ? 'active' : ''}" data-toggle-key="${key}"></div>
          </div>
        `
      }).join('')

      container.querySelectorAll('.fm-widget-toggle').forEach(toggle => {
        toggle.addEventListener('click', () => {
          const key = toggle.getAttribute('data-toggle-key')!
          const vis = getWidgetVisibility()
          vis[key] = !(vis[key] !== false)
          saveWidgetVisibility(vis)
          toggle.classList.toggle('active')
          applyWidgetVisibility()
        })
      })
    }

    // Customize panel open/close
    const btnCustomize = document.getElementById('btn-customize')!
    const panel = document.getElementById('customize-panel')!
    const backdrop = document.getElementById('customize-backdrop')!
    const closeBtn = document.getElementById('close-customize')!

    function openCustomize() {
      renderCustomizeList()
      panel.classList.add('open')
      backdrop.classList.add('open')
    }
    function closeCustomize() {
      panel.classList.remove('open')
      backdrop.classList.remove('open')
    }
    btnCustomize.addEventListener('click', openCustomize)
    closeBtn.addEventListener('click', closeCustomize)
    backdrop.addEventListener('click', closeCustomize)

    function getFilamentName(filamentId: number): string {
      const f = allFilaments.find(fil => fil.id === filamentId)
      if (!f) return '-'
      return `${f.designation} (${f.type || '-'})`
    }

    function formatWeight(g: number): string {
      if (g >= 1000000) return (g / 1000000).toFixed(1) + ' t'
      if (g >= 1000) return (g / 1000).toFixed(1) + ' kg'
      return g.toFixed(0) + ' g'
    }

    function getCsrfToken(): string {
      const match = document.cookie.match(/(?:^|;\s*)csrf_token=([^;]*)/)
      return match ? decodeURIComponent(match[1]) : ''
    }

    // Modal functions
    (window as any).openSpoolModal = function(type: 'low' | 'empty') {
      const modal = document.getElementById('spool-modal') as HTMLElement
      const title = document.getElementById('modal-title') as HTMLElement
      const content = document.getElementById('modal-content') as HTMLElement
      const footer = document.getElementById('modal-footer') as HTMLElement
      const bulkBtn = document.getElementById('btn-archive-all') as HTMLButtonElement

      let filteredSpools: any[] = []
      
      if (type === 'low') {
        title.textContent = t('dashboard.lowSpools')
        filteredSpools = allSpools.filter(s => 
          s.remaining_weight_g !== null && 
          s.remaining_weight_g <= s.low_weight_threshold_g &&
          s.remaining_weight_g > 0
        )
      } else {
        title.textContent = t('dashboard.emptySpools')
        filteredSpools = allSpools.filter(s => 
          s.remaining_weight_g !== null && 
          s.remaining_weight_g <= 0
        )
      }

      if (filteredSpools.length === 0) {
        content.innerHTML = `<p style="color: var(--text-muted); text-align: center; padding: 20px;">${t('dashboard.noData')}</p>`
        footer.classList.add('hidden')
      } else {
        content.innerHTML = `
          <table class="fm-table">
            <thead>
              <tr>
                <th style="padding: 8px;">ID</th>
                <th style="padding: 8px;">${t('dashboard.filament')}</th>
                <th style="padding: 8px; text-align: right;">${t('dashboard.remaining')}</th>
                <th style="padding: 8px; text-align: right;">${t('common.actions')}</th>
              </tr>
            </thead>
            <tbody>
              ${filteredSpools.map(s => `
                <tr data-spool-id="${s.id}">
                  <td style="padding: 8px; cursor: pointer;" onclick="window.location.href='/spools/${s.id}'">#${s.id}</td>
                  <td style="padding: 8px; cursor: pointer;" onclick="window.location.href='/spools/${s.id}'">${getFilamentName(s.filament_id)}</td>
                  <td style="padding: 8px; text-align: right; font-family: var(--font-mono); cursor: pointer;" onclick="window.location.href='/spools/${s.id}'">${s.remaining_weight_g?.toFixed(0)}g</td>
                  <td style="padding: 8px; text-align: right;">
                    <button class="fm-btn fm-btn-outline" style="padding: 4px 10px; font-size: 0.75rem;" onclick="archiveSpool(${s.id})">
                      ${t('dashboard.archive')}
                    </button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `
        
        footer.classList.remove('hidden')
        bulkBtn.textContent = type === 'low' ? t('dashboard.archiveAllLow') : t('dashboard.archiveAllEmpty')
        bulkBtn.onclick = () => archiveAll(filteredSpools.map(s => s.id))
      }

      modal.classList.add('open')
    }

    async function archiveSpool(id: number) {
      if (!(await (window as any).__fmConfirm(t('dashboard.confirmArchiveOne') || t('dashboard.archive') + '?', {
        okLabel: t('dashboard.archive'),
        isDanger: false
      }))) return

      const btn = document.querySelector(`tr[data-spool-id="${id}"] button`) as HTMLButtonElement
      if (btn) { btn.disabled = true; btn.textContent = '...' }

      try {
        const response = await fetch(`/api/v1/spools/${id}/status`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': getCsrfToken() },
          credentials: 'include',
          body: JSON.stringify({ status: 'archived' }),
        })

        if (response.ok) {
          const row = document.querySelector(`tr[data-spool-id="${id}"]`)
          row?.remove()
          const tbody = document.querySelector('#modal-content tbody')
          if (tbody && tbody.children.length === 0) {
            document.getElementById('modal-content')!.innerHTML = `<p style="color: var(--text-muted); text-align: center; padding: 20px;">${t('dashboard.noData')}</p>`
            document.getElementById('modal-footer')!.classList.add('hidden')
          }
          loadDashboardData()
        }
      } catch (err) {
        console.error('Failed to archive spool:', err)
        if (btn) { btn.disabled = false; btn.textContent = t('dashboard.archive') }
      }
    }
    (window as any).archiveSpool = archiveSpool

    async function archiveAll(ids: number[]) {
      if (!(await (window as any).__fmConfirm(t('dashboard.confirmArchiveAll'), { 
        okLabel: t('dashboard.archive'),
        isDanger: false 
      }))) return

      const bulkBtn = document.getElementById('btn-archive-all') as HTMLButtonElement
      bulkBtn.disabled = true
      bulkBtn.textContent = t('dashboard.archiving')

      try {
        const response = await fetch('/api/v1/spools/bulk/status', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': getCsrfToken() },
          credentials: 'include',
          body: JSON.stringify({ spool_ids: ids, status: 'archived' }),
        })

        if (response.ok) {
          (window as any).closeSpoolModal()
          loadDashboardData()
        }
      } catch (err) {
        console.error('Failed bulk archive:', err)
      } finally {
        bulkBtn.disabled = false
      }
    }
    (window as any).archiveAll = archiveAll

    ;(window as any).closeSpoolModal = function() {
      document.getElementById('spool-modal')!.classList.remove('open')
    }

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        (window as any).closeSpoolModal()
        closeCustomize()
      }
    })

    document.getElementById('spool-modal')?.addEventListener('click', (e) => {
      if (e.target === e.currentTarget) (window as any).closeSpoolModal()
    })

    async function loadDashboardData() {
      try {
        const [spoolsRes, filamentsRes, dashboardRes] = await Promise.all([
          fetch('/api/v1/spools?page_size=200', { credentials: 'include' }),
          fetch('/api/v1/filaments?page_size=200', { credentials: 'include' }),
          fetch('/api/v1/dashboard/stats?limit=20', { credentials: 'include' }),
        ])
        
        if (!spoolsRes.ok || !filamentsRes.ok) throw new Error('Failed to fetch data')
        
        const spoolsData = await spoolsRes.json()
        const filamentsData = await filamentsRes.json()
        const dashboardData = dashboardRes.ok ? await dashboardRes.json() : null
        
        allSpools = spoolsData.items
        allFilaments = filamentsData.items
        
        document.getElementById('stat-total-spools')!.textContent = spoolsData.total
        document.getElementById('stat-total-filaments')!.textContent = filamentsData.total
        
        if (dashboardData) {
          const dist = dashboardData.spool_distribution || { full: 0, normal: 0, low: 0, critical: 0, empty: 0 }
          document.getElementById('stat-low-spools')!.textContent = (dist.low + dist.critical).toString()
          document.getElementById('stat-empty-spools')!.textContent = dist.empty.toString()
          
          // Status bar chart
          const statusContainer = document.getElementById('spool-status')!
          const total = dist.full + dist.normal + dist.low + dist.critical + dist.empty
          const segments = [
            { label: t('dashboard.statusFull'), color: '#22c55e', count: dist.full },
            { label: t('dashboard.statusNormal'), color: '#3b82f6', count: dist.normal },
            { label: t('dashboard.statusLow'), color: '#eab308', count: dist.low },
            { label: t('dashboard.statusCritical'), color: '#ef4444', count: dist.critical },
            { label: t('dashboard.statusEmpty'), color: '#6b7280', count: dist.empty },
          ]
          
          if (total > 0) {
            statusContainer.innerHTML = `
              <div class="status-bar">
                ${segments.filter(s => s.count > 0).map(s => 
                  `<div class="status-segment" style="flex: ${s.count}; background: ${s.color};" title="${s.label}: ${s.count}">${s.count}</div>`
                ).join('')}
              </div>
              <div style="display: flex; gap: 14px; flex-wrap: wrap;">
                ${segments.map(s => `
                  <div style="display: flex; align-items: center; gap: 5px; font-size: 0.75rem;">
                    <span style="width: 8px; height: 8px; border-radius: 2px; background: ${s.color}; display: inline-block;"></span>
                    <span style="color: var(--text-muted);">${s.label}</span>
                    <span style="font-weight: 600;">${s.count}</span>
                  </div>
                `).join('')}
              </div>
            `
          } else {
            statusContainer.innerHTML = `<p style="color: var(--text-muted); font-size: 0.85rem;">${t('dashboard.noData')}</p>`
          }

          // Location stats
          const locationStatsContainer = document.getElementById('location-stats')!
          if (!dashboardData.location_stats || dashboardData.location_stats.length === 0) {
            locationStatsContainer.innerHTML = `<p style="color: var(--text-muted); font-size: 0.85rem;">${t('dashboard.noData')}</p>`
          } else {
            locationStatsContainer.innerHTML = `<table class="fm-table" style="font-size: 0.8rem;">
              <thead><tr>
                <th style="padding: 6px 8px;">${t('locations.name') || 'Location'}</th>
                <th style="padding: 6px 8px; text-align: right;">${t('dashboard.spools')}</th>
                <th style="padding: 6px 8px; text-align: right;">${t('dashboard.remaining')}</th>
              </tr></thead>
              <tbody>` + 
              dashboardData.location_stats.map((l: any) => 
                `<tr style="cursor: pointer;" onclick="window.location.href='/spools?location_id=${l.location_id}'">
                  <td style="padding: 6px 8px;">${l.location_name}</td>
                  <td style="padding: 6px 8px; text-align: right; font-family: var(--font-mono);">${l.spool_count}</td>
                  <td style="padding: 6px 8px; text-align: right; font-family: var(--font-mono);">${formatWeight(l.total_weight_g)}</td>
                </tr>`
              ).join('') +
              `</tbody></table>`
          }

          // Filament stats
          const filamentStatsContainer = document.getElementById('filament-stats')!
          if (!dashboardData.filament_stats || dashboardData.filament_stats.length === 0) {
            filamentStatsContainer.innerHTML = `<p style="color: var(--text-muted); font-size: 0.85rem;">${t('dashboard.noData')}</p>`
          } else {
            filamentStatsContainer.innerHTML = `<table class="fm-table" style="font-size: 0.8rem;">
              <thead><tr>
                <th style="padding: 6px 8px;">${t('dashboard.filament')}</th>
                <th style="padding: 6px 8px; text-align: right;">${t('dashboard.spools')}</th>
                <th style="padding: 6px 8px; text-align: right;">${t('dashboard.remaining')}</th>
              </tr></thead>
              <tbody>` + 
              dashboardData.filament_stats.map((f: any) => 
                `<tr style="cursor: pointer;" onclick="window.location.href='/spools?material=${encodeURIComponent(f.filament_type)}'">
                  <td style="padding: 6px 8px;">${f.filament_type}</td>
                  <td style="padding: 6px 8px; text-align: right; font-family: var(--font-mono);">${f.spool_count}</td>
                  <td style="padding: 6px 8px; text-align: right; font-family: var(--font-mono);">${formatWeight(f.total_weight_g)}</td>
                </tr>`
              ).join('') +
              `</tbody></table>`
          }

          // Manufacturers
          const mfrContainer = document.getElementById('manufacturers-with-spools')!
          if (dashboardData.manufacturers_with_spools.length === 0) {
            mfrContainer.innerHTML = `<p style="color: var(--text-muted); font-size: 0.85rem;">${t('dashboard.noData')}</p>`
          } else {
            mfrContainer.innerHTML = `<table class="fm-table" style="font-size: 0.8rem;"><tbody>` + 
              dashboardData.manufacturers_with_spools.map((m: any) => 
                `<tr style="cursor: pointer;" onclick="window.location.href='/spools?manufacturer_id=${m.id}'"><td style="padding: 6px 8px;">${m.name}</td><td style="padding: 6px 8px; text-align: right; font-family: var(--font-mono);">${m.spool_count}</td></tr>`
              ).join('') +
              `</tbody></table>`
          }

          // Low stock
          const mfrLowStockContainer = document.getElementById('low-stock-spools')!
          if (dashboardData.low_stock_spools.length === 0) {
            mfrLowStockContainer.innerHTML = `<p style="color: var(--accent); font-size: 0.85rem;">${t('dashboard.allSufficient')}</p>`
          } else {
            mfrLowStockContainer.innerHTML = `<table class="fm-table" style="font-size: 0.8rem;">
              <thead><tr>
                <th style="padding: 6px 8px;">${t('dashboard.spool')}</th>
                <th style="padding: 6px 8px;">${t('dashboard.filament')}</th>
                <th style="padding: 6px 8px; text-align: right;">${t('dashboard.remaining')}</th>
              </tr></thead>
              <tbody>` + 
              dashboardData.low_stock_spools.map((s: any) => 
                `<tr style="cursor: pointer;" onclick="window.location.href='/spools/${s.spool_id}'">
                  <td style="padding: 6px 8px;">#${s.spool_id}</td>
                  <td style="padding: 6px 8px;">${s.filament_designation}</td>
                  <td style="padding: 6px 8px; text-align: right; font-family: var(--font-mono); color: var(--accent-3);">${s.remaining_weight_g.toFixed(0)}g</td>
                </tr>`
              ).join('') +
              `</tbody></table>`
          }

          // Filament types
          const typesContainer = document.getElementById('filament-types')!
          if (dashboardData.filament_types.length === 0) {
            typesContainer.innerHTML = `<p style="color: var(--text-muted); font-size: 0.85rem;">${t('dashboard.noData')}</p>`
          } else {
            typesContainer.innerHTML = `<table class="fm-table" style="font-size: 0.8rem;"><tbody>` + 
              dashboardData.filament_types.map((t: any) => 
                `<tr style="cursor: pointer;" onclick="window.location.href='/spools?material=${encodeURIComponent(t.type)}'"><td style="padding: 6px 8px;">${t.type}</td><td style="padding: 6px 8px; text-align: right; font-family: var(--font-mono);">${t.count}</td></tr>`
              ).join('') +
              `</tbody></table>`
          }
        }
      } catch (error) {
        console.error('Failed to load dashboard:', error)
      }
    }

    async function init() {
      await initI18n()

      // Translate widget names
      WIDGET_NAMES['spool-status'] = t('dashboard.spoolStatus')
      WIDGET_NAMES['low-stock'] = t('dashboard.lowStockSpools')
      WIDGET_NAMES['manufacturers'] = t('dashboard.manufacturersWithSpools')
      WIDGET_NAMES['filament-types'] = t('dashboard.filamentTypes')
      WIDGET_NAMES['location-stats'] = t('dashboard.locationStats')
      WIDGET_NAMES['filament-stats'] = t('dashboard.filamentStats')

      applyWidgetVisibility()
      await loadDashboardData()
    }
    init()
  </script>
</Layout>
