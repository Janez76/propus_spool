---
import Layout from '../layouts/Layout.astro'

interface Spool {
  id: number
  filament_id: number
  status_id: number
  remaining_weight_g: number | null
  low_weight_threshold_g: number
  lot_number: string | null
  rfid_uid: string | null
  external_id: string | null
}

interface Filament {
  id: number
  designation: string
  type: string
  manufacturer_id: number
}

interface Status {
  id: number
  key: string
  label: string
}

interface SpoolWithFilament extends Spool {
  filament?: Filament
  status?: Status
}

interface PaginatedResponse<T> {
  items: T[]
  total: number
  page: number
  page_size: number
}
---

<Layout title="Propus Spool - Dashboard">
  <style>
    .db-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 12px;
    }
    .db-header h1 {
      font-size: 1.5rem;
      font-weight: 700;
      margin: 0;
    }
    @media (max-width: 480px) {
      .db-header h1 { font-size: 1.2rem; }
      .db-header { margin-bottom: 14px; }
    }
    .db-customize-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background: var(--bg-soft);
      color: var(--text-muted);
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      transition: all var(--transition);
      font-family: var(--font-sans);
    }
    .db-customize-btn:hover { color: var(--accent); border-color: var(--accent); }

    .stat-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 10px;
      margin-bottom: 20px;
    }
    @media (max-width: 480px) {
      .stat-grid { grid-template-columns: repeat(2, 1fr); gap: 8px; }
      .stat-card { padding: 12px; gap: 10px; }
      .stat-icon { width: 34px; height: 34px; }
      .stat-value { font-size: 1.2rem; }
    }
    .stat-card {
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: 16px;
      display: flex;
      align-items: center;
      gap: 14px;
      cursor: pointer;
      transition: all var(--transition);
    }
    .stat-card:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-sm);
    }
    .stat-icon {
      width: 40px;
      height: 40px;
      border-radius: var(--radius-sm);
      display: grid;
      place-items: center;
      flex-shrink: 0;
    }
    .stat-icon svg { width: 20px; height: 20px; }
    .stat-value { font-size: 1.4rem; font-weight: 700; line-height: 1; }
    .stat-label { font-size: 0.75rem; color: var(--text-muted); margin-top: 2px; }

    .widget-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 14px;
      align-items: start;
    }
    @media (max-width: 680px) {
      .widget-grid { grid-template-columns: 1fr; gap: 12px; }
    }
    .widget {
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      overflow: visible;
      transition: all 0.2s ease;
    }
    .widget.hidden-widget { display: none; }
    .widget.drag-over {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(0, 212, 170, 0.2);
    }
    .widget.dragging {
      opacity: 0.5;
      transform: scale(0.98);
    }
    .widget-header {
      padding: 14px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--border-subtle);
      cursor: grab;
    }
    .widget-header:active { cursor: grabbing; }
    .widget-title {
      font-weight: 600;
      font-size: 0.875rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .widget-title .dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      display: inline-block;
    }
    .drag-handle {
      color: var(--text-muted);
      opacity: 0.4;
      transition: opacity var(--transition);
      flex-shrink: 0;
    }
    .widget-header:hover .drag-handle { opacity: 0.8; }
    .widget-body {
      padding: 12px 16px;
      max-height: 320px;
      overflow-y: auto;
      overflow-x: auto;
    }
    .widget[data-widget="spool-status"] .widget-body {
      max-height: none;
      overflow: visible;
    }

    .customize-panel {
      position: fixed;
      top: 0;
      right: -360px;
      width: 340px;
      height: 100vh;
      background: var(--bg-elevated);
      border-left: 1px solid var(--border);
      z-index: 9998;
      transition: right 300ms cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      flex-direction: column;
      box-shadow: var(--shadow-lg);
    }
    .customize-panel.open { right: 0; }
    @media (max-width: 480px) {
      .customize-panel { width: calc(100vw - 40px); right: calc(-100vw + 40px); }
    }
    .customize-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.4);
      z-index: 9997;
      opacity: 0;
      pointer-events: none;
      transition: opacity 200ms ease;
    }
    .customize-backdrop.open { opacity: 1; pointer-events: auto; }
    .customize-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .customize-header h3 { margin: 0; font-size: 1rem; font-weight: 600; }
    .customize-list { padding: 12px 20px; flex: 1; overflow-y: auto; }
    .customize-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid var(--border-subtle);
    }
    .customize-item-label { font-size: 0.85rem; font-weight: 500; }

    .spool-chart-wrap {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .spool-donut {
      position: relative;
      width: 80px;
      height: 80px;
      flex-shrink: 0;
    }
    .spool-donut svg { width: 100%; height: 100%; display: block; }
    .spool-donut-segment {
      transition: opacity 0.2s ease, filter 0.2s ease;
      cursor: pointer;
    }
    .spool-donut-segment:hover { filter: brightness(1.25); }
    .spool-donut.has-hover .spool-donut-segment:not(.active) { opacity: 0.3; }
    .spool-donut-center {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      pointer-events: none;
    }
    .spool-donut-total {
      font-size: 1rem;
      font-weight: 800;
      line-height: 1;
      transition: color 0.15s ease;
    }
    .spool-donut-sublabel {
      font-size: 0.45rem;
      color: var(--text-muted);
      margin-top: 1px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    .spool-legend {
      display: flex;
      flex-direction: column;
      gap: 0;
      flex: 1;
      min-width: 0;
    }
    .spool-legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 4px 4px;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.15s ease;
    }
    .spool-legend-item:hover { background: var(--bg-soft); }
    .spool-legend-item.active { background: var(--bg-soft); }
    .spool-legend-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .spool-legend-label {
      flex: 1;
      font-size: 0.72rem;
      font-weight: 500;
      color: var(--text);
      line-height: 1;
    }
    .spool-legend-count {
      font-size: 0.72rem;
      font-weight: 700;
      min-width: 14px;
      text-align: right;
    }
    .spool-legend-pct {
      font-size: 0.6rem;
      color: var(--text-muted);
      min-width: 24px;
      text-align: right;
    }

    .weight-progress {
      height: 8px;
      background: var(--bg-soft);
      border-radius: 4px;
      overflow: hidden;
      margin-top: 6px;
    }
    .weight-progress-fill {
      height: 100%;
      border-radius: 4px;
      background: linear-gradient(90deg, var(--accent), var(--accent-2));
      transition: width 0.5s ease;
    }

    .color-row {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 6px 4px;
      border-radius: 6px;
      transition: background 0.15s;
      cursor: default;
    }
    .color-row:hover { background: var(--bg-soft); }
    .color-swatch {
      width: 28px;
      height: 28px;
      border-radius: 8px;
      border: 2px solid rgba(255,255,255,0.1);
      flex-shrink: 0;
      box-shadow: 0 1px 4px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.15);
    }
    .color-info {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 3px;
    }
    .color-info-top {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .color-name {
      font-weight: 600;
      font-size: 0.78rem;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .color-hex {
      font-family: var(--font-mono);
      font-size: 0.58rem;
      color: var(--text-muted);
      background: var(--bg-soft);
      padding: 1px 5px;
      border-radius: 4px;
      flex-shrink: 0;
    }
    .color-count {
      font-size: 0.72rem;
      font-weight: 700;
      color: var(--text-muted);
      flex-shrink: 0;
      text-align: right;
      min-width: 22px;
    }
    .color-bar {
      height: 4px;
      background: var(--bg-soft);
      border-radius: 2px;
      overflow: hidden;
    }
    .color-bar-fill {
      height: 100%;
      border-radius: 2px;
      transition: width 0.5s ease;
      opacity: 0.8;
    }

    /* Shared widget list item styles */
    .wg-row {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 4px;
      border-bottom: 1px solid var(--border-subtle);
      font-size: 0.82rem;
      cursor: pointer;
      transition: background 0.15s;
      border-radius: var(--radius-sm);
    }
    .wg-row:last-child { border-bottom: none; }
    .wg-row:hover { background: var(--bg-soft); }
    .wg-icon {
      width: 32px; height: 32px;
      border-radius: var(--radius-sm);
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0;
      font-size: 0.9rem;
    }
    .wg-info { flex: 1; min-width: 0; }
    .wg-name {
      font-weight: 600;
      overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    .wg-sub {
      font-size: 0.7rem;
      color: var(--text-muted);
    }
    .wg-val {
      font-family: var(--font-mono);
      font-weight: 600;
      font-size: 0.82rem;
      flex-shrink: 0;
    }

    .event-row {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 7px 0;
      border-bottom: 1px solid var(--border-subtle);
      font-size: 0.8rem;
    }
    .event-row:last-child { border-bottom: none; }
    .event-icon {
      width: 28px;
      height: 28px;
      border-radius: 6px;
      display: grid;
      place-items: center;
      flex-shrink: 0;
      font-size: 0.75rem;
    }
    .event-time {
      font-size: 0.7rem;
      color: var(--text-muted);
      white-space: nowrap;
    }

    .pm-card { padding: 0; }
    .pm-card-active { cursor: pointer; }
    .pm-head {
      display: flex; align-items: center; gap: 6px;
      margin-bottom: 6px;
    }
    .pm-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
    .pm-badge {
      font-size: 0.55rem; font-weight: 700; padding: 1px 6px;
      border-radius: 8px; text-transform: uppercase; letter-spacing: 0.03em;
    }
    .pm-badge.printing { background: rgba(16,185,129,.15); color: #10b981; }
    .pm-badge.idle { background: rgba(107,114,128,.15); color: #6b7280; }
    .pm-badge.paused { background: rgba(251,191,36,.15); color: #eab308; }
    .pm-badge.error { background: rgba(239,68,68,.15); color: #ef4444; }
    .pm-badge.preparing { background: rgba(56,189,248,.15); color: #38bdf8; }
    .pm-badge.offline { background: rgba(107,114,128,.1); color: #4b5563; }
    .pm-body { display: flex; gap: 8px; }
    .pm-cam {
      width: 80px; height: 56px;
      border-radius: var(--radius-sm);
      object-fit: cover; background: #0a0a0a;
      border: 1px solid var(--border-subtle); flex-shrink: 0;
    }
    .pm-info { flex: 1; min-width: 0; }
    .pm-job {
      font-size: 0.7rem; font-weight: 500;
      overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
      margin-bottom: 4px;
    }
    .pm-bar-wrap { margin-bottom: 3px; }
    .pm-bar {
      height: 4px; background: var(--bg); border-radius: 2px; overflow: hidden;
    }
    .pm-bar-fill {
      height: 100%; border-radius: 2px;
      background: linear-gradient(90deg, #3b82f6, #60a5fa);
      transition: width 0.5s;
    }
    .pm-bar-text {
      display: flex; justify-content: space-between;
      font-size: 0.6rem; color: var(--text-muted); margin-top: 1px;
    }
    .pm-stats {
      display: flex; gap: 8px; font-size: 0.65rem; flex-wrap: wrap;
    }
    .pm-stat {
      display: flex; align-items: center; gap: 2px;
      font-family: var(--font-mono);
    }
    .pm-stat-muted { color: var(--text-muted); }
    .pm-idle-text {
      font-size: 0.68rem; color: var(--text-muted);
      display: flex; align-items: center; gap: 4px;
    }
  </style>

  <!-- Header -->
  <div class="db-header">
    <h1 data-i18n="dashboard.title">Dashboard</h1>
    <button class="db-customize-btn" id="btn-customize">
      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
      <span data-i18n="dashboard.customize">Customize</span>
    </button>
  </div>

  <!-- Stats -->
  <div class="stat-grid">
    <div class="stat-card" onclick="window.location.href='/spools'">
      <div class="stat-icon" style="background: rgba(0, 212, 170, 0.1);">
        <svg style="fill: var(--accent);"><use href="/icons.svg#icon-spools"></use></svg>
      </div>
      <div>
        <div class="stat-value" id="stat-total-spools">-</div>
        <div class="stat-label" data-i18n="dashboard.totalSpools">Total Spools</div>
      </div>
    </div>
    <div class="stat-card" onclick="window.location.href='/filaments'">
      <div class="stat-icon" style="background: rgba(56, 189, 248, 0.1);">
        <svg style="fill: var(--accent-2);"><use href="/icons.svg#icon-filaments"></use></svg>
      </div>
      <div>
        <div class="stat-value" id="stat-total-filaments">-</div>
        <div class="stat-label" data-i18n="dashboard.filaments">Filaments</div>
      </div>
    </div>
    <div class="stat-card" onclick="openSpoolModal('low')">
      <div class="stat-icon" style="background: rgba(251, 191, 36, 0.1);">
        <svg style="fill: var(--accent-3);"><use href="/icons.svg#icon-spools"></use></svg>
      </div>
      <div>
        <div class="stat-value" id="stat-low-spools">-</div>
        <div class="stat-label" data-i18n="dashboard.lowSpools">Low Spools</div>
      </div>
    </div>
    <div class="stat-card" onclick="openSpoolModal('empty')">
      <div class="stat-icon" style="background: rgba(239, 68, 68, 0.1);">
        <svg style="fill: var(--error-text);"><use href="/icons.svg#icon-spools"></use></svg>
      </div>
      <div>
        <div class="stat-value" id="stat-empty-spools">-</div>
        <div class="stat-label" data-i18n="dashboard.emptySpools">Empty Spools</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon" style="background: rgba(168, 85, 247, 0.1);">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#a855f7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.24 12.24a6 6 0 0 0-8.49-8.49L5 10.5V19h8.5z"/><line x1="16" y1="8" x2="2" y2="22"/><line x1="17.5" y1="15" x2="9" y2="15"/></svg>
      </div>
      <div>
        <div class="stat-value" id="stat-total-weight">-</div>
        <div class="stat-label" data-i18n="dashboard.totalWeight">Total Weight</div>
      </div>
    </div>
  </div>

  <!-- Widgets -->
  <div class="widget-grid" id="widget-grid">
    <div class="widget" data-widget="spool-status" draggable="true">
      <div class="widget-header">
        <div class="widget-title"><span class="dot" style="background: var(--accent);"></span> <span data-i18n="dashboard.spoolStatus">Spool Status</span></div>
        <svg class="drag-handle" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="5" r="1"/><circle cx="9" cy="12" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="19" r="1"/></svg>
      </div>
      <div class="widget-body" id="spool-status">
        <p style="color: var(--text-muted); font-size: 0.85rem;" data-i18n="common.loading">Loading...</p>
      </div>
    </div>

    <div class="widget" data-widget="total-weight" draggable="true">
      <div class="widget-header">
        <div class="widget-title"><span class="dot" style="background: #a855f7;"></span> <span data-i18n="dashboard.weightOverview">Weight Overview</span></div>
        <svg class="drag-handle" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="5" r="1"/><circle cx="9" cy="12" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="19" r="1"/></svg>
      </div>
      <div class="widget-body" id="total-weight">
        <p style="color: var(--text-muted); font-size: 0.85rem;" data-i18n="common.loading">Loading...</p>
      </div>
    </div>

    <div class="widget" data-widget="low-stock" draggable="true">
      <div class="widget-header">
        <div class="widget-title"><span class="dot" style="background: var(--accent-3);"></span> <span data-i18n="dashboard.lowStockSpools">Low Stock</span></div>
        <svg class="drag-handle" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="5" r="1"/><circle cx="9" cy="12" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="19" r="1"/></svg>
      </div>
      <div class="widget-body" id="low-stock-spools">
        <p style="color: var(--text-muted); font-size: 0.85rem;" data-i18n="common.loading">Loading...</p>
      </div>
    </div>

    <div class="widget" data-widget="color-distribution" draggable="true">
      <div class="widget-header">
        <div class="widget-title"><span class="dot" style="background: #ec4899;"></span> <span data-i18n="dashboard.colorDistribution">Color Distribution</span></div>
        <svg class="drag-handle" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="5" r="1"/><circle cx="9" cy="12" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="19" r="1"/></svg>
      </div>
      <div class="widget-body" id="color-distribution">
        <p style="color: var(--text-muted); font-size: 0.85rem;" data-i18n="common.loading">Loading...</p>
      </div>
    </div>

    <div class="widget" data-widget="recent-activity" draggable="true">
      <div class="widget-header">
        <div class="widget-title"><span class="dot" style="background: #06b6d4;"></span> <span data-i18n="dashboard.recentActivity">Recent Activity</span></div>
        <svg class="drag-handle" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="5" r="1"/><circle cx="9" cy="12" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="19" r="1"/></svg>
      </div>
      <div class="widget-body" id="recent-activity">
        <p style="color: var(--text-muted); font-size: 0.85rem;" data-i18n="common.loading">Loading...</p>
      </div>
    </div>

    <!-- Drucker-Widgets werden dynamisch per JS eingefÃ¼gt -->

    <div class="widget" data-widget="manufacturers" draggable="true">
      <div class="widget-header">
        <div class="widget-title"><span class="dot" style="background: var(--accent-2);"></span> <span data-i18n="dashboard.manufacturersWithSpools">Manufacturers</span></div>
        <svg class="drag-handle" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="5" r="1"/><circle cx="9" cy="12" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="19" r="1"/></svg>
      </div>
      <div class="widget-body" id="manufacturers-with-spools">
        <p style="color: var(--text-muted); font-size: 0.85rem;" data-i18n="common.loading">Loading...</p>
      </div>
    </div>

    <div class="widget" data-widget="filament-types" draggable="true">
      <div class="widget-header">
        <div class="widget-title"><span class="dot" style="background: #a78bfa;"></span> <span data-i18n="dashboard.filamentTypes">Filament Types</span></div>
        <svg class="drag-handle" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="5" r="1"/><circle cx="9" cy="12" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="19" r="1"/></svg>
      </div>
      <div class="widget-body" id="filament-types">
        <p style="color: var(--text-muted); font-size: 0.85rem;" data-i18n="common.loading">Loading...</p>
      </div>
    </div>

    <div class="widget" data-widget="location-stats" draggable="true">
      <div class="widget-header">
        <div class="widget-title"><span class="dot" style="background: #f472b6;"></span> <span data-i18n="dashboard.locationStats">Locations</span></div>
        <svg class="drag-handle" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="5" r="1"/><circle cx="9" cy="12" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="19" r="1"/></svg>
      </div>
      <div class="widget-body" id="location-stats">
        <p style="color: var(--text-muted); font-size: 0.85rem;" data-i18n="common.loading">Loading...</p>
      </div>
    </div>

    <div class="widget" data-widget="filament-stats" draggable="true">
      <div class="widget-header">
        <div class="widget-title"><span class="dot" style="background: #fb923c;"></span> <span data-i18n="dashboard.filamentStats">Filament Stats</span></div>
        <svg class="drag-handle" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="5" r="1"/><circle cx="9" cy="12" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="19" r="1"/></svg>
      </div>
      <div class="widget-body" id="filament-stats">
        <p style="color: var(--text-muted); font-size: 0.85rem;" data-i18n="common.loading">Loading...</p>
      </div>
    </div>
  </div>

  <!-- Customize Panel -->
  <div class="customize-backdrop" id="customize-backdrop"></div>
  <div class="customize-panel" id="customize-panel">
    <div class="customize-header">
      <h3 data-i18n="dashboard.customizeWidgets">Widgets</h3>
      <button id="close-customize" style="background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 4px;">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="customize-list" id="customize-list"></div>
  </div>

  <!-- Spool Modal -->
  <div id="spool-modal" class="fm-modal-overlay">
    <div class="fm-modal" style="max-width: 700px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px;">
        <h2 id="modal-title" style="margin: 0; font-weight: 600; font-size: 1rem;">Spulen</h2>
        <button onclick="closeSpoolModal()" style="background: none; border: none; font-size: 1.1rem; cursor: pointer; padding: 4px 8px; color: var(--text-muted);">âœ•</button>
      </div>
      <div id="modal-content" style="max-height: 60vh; overflow-y: auto;">
        <p style="color: var(--text-muted);">Loading...</p>
      </div>
      <div id="modal-footer" style="margin-top: 14px; border-top: 1px solid var(--border); padding-top: 14px;" class="hidden">
        <button id="btn-archive-all" class="fm-btn fm-btn-warning" style="width: 100%;"></button>
      </div>
    </div>
  </div>

  <script>
    import { t, initI18n } from '../lib/i18n'

    let allSpools: any[] = []
    let allFilaments: any[] = []

    const DEFAULT_WIDGET_ORDER = [
      'spool-status', 'total-weight', 'low-stock', 'color-distribution',
      'recent-activity', 'manufacturers', 'filament-types',
      'location-stats', 'filament-stats'
    ]

    const WIDGET_NAMES: Record<string, string> = {
      'spool-status': 'Spool Status',
      'total-weight': 'Weight Overview',
      'low-stock': 'Low Stock',
      'color-distribution': 'Color Distribution',
      'recent-activity': 'Recent Activity',
      'manufacturers': 'Manufacturers',
      'filament-types': 'Filament Types',
      'location-stats': 'Locations',
      'filament-stats': 'Filament Stats',
    }

    // â”€â”€ Widget visibility â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function getWidgetVisibility(): Record<string, boolean> {
      try {
        const stored = localStorage.getItem('dashboard-widgets')
        if (stored) return JSON.parse(stored)
      } catch {}
      return Object.fromEntries(Object.keys(WIDGET_NAMES).map(k => [k, true]))
    }

    function saveWidgetVisibility(vis: Record<string, boolean>) {
      localStorage.setItem('dashboard-widgets', JSON.stringify(vis))
    }

    function applyWidgetVisibility() {
      const vis = getWidgetVisibility()
      document.querySelectorAll('[data-widget]').forEach(el => {
        const key = el.getAttribute('data-widget')!
        if (vis[key] === false) {
          el.classList.add('hidden-widget')
        } else {
          el.classList.remove('hidden-widget')
        }
      })
    }

    // â”€â”€ Widget order (drag & drop) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function getWidgetOrder(): string[] {
      try {
        const stored = localStorage.getItem('dashboard-widget-order')
        if (stored) {
          const order = JSON.parse(stored) as string[]
          const allWidgetKeys = [...DEFAULT_WIDGET_ORDER, ...Object.keys(WIDGET_NAMES).filter(k => k.startsWith('printer-'))]
          const allKeys = new Set(allWidgetKeys)
          const existing = order.filter(k => allKeys.has(k))
          const missing = allWidgetKeys.filter(k => !existing.includes(k))
          return [...existing, ...missing]
        }
      } catch {}
      return [...DEFAULT_WIDGET_ORDER, ...Object.keys(WIDGET_NAMES).filter(k => k.startsWith('printer-'))]
    }

    function saveWidgetOrder(order: string[]) {
      localStorage.setItem('dashboard-widget-order', JSON.stringify(order))
    }

    function applyWidgetOrder() {
      const grid = document.getElementById('widget-grid')!
      const order = getWidgetOrder()
      const widgets = new Map<string, Element>()
      grid.querySelectorAll('[data-widget]').forEach(el => {
        widgets.set(el.getAttribute('data-widget')!, el)
      })
      order.forEach(key => {
        const w = widgets.get(key)
        if (w) grid.appendChild(w)
      })
    }

    // â”€â”€ Drag & Drop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let draggedWidget: HTMLElement | null = null

    function setupDragAndDrop() {
      const grid = document.getElementById('widget-grid')!

      grid.querySelectorAll('.widget[draggable="true"]').forEach(widget => {
        const el = widget as HTMLElement

        el.addEventListener('dragstart', (e: DragEvent) => {
          draggedWidget = el
          el.classList.add('dragging')
          e.dataTransfer!.effectAllowed = 'move'
          e.dataTransfer!.setData('text/plain', el.dataset.widget || '')
        })

        el.addEventListener('dragend', () => {
          el.classList.remove('dragging')
          grid.querySelectorAll('.widget').forEach(w => w.classList.remove('drag-over'))
          draggedWidget = null
          const newOrder = Array.from(grid.querySelectorAll('[data-widget]')).map(
            w => w.getAttribute('data-widget')!
          )
          saveWidgetOrder(newOrder)
        })

        el.addEventListener('dragover', (e: DragEvent) => {
          e.preventDefault()
          e.dataTransfer!.dropEffect = 'move'
          if (draggedWidget && draggedWidget !== el) {
            el.classList.add('drag-over')
          }
        })

        el.addEventListener('dragleave', () => {
          el.classList.remove('drag-over')
        })

        el.addEventListener('drop', (e: DragEvent) => {
          e.preventDefault()
          el.classList.remove('drag-over')
          if (!draggedWidget || draggedWidget === el) return

          const allWidgets = Array.from(grid.querySelectorAll('.widget[data-widget]'))
          const dragIdx = allWidgets.indexOf(draggedWidget)
          const dropIdx = allWidgets.indexOf(el)

          if (dragIdx < dropIdx) {
            el.parentNode!.insertBefore(draggedWidget, el.nextSibling)
          } else {
            el.parentNode!.insertBefore(draggedWidget, el)
          }
        })
      })
    }

    // â”€â”€ Customize panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderCustomizeList() {
      const vis = getWidgetVisibility()
      const order = getWidgetOrder()
      const container = document.getElementById('customize-list')!
      container.innerHTML = order.map(key => {
        const name = WIDGET_NAMES[key] || key
        const isOn = vis[key] !== false
        return `
          <div class="customize-item">
            <span class="customize-item-label">${name}</span>
            <div class="fm-widget-toggle ${isOn ? 'active' : ''}" data-toggle-key="${key}"></div>
          </div>
        `
      }).join('')

      container.querySelectorAll('.fm-widget-toggle').forEach(toggle => {
        toggle.addEventListener('click', () => {
          const key = toggle.getAttribute('data-toggle-key')!
          const vis = getWidgetVisibility()
          vis[key] = !(vis[key] !== false)
          saveWidgetVisibility(vis)
          toggle.classList.toggle('active')
          applyWidgetVisibility()
        })
      })
    }

    const btnCustomize = document.getElementById('btn-customize')!
    const panel = document.getElementById('customize-panel')!
    const backdrop = document.getElementById('customize-backdrop')!
    const closeBtn = document.getElementById('close-customize')!

    function openCustomize() {
      renderCustomizeList()
      panel.classList.add('open')
      backdrop.classList.add('open')
    }
    function closeCustomize() {
      panel.classList.remove('open')
      backdrop.classList.remove('open')
    }
    btnCustomize.addEventListener('click', openCustomize)
    closeBtn.addEventListener('click', closeCustomize)
    backdrop.addEventListener('click', closeCustomize)

    // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function getFilamentName(filamentId: number): string {
      const f = allFilaments.find(fil => fil.id === filamentId)
      if (!f) return '-'
      return `${f.designation} (${f.type || '-'})`
    }

    function formatWeight(g: number): string {
      if (g >= 1000000) return (g / 1000000).toFixed(1) + ' t'
      if (g >= 1000) return (g / 1000).toFixed(1) + ' kg'
      return g.toFixed(0) + ' g'
    }

    function getCsrfToken(): string {
      const match = document.cookie.match(/(?:^|;\s*)csrf_token=([^;]*)/)
      return match ? decodeURIComponent(match[1]) : ''
    }

    function timeAgo(dateStr: string): string {
      const now = new Date()
      const then = new Date(dateStr)
      const diff = Math.floor((now.getTime() - then.getTime()) / 1000)
      if (diff < 60) return `${diff}s`
      if (diff < 3600) return `${Math.floor(diff / 60)}m`
      if (diff < 86400) return `${Math.floor(diff / 3600)}h`
      return `${Math.floor(diff / 86400)}d`
    }

    const EVENT_ICONS: Record<string, { icon: string; bg: string }> = {
      weigh: { icon: 'âš–', bg: 'rgba(56, 189, 248, 0.15)' },
      status_change: { icon: 'ðŸ”„', bg: 'rgba(168, 85, 247, 0.15)' },
      location_change: { icon: 'ðŸ“', bg: 'rgba(244, 114, 182, 0.15)' },
      adjust: { icon: 'âœ', bg: 'rgba(251, 191, 36, 0.15)' },
      create: { icon: 'âœš', bg: 'rgba(0, 212, 170, 0.15)' },
    };

    ;(window as any).openSpoolModal = function(type: 'low' | 'empty') {
      const modal = document.getElementById('spool-modal') as HTMLElement
      const title = document.getElementById('modal-title') as HTMLElement
      const content = document.getElementById('modal-content') as HTMLElement
      const footer = document.getElementById('modal-footer') as HTMLElement
      const bulkBtn = document.getElementById('btn-archive-all') as HTMLButtonElement

      let filteredSpools: any[] = []
      
      if (type === 'low') {
        title.textContent = t('dashboard.lowSpools')
        filteredSpools = allSpools.filter(s => 
          s.remaining_weight_g !== null && 
          s.remaining_weight_g <= s.low_weight_threshold_g &&
          s.remaining_weight_g > 0
        )
      } else {
        title.textContent = t('dashboard.emptySpools')
        filteredSpools = allSpools.filter(s => 
          s.remaining_weight_g !== null && 
          s.remaining_weight_g <= 0
        )
      }

      if (filteredSpools.length === 0) {
        content.innerHTML = `<p style="color: var(--text-muted); text-align: center; padding: 20px;">${t('dashboard.noData')}</p>`
        footer.classList.add('hidden')
      } else {
        content.innerHTML = `
          <table class="fm-table">
            <thead>
              <tr>
                <th style="padding: 8px;">ID</th>
                <th style="padding: 8px;">${t('dashboard.filament')}</th>
                <th style="padding: 8px; text-align: right;">${t('dashboard.remaining')}</th>
                <th style="padding: 8px; text-align: right;">${t('common.actions')}</th>
              </tr>
            </thead>
            <tbody>
              ${filteredSpools.map(s => `
                <tr data-spool-id="${s.id}">
                  <td style="padding: 8px; cursor: pointer;" onclick="window.location.href='/spools/${s.id}'">#${s.id}</td>
                  <td style="padding: 8px; cursor: pointer;" onclick="window.location.href='/spools/${s.id}'">${getFilamentName(s.filament_id)}</td>
                  <td style="padding: 8px; text-align: right; font-family: var(--font-mono); cursor: pointer;" onclick="window.location.href='/spools/${s.id}'">${s.remaining_weight_g?.toFixed(0)}g</td>
                  <td style="padding: 8px; text-align: right;">
                    <button class="fm-btn fm-btn-outline" style="padding: 4px 10px; font-size: 0.75rem;" onclick="archiveSpool(${s.id})">
                      ${t('dashboard.archive')}
                    </button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `
        
        footer.classList.remove('hidden')
        bulkBtn.textContent = type === 'low' ? t('dashboard.archiveAllLow') : t('dashboard.archiveAllEmpty')
        bulkBtn.onclick = () => archiveAll(filteredSpools.map(s => s.id))
      }

      modal.classList.add('open')
    }

    async function archiveSpool(id: number) {
      if (!(await (window as any).__fmConfirm(t('dashboard.confirmArchiveOne') || t('dashboard.archive') + '?', {
        okLabel: t('dashboard.archive'),
        isDanger: false
      }))) return

      const btn = document.querySelector(`tr[data-spool-id="${id}"] button`) as HTMLButtonElement
      if (btn) { btn.disabled = true; btn.textContent = '...' }

      try {
        const response = await fetch(`/api/v1/spools/${id}/status`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': getCsrfToken() },
          credentials: 'include',
          body: JSON.stringify({ status: 'archived' }),
        })

        if (response.ok) {
          const row = document.querySelector(`tr[data-spool-id="${id}"]`)
          row?.remove()
          const tbody = document.querySelector('#modal-content tbody')
          if (tbody && tbody.children.length === 0) {
            document.getElementById('modal-content')!.innerHTML = `<p style="color: var(--text-muted); text-align: center; padding: 20px;">${t('dashboard.noData')}</p>`
            document.getElementById('modal-footer')!.classList.add('hidden')
          }
          loadDashboardData()
        }
      } catch (err) {
        console.error('Failed to archive spool:', err)
        if (btn) { btn.disabled = false; btn.textContent = t('dashboard.archive') }
      }
    }
    ;(window as any).archiveSpool = archiveSpool

    async function archiveAll(ids: number[]) {
      if (!(await (window as any).__fmConfirm(t('dashboard.confirmArchiveAll'), { 
        okLabel: t('dashboard.archive'),
        isDanger: false 
      }))) return

      const bulkBtn = document.getElementById('btn-archive-all') as HTMLButtonElement
      bulkBtn.disabled = true
      bulkBtn.textContent = t('dashboard.archiving')

      try {
        const response = await fetch('/api/v1/spools/bulk/status', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': getCsrfToken() },
          credentials: 'include',
          body: JSON.stringify({ spool_ids: ids, status: 'archived' }),
        })

        if (response.ok) {
          (window as any).closeSpoolModal()
          loadDashboardData()
        }
      } catch (err) {
        console.error('Failed bulk archive:', err)
      } finally {
        bulkBtn.disabled = false
      }
    }
    ;(window as any).archiveAll = archiveAll

    ;(window as any).closeSpoolModal = function() {
      document.getElementById('spool-modal')!.classList.remove('open')
    }

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        (window as any).closeSpoolModal()
        closeCustomize()
      }
    })

    document.getElementById('spool-modal')?.addEventListener('click', (e) => {
      if (e.target === e.currentTarget) (window as any).closeSpoolModal()
    })

    // â”€â”€ Load data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadDashboardData() {
      try {
        const [spoolsRes, filamentsRes, dashboardRes] = await Promise.all([
          fetch('/api/v1/spools?page_size=200', { credentials: 'include' }),
          fetch('/api/v1/filaments?page_size=200', { credentials: 'include' }),
          fetch('/api/v1/dashboard/stats?limit=20', { credentials: 'include' }),
        ])
        
        if (!spoolsRes.ok || !filamentsRes.ok) throw new Error('Failed to fetch data')
        
        const spoolsData = await spoolsRes.json()
        const filamentsData = await filamentsRes.json()
        const dashboardData = dashboardRes.ok ? await dashboardRes.json() : null
        
        allSpools = spoolsData.items
        allFilaments = filamentsData.items
        
        document.getElementById('stat-total-spools')!.textContent = spoolsData.total
        document.getElementById('stat-total-filaments')!.textContent = filamentsData.total
        
        if (dashboardData) {
          const dist = dashboardData.spool_distribution || { full: 0, normal: 0, low: 0, critical: 0, empty: 0 }
          document.getElementById('stat-low-spools')!.textContent = (dist.low + dist.critical).toString()
          document.getElementById('stat-empty-spools')!.textContent = dist.empty.toString()

          // Total weight stat
          document.getElementById('stat-total-weight')!.textContent = formatWeight(dashboardData.total_weight_g || 0)

          // â”€â”€ Widget: Spool Status (Interactive Donut) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          const statusContainer = document.getElementById('spool-status')!
          const total = dist.full + dist.normal + dist.low + dist.critical + dist.empty
          const segments = [
            { key: 'full', label: t('dashboard.statusFull'), color: '#22c55e', count: dist.full },
            { key: 'normal', label: t('dashboard.statusNormal'), color: '#3b82f6', count: dist.normal },
            { key: 'low', label: t('dashboard.statusLow'), color: '#eab308', count: dist.low },
            { key: 'critical', label: t('dashboard.statusCritical'), color: '#ef4444', count: dist.critical },
            { key: 'empty', label: t('dashboard.statusEmpty'), color: '#6b7280', count: dist.empty },
          ];
          
          if (total > 0) {
            const R = 34, CX = 45, CY = 45, SW = 12;
            const C = 2 * Math.PI * R;
            let offset = 0;
            const arcs = segments.filter(s => s.count > 0).map(s => {
              const pct = s.count / total;
              const dash = pct * C;
              const gap = C - dash;
              const arc = `<circle class="spool-donut-segment" data-key="${s.key}" cx="${CX}" cy="${CY}" r="${R}" fill="none" stroke="${s.color}" stroke-width="${SW}" stroke-dasharray="${dash} ${gap}" stroke-dashoffset="${-offset}" stroke-linecap="butt" />`;
              offset += dash;
              return arc;
            });

            statusContainer.innerHTML = `
              <div style="display:flex;align-items:center;gap:16px;">
                <div id="spool-donut" style="position:relative;width:80px;height:80px;flex-shrink:0;">
                  <svg viewBox="0 0 90 90" style="width:100%;height:100%;display:block;transform:rotate(-90deg);">
                    <circle cx="${CX}" cy="${CY}" r="${R}" fill="none" stroke="var(--border-subtle)" stroke-width="${SW}" opacity="0.3" />
                    ${arcs.join('')}
                  </svg>
                  <div style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;pointer-events:none;">
                    <span id="donut-total" style="font-size:1rem;font-weight:800;line-height:1;transition:color 0.15s;">${total}</span>
                    <span id="donut-sublabel" style="font-size:0.45rem;color:var(--text-muted);margin-top:1px;text-transform:uppercase;letter-spacing:0.04em;">${t('nav.spools')}</span>
                  </div>
                </div>
                <div id="spool-legend" style="display:flex;flex-direction:column;gap:0;flex:1;min-width:0;">
                  ${segments.map(s => {
                    const pct = total > 0 ? Math.round((s.count / total) * 100) : 0;
                    return `
                      <div class="spool-legend-item" data-key="${s.key}" style="display:flex;align-items:center;gap:8px;padding:3px 4px;border-radius:4px;cursor:pointer;">
                        <span style="width:8px;height:8px;border-radius:50%;background:${s.color};flex-shrink:0;"></span>
                        <span style="flex:1;font-size:0.72rem;font-weight:500;line-height:1;">${s.label}</span>
                        <span style="font-size:0.72rem;font-weight:700;color:${s.color};min-width:14px;text-align:right;">${s.count}</span>
                        <span style="font-size:0.6rem;color:var(--text-muted);min-width:24px;text-align:right;">${pct}%</span>
                      </div>`;
                  }).join('')}
                </div>
              </div>`;

            const donut = document.getElementById('spool-donut')!;
            const donutTotal = document.getElementById('donut-total')!;
            const donutSub = document.getElementById('donut-sublabel')!;
            const legendItems = document.querySelectorAll('.spool-legend-item');
            const donutSegs = document.querySelectorAll('.spool-donut-segment');

            function highlightKey(key: string | null) {
              if (key) {
                donut.classList.add('has-hover');
                donutSegs.forEach(s => s.classList.toggle('active', s.getAttribute('data-key') === key));
                legendItems.forEach(l => l.classList.toggle('active', l.getAttribute('data-key') === key));
                const seg = segments.find(s => s.key === key);
                if (seg) {
                  donutTotal.textContent = String(seg.count);
                  donutTotal.style.color = seg.color;
                  donutSub.textContent = seg.label;
                }
              } else {
                donut.classList.remove('has-hover');
                donutSegs.forEach(s => s.classList.remove('active'));
                legendItems.forEach(l => l.classList.remove('active'));
                donutTotal.textContent = String(total);
                donutTotal.style.color = '';
                donutSub.textContent = t('nav.spools');
              }
            }

            donutSegs.forEach(s => {
              s.addEventListener('mouseenter', () => highlightKey(s.getAttribute('data-key')));
              s.addEventListener('mouseleave', () => highlightKey(null));
              s.addEventListener('click', () => {
                const k = s.getAttribute('data-key');
                if (k === 'low' || k === 'critical') { (window as any).openSpoolModal('low'); }
                else if (k === 'empty') { (window as any).openSpoolModal('empty'); }
                else { window.location.href = '/spools'; }
              });
            });
            legendItems.forEach(l => {
              l.addEventListener('mouseenter', () => highlightKey(l.getAttribute('data-key')));
              l.addEventListener('mouseleave', () => highlightKey(null));
              l.addEventListener('click', () => {
                const k = l.getAttribute('data-key');
                if (k === 'low' || k === 'critical') { (window as any).openSpoolModal('low'); }
                else if (k === 'empty') { (window as any).openSpoolModal('empty'); }
                else { window.location.href = '/spools'; }
              });
            });
          } else {
            statusContainer.innerHTML = `<p style="color: var(--text-muted); font-size: 0.85rem;">${t('dashboard.noData')}</p>`;
          }

          // â”€â”€ Widget: Total Weight â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          const weightContainer = document.getElementById('total-weight')!
          const totalW = dashboardData.total_weight_g || 0
          const totalInitW = dashboardData.total_initial_weight_g || 1
          const pct = Math.min(100, Math.round((totalW / totalInitW) * 100))
          const activeCount = dashboardData.spool_count_active || 0
          
          weightContainer.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 4px;">
              <span style="font-size: 1.3rem; font-weight: 700;">${formatWeight(totalW)}</span>
              <span style="font-size: 0.75rem; color: var(--text-muted);">${t('dashboard.ofInitial')} ${formatWeight(totalInitW)}</span>
            </div>
            <div class="weight-progress">
              <div class="weight-progress-fill" style="width: ${pct}%;"></div>
            </div>
            <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 0.75rem; color: var(--text-muted);">
              <span>${pct}% ${t('dashboard.remaining')}</span>
              <span>${activeCount} ${t('dashboard.activeSpools')}</span>
            </div>
          `

          // â”€â”€ Widget: Color Distribution â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          const colorContainer = document.getElementById('color-distribution')!
          const colors = dashboardData.color_distribution || []
          if (colors.length === 0) {
            colorContainer.innerHTML = `<p style="color: var(--text-muted); font-size: 0.85rem;">${t('dashboard.noData')}</p>`
          } else {
            const maxCount = Math.max(...colors.map((c: any) => c.spool_count))
            colorContainer.innerHTML = colors.map((c: any) => {
              const hex = (c.hex_code || '#888').trim()
              const name = c.color_name && c.color_name.toLowerCase() !== hex.toLowerCase() ? c.color_name : ''
              const barPct = Math.round((c.spool_count / maxCount) * 100)
              return `<div style="display:flex;align-items:center;gap:10px;padding:5px 2px;">
                <div style="width:24px;height:24px;border-radius:6px;background:${hex};flex-shrink:0;border:2px solid rgba(255,255,255,0.08);box-shadow:0 1px 3px rgba(0,0,0,0.3);"></div>
                <div style="flex:1;min-width:0;">
                  <div style="display:flex;align-items:center;gap:6px;">
                    <span style="font-weight:600;font-size:0.76rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${name || hex}</span>
                    ${name ? `<span style="font-family:var(--font-mono);font-size:0.55rem;color:var(--text-muted);background:var(--bg-soft);padding:1px 4px;border-radius:3px;">${hex}</span>` : ''}
                  </div>
                  <div style="height:3px;background:var(--bg-soft);border-radius:2px;overflow:hidden;margin-top:3px;">
                    <div style="height:100%;width:${barPct}%;background:${hex};border-radius:2px;opacity:0.7;"></div>
                  </div>
                </div>
                <span style="font-size:0.72rem;font-weight:700;color:var(--text-muted);min-width:16px;text-align:right;">${c.spool_count}</span>
              </div>`
            }).join('')
          }

          // â”€â”€ Widget: Recent Activity â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          const activityContainer = document.getElementById('recent-activity')!
          const events = dashboardData.recent_events || []
          if (events.length === 0) {
            activityContainer.innerHTML = `<p style="color: var(--text-muted); font-size: 0.85rem;">${t('dashboard.noRecentActivity')}</p>`
          } else {
            activityContainer.innerHTML = events.slice(0, 10).map((ev: any) => {
              const info = EVENT_ICONS[ev.event_type] || { icon: 'â€¢', bg: 'rgba(107,114,128,0.15)' }
              const weightInfo = ev.delta_weight_g != null ? ` (${ev.delta_weight_g > 0 ? '+' : ''}${ev.delta_weight_g.toFixed(0)}g)` : ''
              return `
                <div class="event-row" style="cursor: pointer;" onclick="window.location.href='/spools/${ev.spool_id}'">
                  <div class="event-icon" style="background: ${info.bg};">${info.icon}</div>
                  <div style="flex: 1; min-width: 0;">
                    <div style="font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                      #${ev.spool_id} Â· ${ev.filament_name || ''}${weightInfo}
                    </div>
                    <div style="font-size: 0.7rem; color: var(--text-muted);">${ev.event_type}${ev.note ? ' Â· ' + ev.note : ''}</div>
                  </div>
                  <span class="event-time">${timeAgo(ev.event_at)}</span>
                </div>
              `
            }).join('')
          }

          // Printer overview is now handled by printer monitor polling

          // â”€â”€ Widget: Location Stats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          const locationStatsContainer = document.getElementById('location-stats')!
          if (!dashboardData.location_stats || dashboardData.location_stats.length === 0) {
            locationStatsContainer.innerHTML = `<p style="color: var(--text-muted); font-size: 0.85rem;">${t('dashboard.noData')}</p>`
          } else {
            locationStatsContainer.innerHTML = dashboardData.location_stats.map((l: any) =>
              `<div class="wg-row" onclick="window.location.href='/spools?location_id=${l.location_id}'">
                <div class="wg-icon" style="background: rgba(244,114,182,0.12); color: #f472b6;"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg></div>
                <div class="wg-info">
                  <div class="wg-name">${l.location_name}</div>
                  <div class="wg-sub">${l.spool_count} Spulen Â· ${formatWeight(l.total_weight_g)}</div>
                </div>
                <span class="wg-val">${l.spool_count}</span>
              </div>`
            ).join('')
          }

          // â”€â”€ Widget: Filament Stats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          const filamentStatsContainer = document.getElementById('filament-stats')!
          if (!dashboardData.filament_stats || dashboardData.filament_stats.length === 0) {
            filamentStatsContainer.innerHTML = `<p style="color: var(--text-muted); font-size: 0.85rem;">${t('dashboard.noData')}</p>`
          } else {
            filamentStatsContainer.innerHTML = dashboardData.filament_stats.map((f: any) =>
              `<div class="wg-row" onclick="window.location.href='/spools?material=${encodeURIComponent(f.filament_type)}'">
                <div class="wg-icon" style="background: rgba(251,146,60,0.12); color: #fb923c;"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M8 12h8M12 8v8"/></svg></div>
                <div class="wg-info">
                  <div class="wg-name">${f.filament_type}</div>
                  <div class="wg-sub">${f.spool_count} Spulen Â· ${formatWeight(f.total_weight_g)}</div>
                </div>
                <span class="wg-val">${f.spool_count}</span>
              </div>`
            ).join('')
          }

          // â”€â”€ Widget: Manufacturers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          const mfrContainer = document.getElementById('manufacturers-with-spools')!
          if (dashboardData.manufacturers_with_spools.length === 0) {
            mfrContainer.innerHTML = `<p style="color: var(--text-muted); font-size: 0.85rem;">${t('dashboard.noData')}</p>`
          } else {
            const mfrMax = Math.max(...dashboardData.manufacturers_with_spools.map((m: any) => m.spool_count))
            mfrContainer.innerHTML = dashboardData.manufacturers_with_spools.map((m: any) => {
              const initial = (m.name || '?')[0].toUpperCase()
              const pct = Math.round((m.spool_count / mfrMax) * 100)
              return `<div class="wg-row" onclick="window.location.href='/spools?manufacturer_id=${m.id}'">
                <div class="wg-icon" style="background: rgba(16,185,129,0.12); color: #10b981; font-weight: 700;">${initial}</div>
                <div class="wg-info">
                  <div class="wg-name">${m.name}</div>
                  <div style="height: 4px; background: var(--bg-soft); border-radius: 2px; overflow: hidden; margin-top: 4px;">
                    <div style="height: 100%; width: ${pct}%; background: #10b981; border-radius: 2px;"></div>
                  </div>
                </div>
                <span class="wg-val">${m.spool_count}</span>
              </div>`
            }).join('')
          }

          // â”€â”€ Widget: Low Stock â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          const mfrLowStockContainer = document.getElementById('low-stock-spools')!
          if (dashboardData.low_stock_spools.length === 0) {
            mfrLowStockContainer.innerHTML = `<div style="display:flex;align-items:center;gap:8px;padding:8px 0;color:var(--accent-2);font-size:0.82rem;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>${t('dashboard.allSufficient')}</div>`
          } else {
            mfrLowStockContainer.innerHTML = dashboardData.low_stock_spools.map((s: any) => {
              const grams = Math.round(s.remaining_weight_g)
              const isLow = grams < 100
              const clr = isLow ? '#ef4444' : '#eab308'
              const bg = isLow ? 'rgba(239,68,68,0.1)' : 'rgba(234,179,8,0.1)'
              const pct = Math.max(3, Math.min(100, Math.round((grams / 1000) * 100)))
              return `<div style="display:flex;align-items:center;gap:8px;padding:6px 2px;border-bottom:1px solid var(--border-subtle);cursor:pointer;font-size:0.78rem;" onclick="window.location.href='/spools/${s.spool_id}'">
                <div style="width:6px;height:6px;border-radius:50%;background:${clr};flex-shrink:0;"></div>
                <div style="flex:1;min-width:0;">
                  <div style="font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">#${s.spool_id} Â· ${s.filament_designation}</div>
                  <div style="display:flex;align-items:center;gap:6px;margin-top:3px;">
                    <div style="flex:1;height:3px;background:var(--bg-soft);border-radius:2px;overflow:hidden;"><div style="height:100%;width:${pct}%;background:${clr};border-radius:2px;"></div></div>
                    <span style="font-family:var(--font-mono);font-size:0.7rem;color:${clr};font-weight:600;flex-shrink:0;">${grams}g</span>
                  </div>
                </div>
              </div>`
            }).join('')
          }

          // â”€â”€ Widget: Filament Types â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          const typesContainer = document.getElementById('filament-types')!
          if (dashboardData.filament_types.length === 0) {
            typesContainer.innerHTML = `<p style="color: var(--text-muted); font-size: 0.85rem;">${t('dashboard.noData')}</p>`
          } else {
            const typeColors: Record<string, string> = { PLA: '#22c55e', PETG: '#3b82f6', ABS: '#ef4444', ASA: '#f97316', TPU: '#a855f7', PA: '#06b6d4', PC: '#6366f1' }
            const typeMax = Math.max(...dashboardData.filament_types.map((t: any) => t.count))
            typesContainer.innerHTML = dashboardData.filament_types.map((ft: any) => {
              const clr = typeColors[ft.type] || '#8b5cf6'
              const pct = Math.round((ft.count / typeMax) * 100)
              return `<div class="wg-row" onclick="window.location.href='/spools?material=${encodeURIComponent(ft.type)}'">
                <div class="wg-icon" style="background: ${clr}22; color: ${clr}; font-weight: 700; font-size: 0.65rem;">${ft.type.substring(0, 4)}</div>
                <div class="wg-info">
                  <div class="wg-name">${ft.type}</div>
                  <div style="height: 4px; background: var(--bg-soft); border-radius: 2px; overflow: hidden; margin-top: 4px;">
                    <div style="height: 100%; width: ${pct}%; background: ${clr}; border-radius: 2px;"></div>
                  </div>
                </div>
                <span class="wg-val">${ft.count}</span>
              </div>`
            }).join('')
          }
        }
      } catch (error) {
        console.error('Failed to load dashboard:', error)
      }
    }

    // â”€â”€ Printer Monitor (incremental DOM updates) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const PM_COLORS: Record<string, string> = {
      printing: '#10b981', idle: '#6b7280', paused: '#eab308',
      error: '#ef4444', preparing: '#38bdf8', offline: '#4b5563'
    }
    const PM_LABELS: Record<string, string> = {
      printing: 'Druckt', idle: 'Bereit', paused: 'Pause',
      error: 'Fehler', preparing: 'Vorbereitung', offline: 'Offline'
    }

    function formatMinutes(min: number | null | undefined): string {
      if (min == null || min <= 0) return '--'
      const h = Math.floor(min / 60)
      const m = min % 60
      return h > 0 ? `${h}h ${m}m` : `${m}m`
    }

    function isActive(state: string) {
      return state === 'printing' || state === 'paused' || state === 'preparing'
    }

    let pmLastStates: Record<number, string> = {}
    let pmKnownIds = new Set<number>()

    const DRAG_HANDLE_SVG = '<svg class="drag-handle" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="5" r="1"/><circle cx="9" cy="12" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="19" r="1"/></svg>'

    function pmBuildWidgetBody(p: any): string {
      const dotColor = PM_COLORS[p.state] || '#6b7280'
      const badgeClass = p.state || 'offline'
      const stateLabel = PM_LABELS[p.state] || p.state

      if (!isActive(p.state)) {
        return `<div class="pm-card">
          <div class="pm-head">
            <span class="pm-dot" style="background:${dotColor};"></span>
            <span class="pm-badge ${badgeClass}">${stateLabel}</span>
          </div>
          <div class="pm-idle-text"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" opacity="0.4"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>Kein aktiver Druck</div>
        </div>`
      }

      const pct = p.progress_pct ?? 0
      return `<div class="pm-card pm-card-active" onclick="window.location.href='/monitoring'" style="cursor:pointer;">
        <div class="pm-body">
          ${p.has_camera ? `<img class="pm-cam" data-cam-id="${p.id}" src="/api/v1/printers/${p.id}/camera?t=${Date.now()}" alt="" onerror="this.style.opacity='0.2'" />` : ''}
          <div class="pm-info">
            <div class="pm-job" data-field="job">${p.job_name || 'Unbekannt'}</div>
            <div class="pm-bar-wrap">
              <div class="pm-bar"><div class="pm-bar-fill" data-field="bar" style="width:${pct}%;"></div></div>
              <div class="pm-bar-text"><span data-field="pct">${pct}%</span><span data-field="time">${p.remaining_min != null ? formatMinutes(p.remaining_min) : ''}</span></div>
            </div>
            <div class="pm-stats">
              ${p.nozzle_temp != null ? `<span class="pm-stat" data-field="nozzle">${Math.round(p.nozzle_temp)}Â°<span class="pm-stat-muted">/${p.nozzle_target ? Math.round(p.nozzle_target) : '-'}Â°</span></span>` : ''}
              ${p.bed_temp != null ? `<span class="pm-stat" data-field="bed">${Math.round(p.bed_temp)}Â°<span class="pm-stat-muted">/${p.bed_target ? Math.round(p.bed_target) : '-'}Â°</span></span>` : ''}
              ${(p.layer != null && p.total_layers != null) ? `<span class="pm-stat" data-field="layer">L${p.layer}/${p.total_layers}</span>` : ''}
            </div>
          </div>
        </div>
      </div>`
    }

    function pmEnsureWidget(p: any) {
      const key = `printer-${p.id}`
      const grid = document.getElementById('widget-grid')!
      let widget = grid.querySelector(`[data-widget="${key}"]`) as HTMLElement | null

      if (!widget) {
        widget = document.createElement('div')
        widget.className = 'widget'
        widget.setAttribute('data-widget', key)
        widget.setAttribute('draggable', 'true')

        WIDGET_NAMES[key] = p.name
        if (!DEFAULT_WIDGET_ORDER.includes(key)) {
          DEFAULT_WIDGET_ORDER.push(key)
        }

        const dotColor = PM_COLORS[p.state] || '#6b7280'
        widget.innerHTML = `
          <div class="widget-header">
            <div class="widget-title"><span class="dot" style="background:${dotColor};"></span> <span class="pm-wg-title">${p.name}</span></div>
            ${DRAG_HANDLE_SVG}
          </div>
          <div class="widget-body pm-widget-body" style="max-height:none;overflow:visible;">
            ${pmBuildWidgetBody(p)}
          </div>`

        const anchor = grid.querySelector('[data-widget="manufacturers"]')
        if (anchor) {
          grid.insertBefore(widget, anchor)
        } else {
          grid.appendChild(widget)
        }

        setupDragForWidget(widget)
        applyWidgetVisibility()
      }
    }

    function pmUpdateWidget(p: any) {
      const key = `printer-${p.id}`
      const grid = document.getElementById('widget-grid')!
      const widget = grid.querySelector(`[data-widget="${key}"]`) as HTMLElement | null
      if (!widget) return

      const dotEl = widget.querySelector('.widget-title .dot') as HTMLElement | null
      if (dotEl) dotEl.style.background = PM_COLORS[p.state] || '#6b7280'

      const prevState = pmLastStates[p.id]
      const stateChanged = prevState !== p.state || (isActive(p.state) !== isActive(prevState || ''))

      if (stateChanged) {
        const body = widget.querySelector('.pm-widget-body')
        if (body) body.innerHTML = pmBuildWidgetBody(p)
        pmLastStates[p.id] = p.state
        return
      }

      pmLastStates[p.id] = p.state
      if (!isActive(p.state)) return

      const pct = p.progress_pct ?? 0
      const q = (sel: string) => widget!.querySelector(`[data-field="${sel}"]`) as HTMLElement | null
      const jobEl = q('job'); if (jobEl) jobEl.textContent = p.job_name || 'Unbekannt'
      const barEl = q('bar') as HTMLElement | null; if (barEl) barEl.style.width = `${pct}%`
      const pctEl = q('pct'); if (pctEl) pctEl.textContent = `${pct}%`
      const timeEl = q('time'); if (timeEl) timeEl.textContent = p.remaining_min != null ? formatMinutes(p.remaining_min) : ''
      const nozzleEl = q('nozzle'); if (nozzleEl && p.nozzle_temp != null) nozzleEl.innerHTML = `${Math.round(p.nozzle_temp)}Â°<span class="pm-stat-muted">/${p.nozzle_target ? Math.round(p.nozzle_target) : '-'}Â°</span>`
      const bedEl = q('bed'); if (bedEl && p.bed_temp != null) bedEl.innerHTML = `${Math.round(p.bed_temp)}Â°<span class="pm-stat-muted">/${p.bed_target ? Math.round(p.bed_target) : '-'}Â°</span>`
      const layerEl = q('layer'); if (layerEl && p.layer != null) layerEl.textContent = `L${p.layer}/${p.total_layers}`
      const camImg = widget.querySelector(`img[data-cam-id="${p.id}"]`) as HTMLImageElement | null
      if (camImg) camImg.src = `/api/v1/printers/${p.id}/camera?t=${Date.now()}`
    }

    function setupDragForWidget(el: HTMLElement) {
      const grid = document.getElementById('widget-grid')!

      el.addEventListener('dragstart', (e: DragEvent) => {
        draggedWidget = el
        el.classList.add('dragging')
        e.dataTransfer!.effectAllowed = 'move'
        e.dataTransfer!.setData('text/plain', el.dataset.widget || '')
      })
      el.addEventListener('dragend', () => {
        el.classList.remove('dragging')
        grid.querySelectorAll('.widget').forEach(w => w.classList.remove('drag-over'))
        draggedWidget = null
        const newOrder = Array.from(grid.querySelectorAll('[data-widget]')).map(w => w.getAttribute('data-widget')!)
        saveWidgetOrder(newOrder)
      })
      el.addEventListener('dragover', (e: DragEvent) => {
        e.preventDefault()
        e.dataTransfer!.dropEffect = 'move'
        if (draggedWidget && draggedWidget !== el) el.classList.add('drag-over')
      })
      el.addEventListener('dragleave', () => { el.classList.remove('drag-over') })
      el.addEventListener('drop', (e: DragEvent) => {
        e.preventDefault()
        el.classList.remove('drag-over')
        if (!draggedWidget || draggedWidget === el) return
        const allWidgets = Array.from(grid.querySelectorAll('.widget[data-widget]'))
        const dragIdx = allWidgets.indexOf(draggedWidget)
        const dropIdx = allWidgets.indexOf(el)
        if (dragIdx < dropIdx) {
          el.parentNode!.insertBefore(draggedWidget, el.nextSibling)
        } else {
          el.parentNode!.insertBefore(draggedWidget, el)
        }
      })
    }

    async function loadPrinterMonitor() {
      try {
        const res = await fetch('/api/v1/printers/status', { credentials: 'include' })
        if (!res.ok) return
        const printers = await res.json() as any[]

        for (const p of printers) {
          if (!pmKnownIds.has(p.id)) {
            pmEnsureWidget(p)
            pmKnownIds.add(p.id)
            pmLastStates[p.id] = p.state
          } else {
            pmUpdateWidget(p)
          }
        }
      } catch (e) {
        console.debug('Printer monitor fetch error:', e)
      }
    }

    let printerMonitorInterval: ReturnType<typeof setInterval> | null = null

    function startPrinterMonitor() {
      loadPrinterMonitor()
      printerMonitorInterval = setInterval(loadPrinterMonitor, 5000)
      setInterval(() => {
        document.querySelectorAll<HTMLImageElement>('img[data-cam-id]').forEach(img => {
          const pid = img.getAttribute('data-cam-id')
          if (pid) img.src = `/api/v1/printers/${pid}/camera?t=${Date.now()}`
        })
      }, 2000)
    }

    // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function init() {
      try {
        await initI18n()
        WIDGET_NAMES['total-weight'] = t('dashboard.weightOverview')
        WIDGET_NAMES['low-stock'] = t('dashboard.lowStockSpools')
        WIDGET_NAMES['color-distribution'] = t('dashboard.colorDistribution')
        WIDGET_NAMES['recent-activity'] = t('dashboard.recentActivity')
        WIDGET_NAMES['manufacturers'] = t('dashboard.manufacturersWithSpools')
        WIDGET_NAMES['filament-types'] = t('dashboard.filamentTypes')
        WIDGET_NAMES['location-stats'] = t('dashboard.locationStats')
        WIDGET_NAMES['filament-stats'] = t('dashboard.filamentStats')

        applyWidgetOrder()
        applyWidgetVisibility()
        setupDragAndDrop()
        await loadDashboardData()
        startPrinterMonitor()
      } catch (err) {
        console.error('Dashboard init failed:', err)
        document.querySelector('.widget-grid')!.insertAdjacentHTML('afterbegin',
          `<div style="grid-column: 1/-1; padding: 20px; background: #1a0000; border: 1px solid #ef4444; border-radius: 8px; color: #ef4444; font-family: monospace; white-space: pre-wrap;">Dashboard Error:\n${err instanceof Error ? err.stack || err.message : String(err)}</div>`)
      }
    }
    init()
  </script>
</Layout>
