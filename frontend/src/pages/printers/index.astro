---
import Layout from '../../layouts/Layout.astro'
---

<Layout title="FilaMan - Printers">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold" data-i18n="printers.title">Printers</h1>
    <button
      id="btn-new"
      class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md font-medium transition-colors"
      data-i18n="printers.addPrinter"
    >
      Add Printer
    </button>
  </div>
  
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow overflow-hidden">
    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
      <thead class="bg-gray-50 dark:bg-gray-700">
        <tr>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider" data-i18n="printers.name">Name</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider" data-i18n="printers.model">Model</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider" data-i18n="printers.driver">Driver</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider" data-i18n="common.status">Status</th>
          <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider" data-i18n="common.actions">Actions</th>
        </tr>
      </thead>
      <tbody id="printers-table" class="divide-y divide-gray-200 dark:divide-gray-700">
        <tr>
          <td colspan="5" class="px-6 py-4 text-center text-gray-500 dark:text-gray-400" data-i18n="common.loading">Loading...</td>
        </tr>
      </tbody>
    </table>
  </div>
  
  <div id="modal-container" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 w-full max-w-md mx-4">
      <h3 id="modal-title" class="text-lg font-semibold mb-4" data-i18n="printers.addPrinter">Add Printer</h3>
      <form id="modal-form" class="space-y-4">
        <input type="hidden" id="printer-id" />
        <div>
          <label for="printer-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" data-i18n="printers.name">
            Name *
          </label>
          <input
            type="text"
            id="printer-name"
            required
            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
          />
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label for="printer-manufacturer" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
              Manufacturer
            </label>
            <input
              type="text"
              id="printer-manufacturer"
              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
            />
          </div>
          <div>
            <label for="printer-model" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" data-i18n="printers.model">
              Model
            </label>
            <input
              type="text"
              id="printer-model"
              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
            />
          </div>
        </div>
        <div>
          <label for="printer-driver" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" data-i18n="printers.driver">
            Driver *
          </label>
          <select
            id="printer-driver"
            required
            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
          >
            <option value="dummy" data-i18n="printers.driverDummy">Dummy (Testing)</option>
            <option value="bambu" data-i18n="printers.driverBambu">Bambu Lab</option>
          </select>
        </div>
        <div>
          <label for="printer-serial" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" data-i18n="printers.serialNumber">
            Serial Number
          </label>
          <input
            type="text"
            id="printer-serial"
            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
          />
        </div>
        <div id="modal-error" class="hidden p-3 bg-red-100 dark:bg-red-900/30 border border-red-300 dark:border-red-700 rounded text-red-700 dark:text-red-300 text-sm"></div>
        <div class="flex gap-3">
          <button type="submit" id="modal-submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md font-medium transition-colors" data-i18n="common.save">
            Save
          </button>
          <button type="button" id="modal-cancel" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-md font-medium transition-colors" data-i18n="common.cancel">
            Cancel
          </button>
        </div>
      </form>
    </div>
  </div>
  
  <script>
    import { t, initI18n } from '../../lib/i18n'
    await initI18n()

    let printers: any[] = []
    
    function getCsrfToken(): string {
      const match = document.cookie.match(/(?:^|;\s*)csrf_token=([^;]*)/)
      return match ? decodeURIComponent(match[1]) : ''
    }
    
    async function loadPrinters() {
      try {
        const response = await fetch('/api/v1/printers', { credentials: 'include' })
        
        if (!response.ok) throw new Error('Failed to fetch printers')
        
        printers = await response.json().then(d => d.items)
        renderPrinters()
      } catch (error) {
        console.error('Failed to load printers:', error)
        document.getElementById('printers-table')!.innerHTML = `
          <tr>
            <td colspan="5" class="px-6 py-4 text-center text-red-500">${t('printers.failedLoad')}</td>
          </tr>
        `
      }
    }
    
    function renderPrinters() {
      const tbody = document.getElementById('printers-table')!
      
      if (printers.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5" class="px-6 py-4 text-center text-gray-500 dark:text-gray-400">
              ${t('printers.noPrinters')}
            </td>
          </tr>
        `
        return
      }
      
      tbody.innerHTML = printers.map(p => `
        <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50 cursor-pointer" onclick="window.location='/printers/${p.id}'">
          <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900 dark:text-gray-100">${p.name}</td>
          <td class="px-6 py-4 whitespace-nowrap text-gray-500 dark:text-gray-400">
            ${p.manufacturer || ''} ${p.model || '-'}
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="px-2 py-1 text-xs rounded bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300">${p.driver_key}</span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="px-2 py-1 text-xs rounded ${p.is_active ? 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300' : 'bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300'}">
              ${p.is_active ? t('common.active') : t('common.inactive')}
            </span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-right" onclick="event.stopPropagation()">
            <button data-id="${p.id}" data-name="${p.name}" data-manufacturer="${p.manufacturer || ''}" data-model="${p.model || ''}" data-driver="${p.driver_key}" data-serial="${p.serial_number || ''}" class="btn-edit text-blue-600 hover:text-blue-700 mr-3">${t('common.edit')}</button>
            <button data-id="${p.id}" class="btn-delete text-red-600 hover:text-red-700">${t('common.delete')}</button>
          </td>
        </tr>
      `).join('')
      
      document.querySelectorAll('.btn-edit').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const target = e.currentTarget as HTMLButtonElement
          openModal(
            parseInt(target.dataset.id!),
            target.dataset.name!,
            target.dataset.manufacturer!,
            target.dataset.model!,
            target.dataset.driver!,
            target.dataset.serial!
          )
        })
      })
      
      document.querySelectorAll('.btn-delete').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const target = e.currentTarget as HTMLButtonElement
          const id = parseInt(target.dataset.id!)
          
          if (!(await (window as any).__fmConfirm(t('printers.confirmDelete')))) return
          
          try {
            const response = await fetch(`/api/v1/printers/${id}`, {
              method: 'DELETE',
              headers: { 'X-CSRF-Token': getCsrfToken() },
              credentials: 'include',
            })
            
            if (!response.ok) {
              const data = await response.json()
              await (window as any).__fmAlert(data.message || t('printers.failedDelete'))
              return
            }
            
            loadPrinters()
          } catch {
            await (window as any).__fmAlert(t('printers.failedDelete'))
          }
        })
      })
    }
    
    function openModal(id: number | null = null, name: string = '', manufacturer: string = '', model: string = '', driver: string = 'dummy', serial: string = '') {
      const container = document.getElementById('modal-container')!
      const title = document.getElementById('modal-title')!
      const idInput = document.getElementById('printer-id') as HTMLInputElement
      const nameInput = document.getElementById('printer-name') as HTMLInputElement
      const mfrInput = document.getElementById('printer-manufacturer') as HTMLInputElement
      const modelInput = document.getElementById('printer-model') as HTMLInputElement
      const driverInput = document.getElementById('printer-driver') as HTMLSelectElement
      const serialInput = document.getElementById('printer-serial') as HTMLInputElement
      const error = document.getElementById('modal-error')!
      
      title.textContent = id ? t('printers.editPrinter') : t('printers.addPrinter')
      idInput.value = id ? String(id) : ''
      nameInput.value = name
      mfrInput.value = manufacturer
      modelInput.value = model
      driverInput.value = driver
      serialInput.value = serial
      error.classList.add('hidden')
      
      container.classList.remove('hidden')
      nameInput.focus()
    }
    
    function closeModal() {
      document.getElementById('modal-container')!.classList.add('hidden')
    }
    
    document.getElementById('btn-new')?.addEventListener('click', () => openModal())
    document.getElementById('modal-cancel')?.addEventListener('click', closeModal)
    
    document.getElementById('modal-form')?.addEventListener('submit', async (e) => {
      e.preventDefault()
      
      const id = (document.getElementById('printer-id') as HTMLInputElement).value
      const name = (document.getElementById('printer-name') as HTMLInputElement).value
      const manufacturer = (document.getElementById('printer-manufacturer') as HTMLInputElement).value || null
      const model = (document.getElementById('printer-model') as HTMLInputElement).value || null
      const driver_key = (document.getElementById('printer-driver') as HTMLSelectElement).value
      const serial_number = (document.getElementById('printer-serial') as HTMLInputElement).value || null
      const error = document.getElementById('modal-error') as HTMLDivElement
      const submitBtn = document.getElementById('modal-submit') as HTMLButtonElement
      
      const data = { name, manufacturer, model, driver_key, serial_number }
      
      error.classList.add('hidden')
      submitBtn.disabled = true
      submitBtn.textContent = t('common.saving')
      
      try {
        const url = id ? `/api/v1/printers/${id}` : '/api/v1/printers'
        const method = id ? 'PATCH' : 'POST'
        
        const response = await fetch(url, {
          method,
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': getCsrfToken(),
          },
          credentials: 'include',
          body: JSON.stringify(data),
        })
        
        if (!response.ok) {
          const errorData = await response.json()
          throw new Error(errorData.message || t('printers.failedSave'))
        }
        
        closeModal()
        loadPrinters()
      } catch (err: any) {
        error.textContent = err.message
        error.classList.remove('hidden')
      } finally {
        submitBtn.disabled = false
        submitBtn.textContent = t('common.save')
      }
    })
    
    loadPrinters()
  </script>
</Layout>
