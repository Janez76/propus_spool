---
import Layout from '../../layouts/Layout.astro'
---

<Layout title="Propus Spool - Printers">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
    <h1 style="font-size: 1.8rem; font-weight: 700; margin: 0; font-family: var(--font-serif);" data-i18n="printers.title">Printers</h1>
    <button
      id="btn-new"
      class="fm-btn fm-btn-primary"
      data-i18n="printers.addPrinter"
    >
      Add Printer
    </button>
  </div>
  
  <div class="fm-card" style="padding: 0; overflow: hidden;">
    <table class="fm-table">
      <thead>
        <tr style="background: var(--bg-soft);">
          <th data-i18n="printers.name">Name</th>
          <th data-i18n="printers.model">Model</th>
          <th data-i18n="printers.driver">Driver</th>
          <th data-i18n="common.status">Status</th>
          <th style="text-align: right;" data-i18n="common.actions">Actions</th>
        </tr>
      </thead>
      <tbody id="printers-table">
        <tr>
          <td colspan="5" style="text-align: center; color: var(--text-muted);" data-i18n="common.loading">Loading...</td>
        </tr>
      </tbody>
    </table>
  </div>
  
  <div id="modal-container" class="fm-modal-overlay">
    <div class="fm-card" style="width: 100%; max-width: 28rem; margin: 0 1rem; padding: 24px;">
      <h3 id="modal-title" style="font-size: 1.15rem; font-weight: 600; margin-bottom: 16px;" data-i18n="printers.addPrinter">Add Printer</h3>
      <form id="modal-form" style="display: flex; flex-direction: column; gap: 16px;">
        <input type="hidden" id="printer-id" />
        <div>
          <label for="printer-preset" class="fm-label">Drucker-Vorlage</label>
          <select id="printer-preset" class="fm-select">
            <option value="">-- Benutzerdefiniert --</option>
            <optgroup label="Bambu Lab">
              <option value="bambu_x1c">Bambu Lab X1 Carbon</option>
              <option value="bambu_x1e">Bambu Lab X1E</option>
              <option value="bambu_p1s">Bambu Lab P1S</option>
              <option value="bambu_p1p">Bambu Lab P1P</option>
              <option value="bambu_a1">Bambu Lab A1</option>
              <option value="bambu_a1mini">Bambu Lab A1 Mini</option>
            </optgroup>
            <optgroup label="Prusa">
              <option value="prusa_mk4_mmu">Prusa MK4S + MMU3</option>
              <option value="prusa_xl">Prusa XL (5-Tool)</option>
            </optgroup>
            <optgroup label="Snapmaker">
              <option value="snapmaker_u1">Snapmaker Artisan / U1</option>
              <option value="snapmaker_j1">Snapmaker J1 / J1s</option>
            </optgroup>
            <optgroup label="Creality">
              <option value="creality_k1">Creality K1</option>
              <option value="creality_k1max">Creality K1 Max</option>
              <option value="creality_k2plus">Creality K2 Plus</option>
              <option value="creality_ender3v3">Creality Ender-3 V3</option>
            </optgroup>
            <optgroup label="Voron">
              <option value="voron_02">Voron 0.2</option>
              <option value="voron_trident">Voron Trident</option>
              <option value="voron_24">Voron 2.4</option>
            </optgroup>
            <optgroup label="AnkerMake">
              <option value="anker_m5">AnkerMake M5</option>
              <option value="anker_m5c">AnkerMake M5C</option>
            </optgroup>
          </select>
        </div>
        <div>
          <label for="printer-name" class="fm-label" data-i18n="printers.name">
            Name *
          </label>
          <input
            type="text"
            id="printer-name"
            required
            class="fm-input"
          />
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
          <div>
            <label for="printer-manufacturer" class="fm-label">
              Manufacturer
            </label>
            <input
              type="text"
              id="printer-manufacturer"
              class="fm-input"
            />
          </div>
          <div>
            <label for="printer-model" class="fm-label" data-i18n="printers.model">
              Model
            </label>
            <input
              type="text"
              id="printer-model"
              class="fm-input"
            />
          </div>
        </div>
        <div>
          <label for="printer-driver" class="fm-label" data-i18n="printers.driver">
            Driver *
          </label>
          <select
            id="printer-driver"
            required
            class="fm-select"
          >
            <option value="dummy" data-i18n="printers.driverDummy">Dummy (Testing)</option>
            <option value="bambu" data-i18n="printers.driverBambu">Bambu Lab</option>
            <option value="klipper">Klipper / Moonraker</option>
          </select>
        </div>
        <div>
          <label for="printer-serial" class="fm-label" data-i18n="printers.serialNumber">
            Serial Number
          </label>
          <input
            type="text"
            id="printer-serial"
            class="fm-input"
          />
        </div>
        <!-- Dynamic driver config fields -->
        <div id="driver-config-fields"></div>
        <div id="modal-error" class="fm-alert-error hidden"></div>
        <div style="display: flex; gap: 12px;">
          <button type="submit" id="modal-submit" class="fm-btn fm-btn-primary" data-i18n="common.save">
            Save
          </button>
          <button type="button" id="modal-cancel" class="fm-btn fm-btn-outline" data-i18n="common.cancel">
            Cancel
          </button>
        </div>
      </form>
    </div>
  </div>
  
  <script>
    import { t, initI18n } from '../../lib/i18n'
    await initI18n()

    const PRINTER_PRESETS: Record<string, {
      name: string; manufacturer: string; model: string;
      driver: string; max_ams_units: number; default_slots: number;
    }> = {
      bambu_x1c:     { name: "X1 Carbon",        manufacturer: "Bambu Lab",  model: "X1 Carbon",    driver: "bambu",   max_ams_units: 4, default_slots: 4 },
      bambu_x1e:     { name: "X1E",              manufacturer: "Bambu Lab",  model: "X1E",          driver: "bambu",   max_ams_units: 4, default_slots: 4 },
      bambu_p1s:     { name: "P1S",              manufacturer: "Bambu Lab",  model: "P1S",          driver: "bambu",   max_ams_units: 1, default_slots: 4 },
      bambu_p1p:     { name: "P1P",              manufacturer: "Bambu Lab",  model: "P1P",          driver: "bambu",   max_ams_units: 1, default_slots: 4 },
      bambu_a1:      { name: "A1",               manufacturer: "Bambu Lab",  model: "A1",           driver: "bambu",   max_ams_units: 1, default_slots: 4 },
      bambu_a1mini:  { name: "A1 Mini",          manufacturer: "Bambu Lab",  model: "A1 Mini",      driver: "bambu",   max_ams_units: 1, default_slots: 4 },
      prusa_mk4_mmu: { name: "MK4S + MMU3",      manufacturer: "Prusa",      model: "MK4S + MMU3",  driver: "klipper", max_ams_units: 1, default_slots: 5 },
      prusa_xl:      { name: "XL (5-Tool)",      manufacturer: "Prusa",      model: "XL",           driver: "klipper", max_ams_units: 1, default_slots: 5 },
      snapmaker_u1:  { name: "Artisan / U1",     manufacturer: "Snapmaker",  model: "Artisan",      driver: "klipper", max_ams_units: 1, default_slots: 4 },
      snapmaker_j1:  { name: "J1 / J1s",         manufacturer: "Snapmaker",  model: "J1",           driver: "klipper", max_ams_units: 1, default_slots: 2 },
      creality_k1:       { name: "K1",            manufacturer: "Creality",   model: "K1",           driver: "klipper", max_ams_units: 0, default_slots: 1 },
      creality_k1max:    { name: "K1 Max",        manufacturer: "Creality",   model: "K1 Max",       driver: "klipper", max_ams_units: 0, default_slots: 1 },
      creality_k2plus:   { name: "K2 Plus",       manufacturer: "Creality",   model: "K2 Plus",      driver: "klipper", max_ams_units: 0, default_slots: 1 },
      creality_ender3v3: { name: "Ender-3 V3",    manufacturer: "Creality",   model: "Ender-3 V3",   driver: "klipper", max_ams_units: 0, default_slots: 1 },
      voron_02:      { name: "Voron 0.2",        manufacturer: "Voron",      model: "0.2",          driver: "klipper", max_ams_units: 0, default_slots: 1 },
      voron_trident: { name: "Voron Trident",    manufacturer: "Voron",      model: "Trident",      driver: "klipper", max_ams_units: 0, default_slots: 1 },
      voron_24:      { name: "Voron 2.4",        manufacturer: "Voron",      model: "2.4",          driver: "klipper", max_ams_units: 0, default_slots: 1 },
      anker_m5:      { name: "AnkerMake M5",     manufacturer: "AnkerMake",  model: "M5",           driver: "klipper", max_ams_units: 0, default_slots: 1 },
      anker_m5c:     { name: "AnkerMake M5C",    manufacturer: "AnkerMake",  model: "M5C",          driver: "klipper", max_ams_units: 0, default_slots: 1 },
    }

    let selectedPreset: string | null = null
    let printers: any[] = []
    
    function getCsrfToken(): string {
      const match = document.cookie.match(/(?:^|;\s*)csrf_token=([^;]*)/)
      return match ? decodeURIComponent(match[1]) : ''
    }
    
    async function loadPrinters() {
      try {
        const response = await fetch('/api/v1/printers', { credentials: 'include' })
        
        if (!response.ok) throw new Error('Failed to fetch printers')
        
        printers = await response.json().then(d => d.items)
        renderPrinters()
      } catch (error) {
        console.error('Failed to load printers:', error)
        document.getElementById('printers-table')!.innerHTML = `
          <tr>
            <td colspan="5" style="text-align: center; color: var(--error-text);">${t('printers.failedLoad')}</td>
          </tr>
        `
      }
    }
    
    function renderPrinters() {
      const tbody = document.getElementById('printers-table')!
      
      if (printers.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5" style="text-align: center; color: var(--text-muted);">
              ${t('printers.noPrinters')}
            </td>
          </tr>
        `
        return
      }
      
      tbody.innerHTML = printers.map(p => `
        <tr style="cursor: pointer;" onclick="window.location='/printers/${p.id}'">
          <td style="padding: 12px; font-weight: 500;">${p.name}</td>
          <td style="padding: 12px; color: var(--text-muted);">
            ${p.manufacturer || ''} ${p.model || '-'}
          </td>
          <td style="padding: 12px;">
            <span style="padding: 2px 8px; font-size: 0.75rem; border-radius: 999px; background: var(--bg-soft); color: var(--text-muted);">${p.driver_key}</span>
          </td>
          <td style="padding: 12px;">
            <span style="padding: 2px 8px; font-size: 0.75rem; border-radius: 999px; background: var(--bg-soft); color: ${p.is_active ? 'var(--accent-2)' : 'var(--error-text)'};">
              ${p.is_active ? t('common.active') : t('common.inactive')}
            </span>
          </td>
          <td style="padding: 12px; text-align: right;" onclick="event.stopPropagation()">
            <button data-id="${p.id}" data-name="${p.name}" data-manufacturer="${p.manufacturer || ''}" data-model="${p.model || ''}" data-driver="${p.driver_key}" data-serial="${p.serial_number || ''}" class="btn-edit" style="color: var(--accent); background: none; border: none; cursor: pointer; margin-right: 12px;">${t('common.edit')}</button>
            <button data-id="${p.id}" class="btn-delete" style="color: var(--error-text); background: none; border: none; cursor: pointer;">${t('common.delete')}</button>
          </td>
        </tr>
      `).join('')
      
      document.querySelectorAll('.btn-edit').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const target = e.currentTarget as HTMLButtonElement
          const id = parseInt(target.dataset.id!)
          let driverConfig = {}
          try {
            const resp = await fetch(`/api/v1/printers/${id}`, { credentials: 'include' })
            if (resp.ok) {
              const detail = await resp.json()
              driverConfig = detail.driver_config || {}
            }
          } catch {}
          openModal(
            id,
            target.dataset.name!,
            target.dataset.manufacturer!,
            target.dataset.model!,
            target.dataset.driver!,
            target.dataset.serial!,
            driverConfig,
          )
        })
      })
      
      document.querySelectorAll('.btn-delete').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const target = e.currentTarget as HTMLButtonElement
          const id = parseInt(target.dataset.id!)
          
          if (!(await (window as any).__fmConfirm(t('printers.confirmDelete')))) return
          
          try {
            const response = await fetch(`/api/v1/printers/${id}`, {
              method: 'DELETE',
              headers: { 'X-CSRF-Token': getCsrfToken() },
              credentials: 'include',
            })
            
            if (!response.ok) {
              const data = await response.json()
              await (window as any).__fmAlert(data.message || t('printers.failedDelete'))
              return
            }
            
            loadPrinters()
          } catch {
            await (window as any).__fmAlert(t('printers.failedDelete'))
          }
        })
      })
    }
    
    let currentDriverConfig: Record<string, any> = {}

    function renderDriverConfigFields(driverKey: string) {
      const container = document.getElementById('driver-config-fields')!
      if (driverKey === 'bambu') {
        container.innerHTML = `
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <div>
              <label for="cfg-host" class="fm-label">IP-Adresse *</label>
              <input type="text" id="cfg-host" class="fm-input" placeholder="192.168.1.x" value="${currentDriverConfig.host || ''}" required />
            </div>
            <div>
              <label for="cfg-access-code" class="fm-label">Access Code *</label>
              <input type="text" id="cfg-access-code" class="fm-input" placeholder="8-stelliger Code" value="${currentDriverConfig.access_code || ''}" required />
            </div>
          </div>
        `
      } else if (driverKey === 'klipper') {
        container.innerHTML = `
          <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 16px;">
            <div>
              <label for="cfg-host" class="fm-label">Moonraker URL *</label>
              <input type="text" id="cfg-host" class="fm-input" placeholder="http://192.168.1.x:7125" value="${currentDriverConfig.host || ''}" required />
            </div>
            <div>
              <label for="cfg-api-key" class="fm-label">API Key</label>
              <input type="text" id="cfg-api-key" class="fm-input" placeholder="Optional" value="${currentDriverConfig.api_key || ''}" />
            </div>
          </div>
          <div style="margin-top: 12px;">
            <label for="cfg-slots" class="fm-label">Anzahl Filament-Slots</label>
            <input type="number" id="cfg-slots" class="fm-input" min="1" max="8" value="${currentDriverConfig.slots || 1}" style="max-width: 120px;" />
            <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 4px;">z.B. 4 f√ºr Snapmaker U1 mit AMS Lite</p>
          </div>
        `
      } else {
        container.innerHTML = ''
      }
    }

    function collectDriverConfig(driverKey: string): Record<string, any> | null {
      let cfg: Record<string, any> | null = null

      if (driverKey === 'bambu') {
        const host = (document.getElementById('cfg-host') as HTMLInputElement)?.value || ''
        const code = (document.getElementById('cfg-access-code') as HTMLInputElement)?.value || ''
        if (!host || !code) return null
        cfg = { host, access_code: code }
      } else if (driverKey === 'klipper') {
        const host = (document.getElementById('cfg-host') as HTMLInputElement)?.value || ''
        if (!host) return null
        const apiKey = (document.getElementById('cfg-api-key') as HTMLInputElement)?.value || ''
        const slotsVal = (document.getElementById('cfg-slots') as HTMLInputElement)?.value || '1'
        cfg = { host, slots: parseInt(slotsVal) || 1 }
        if (apiKey) cfg.api_key = apiKey
      }

      if (cfg && selectedPreset && PRINTER_PRESETS[selectedPreset]) {
        const preset = PRINTER_PRESETS[selectedPreset]
        if (preset.max_ams_units > 0) {
          cfg.max_ams_units = preset.max_ams_units
        }
      }

      return cfg
    }

    function openModal(id: number | null = null, name: string = '', manufacturer: string = '', model: string = '', driver: string = 'dummy', serial: string = '', driverConfig: Record<string, any> = {}) {
      const container = document.getElementById('modal-container')!
      const title = document.getElementById('modal-title')!
      const idInput = document.getElementById('printer-id') as HTMLInputElement
      const nameInput = document.getElementById('printer-name') as HTMLInputElement
      const mfrInput = document.getElementById('printer-manufacturer') as HTMLInputElement
      const modelInput = document.getElementById('printer-model') as HTMLInputElement
      const driverInput = document.getElementById('printer-driver') as HTMLSelectElement
      const serialInput = document.getElementById('printer-serial') as HTMLInputElement
      const presetSelect = document.getElementById('printer-preset') as HTMLSelectElement
      const error = document.getElementById('modal-error')!
      
      title.textContent = id ? t('printers.editPrinter') : t('printers.addPrinter')
      idInput.value = id ? String(id) : ''
      nameInput.value = name
      mfrInput.value = manufacturer
      modelInput.value = model
      driverInput.value = driver
      serialInput.value = serial
      presetSelect.value = ''
      selectedPreset = null
      currentDriverConfig = driverConfig || {}
      error.classList.add('hidden')
      
      renderDriverConfigFields(driver)
      container.classList.add('open')
      nameInput.focus()
    }

    document.getElementById('printer-preset')?.addEventListener('change', (e) => {
      const presetKey = (e.target as HTMLSelectElement).value
      selectedPreset = presetKey || null

      if (!presetKey) return

      const preset = PRINTER_PRESETS[presetKey]
      if (!preset) return

      ;(document.getElementById('printer-name') as HTMLInputElement).value = preset.name
      ;(document.getElementById('printer-manufacturer') as HTMLInputElement).value = preset.manufacturer
      ;(document.getElementById('printer-model') as HTMLInputElement).value = preset.model
      ;(document.getElementById('printer-driver') as HTMLSelectElement).value = preset.driver

      currentDriverConfig = {}
      if (preset.driver === 'klipper' && preset.default_slots > 1) {
        currentDriverConfig.slots = preset.default_slots
      }

      renderDriverConfigFields(preset.driver)
    })

    document.getElementById('printer-driver')?.addEventListener('change', (e) => {
      const val = (e.target as HTMLSelectElement).value
      currentDriverConfig = {}
      renderDriverConfigFields(val)
    })
    
    function closeModal() {
      document.getElementById('modal-container')!.classList.remove('open')
    }
    
    document.getElementById('btn-new')?.addEventListener('click', () => openModal())
    document.getElementById('modal-cancel')?.addEventListener('click', closeModal)
    
    document.getElementById('modal-form')?.addEventListener('submit', async (e) => {
      e.preventDefault()
      
      const id = (document.getElementById('printer-id') as HTMLInputElement).value
      const name = (document.getElementById('printer-name') as HTMLInputElement).value
      const manufacturer = (document.getElementById('printer-manufacturer') as HTMLInputElement).value || null
      const model = (document.getElementById('printer-model') as HTMLInputElement).value || null
      const driver_key = (document.getElementById('printer-driver') as HTMLSelectElement).value
      const serial_number = (document.getElementById('printer-serial') as HTMLInputElement).value || null
      const error = document.getElementById('modal-error') as HTMLDivElement
      const submitBtn = document.getElementById('modal-submit') as HTMLButtonElement
      
      const driver_config = collectDriverConfig(driver_key)
      const data: Record<string, any> = { name, manufacturer, model, driver_key, serial_number }
      if (driver_config) data.driver_config = driver_config
      
      error.classList.add('hidden')
      submitBtn.disabled = true
      submitBtn.textContent = t('common.saving')
      
      try {
        const url = id ? `/api/v1/printers/${id}` : '/api/v1/printers'
        const method = id ? 'PATCH' : 'POST'
        
        const response = await fetch(url, {
          method,
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': getCsrfToken(),
          },
          credentials: 'include',
          body: JSON.stringify(data),
        })
        
        if (!response.ok) {
          const errorData = await response.json()
          throw new Error(errorData.message || t('printers.failedSave'))
        }
        
        closeModal()
        loadPrinters()
      } catch (err: any) {
        error.textContent = err.message
        error.classList.remove('hidden')
      } finally {
        submitBtn.disabled = false
        submitBtn.textContent = t('common.save')
      }
    })
    
    loadPrinters()
  </script>
</Layout>
