---
import Layout from '../../layouts/Layout.astro'
---

<Layout title="FilaMan - Locations">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
    <h1 style="font-size: 1.8rem; font-weight: 700; margin: 0; font-family: var(--font-serif);" data-i18n="locations.title">Locations</h1>
    <button
      id="btn-new"
      class="fm-btn fm-btn-primary"
      data-i18n="locations.addLocation"
    >
      Add Location
    </button>
  </div>
  
  <div class="fm-card" style="padding: 0; overflow: hidden;">
    <table class="fm-table">
      <thead>
        <tr style="background: var(--bg-soft);">
          <th data-i18n="locations.name">Name</th>
          <th data-i18n="locations.identifier">Identifier</th>
          <th style="text-align: right;" data-i18n="locations.spools">Spools</th>
          <th style="text-align: right;" data-i18n="common.actions">Actions</th>
          <th style="width: 40px;"></th>
        </tr>
      </thead>
      <tbody id="locations-table">
        <tr>
          <td colspan="5" style="text-align: center; color: var(--text-muted);" data-i18n="common.loading">Loading...</td>
        </tr>
      </tbody>
    </table>
  </div>
  
  <div id="modal-container" class="fm-modal-overlay">
    <div class="fm-card" style="width: 100%; max-width: 28rem; margin: 0 1rem; padding: 24px;">
      <h3 id="modal-title" style="font-size: 1.15rem; font-weight: 600; margin-bottom: 16px;" data-i18n="locations.addLocation">Add Location</h3>
      <form id="modal-form" style="display: flex; flex-direction: column; gap: 16px;">
        <input type="hidden" id="location-id" />
        <div>
          <label for="location-name" class="fm-label">
            <span data-i18n="locations.name">Name</span> *
          </label>
          <input
            type="text"
            id="location-name"
            required
            class="fm-input"
          />
        </div>
        <div>
          <label for="location-identifier" class="fm-label" data-i18n="locations.identifier">
            Identifier
          </label>
          <input
            type="text"
            id="location-identifier"
            class="fm-input"
          />
        </div>
        <div id="modal-error" class="fm-alert-error hidden"></div>
        <div style="display: flex; gap: 12px;">
          <button type="submit" id="modal-submit" class="fm-btn fm-btn-primary" data-i18n="common.save">
            Save
          </button>
          <button type="button" id="modal-cancel" class="fm-btn fm-btn-outline" data-i18n="common.cancel">
            Cancel
          </button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- RFID Modal -->
  <div id="rfid-modal" class="fm-modal-overlay">
    <div class="fm-card" style="width: 100%; max-width: 28rem; margin: 0 1rem; padding: 24px;">
      <h3 style="font-size: 1.15rem; font-weight: 600; margin-bottom: 16px;" data-i18n="rfid.writeTag">Write RFID Tag</h3>
      <div id="rfid-content">
        <p style="margin-bottom: 16px;" id="rfid-text"></p>
        <div id="rfid-device-select-container" class="hidden">
          <label for="rfid-device-select" class="fm-label" data-i18n="rfid.selectDevice">Select Device</label>
          <select id="rfid-device-select" class="fm-select" style="margin-bottom: 16px;"></select>
        </div>
      </div>
      <div id="rfid-status" class="fm-alert hidden" style="margin-bottom: 16px;"></div>
      <div style="display: flex; gap: 12px;">
        <button id="rfid-confirm" class="fm-btn fm-btn-primary" data-i18n="common.confirm">Confirm</button>
        <button id="rfid-cancel" class="fm-btn fm-btn-outline" data-i18n="common.cancel">Cancel</button>
      </div>
    </div>
  </div>
  
  <script>
    import { t, initI18n, translatePage } from '../../lib/i18n'
    await initI18n()

    let locations: any[] = []
    let activeDevices: any[] = []
    
    function getCsrfToken(): string {
      const match = document.cookie.match(/(?:^|;\s*)csrf_token=([^;]*)/)
      return match ? decodeURIComponent(match[1]) : ''
    }
    
    async function loadActiveDevices() {
      try {
        const res = await fetch('/api/v1/devices/active', { credentials: 'include' })
        if (res.ok) {
          activeDevices = await res.json()
        }
      } catch (e) {
        console.error('Failed to load active devices:', e)
      }
    }

    async function loadLocations() {
      try {
        const locRes = await fetch('/api/v1/locations?page_size=200', { credentials: 'include' })
        if (!locRes.ok) throw new Error('Failed to fetch locations')
        locations = await locRes.json().then(d => d.items)
        renderLocations()
      } catch (error) {
        console.error('Failed to load locations:', error)
        document.getElementById('locations-table')!.innerHTML = `
          <tr>
            <td colspan="5" style="text-align: center; color: var(--error-text);">${t('locations.failedLoad')}</td>
          </tr>
        `
      }
    }
    
    function renderLocations() {
      const tbody = document.getElementById('locations-table')!
      
      if (locations.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5" style="text-align: center; color: var(--text-muted);">
              ${t('locations.noLocations')}
            </td>
          </tr>
        `
        return
      }
      
      tbody.innerHTML = locations.map(loc => {
        const rfidIcon = activeDevices.length > 0 ? `
          <td style="padding: 12px; text-align: center;" onclick="event.stopPropagation(); window.openRfidModal(${loc.id})">
            <button class="fm-btn fm-btn-outline" style="padding: 4px; line-height: 0;" data-i18n-title="rfid.writeTag">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 135.18028 115.18283" fill="currentColor"><g transform="translate(-37.583451,-63.372624)"><path d="m 70.222963,178.33313 c -2.040926,-0.39862 -7.168348,-4.13124 -11.835405,-8.61585 -11.236022,-10.7968 -18.197641,-24.54085 -20.318866,-40.11476 -0.914987,-6.71777 -0.506732,-16.35742 0.977968,-23.09161 2.31059,-10.480198 7.418829,-20.910018 14.204507,-29.002258 4.136212,-4.93262 11.33237,-11.25913 15.203175,-13.36589 3.228084,-1.75694 6.735163,-0.32453 7.658584,3.12804 0.247595,0.92573 0.239278,1.4288 -0.04012,2.4267 -0.455391,1.6265 -1.235816,2.52818 -3.546301,4.0973 -2.718612,1.84629 -6.655458,5.21243 -8.886438,7.5982 -8.337084,8.91553 -13.388674,19.334498 -15.242672,31.438188 -0.606927,3.96229 -0.606927,12.1773 0,16.13959 2.48356,16.21374 10.951629,29.82811 24.433921,39.28314 2.570726,1.80283 3.338858,2.98296 3.338858,5.12972 0,1.75821 -0.610733,3.02689 -1.972927,4.0984 -0.557741,0.43872 -2.492716,1.15289 -2.888792,1.06621 -0.07276,-0.0159 -0.561233,-0.11273 -1.085496,-0.21512 z m 67.475117,-0.10858 c -2.76471,-1.00625 -4.15566,-3.49487 -3.42065,-6.12008 0.4554,-1.6265 1.23582,-2.52818 3.54631,-4.0973 2.71861,-1.84629 6.65545,-5.21242 8.88643,-7.5982 8.33709,-8.91553 13.38868,-19.3345 15.24267,-31.43819 0.60693,-3.96229 0.60693,-12.1773 0,-16.13959 -2.48355,-16.213738 -10.95162,-29.828108 -24.43392,-39.283138 -2.57072,-1.80283 -3.33885,-2.98296 -3.33885,-5.12972 0,-1.31289 0.13178,-1.83293 0.66238,-2.61377 1.79517,-2.64183 4.51786,-3.15763 7.48598,-1.4182 3.97325,2.32848 10.82063,8.41172 14.77065,13.12229 6.78568,8.09224 11.89391,18.52206 14.2045,29.002258 1.94688,8.83047 1.94688,19.94969 0,28.78015 -2.31059,10.4802 -7.41882,20.91002 -14.2045,29.00226 -4.09611,4.8848 -11.38152,11.30257 -15.09913,13.30093 -1.58248,0.85065 -3.08971,1.07148 -4.30187,0.6303 z M 82.288667,161.67534 c -3.491247,-1.68198 -8.945231,-6.03926 -12.155513,-9.71126 -15.69411,-17.9513 -15.69411,-44.17488 0,-62.126188 3.158005,-3.6122 8.441186,-7.84766 12.143984,-9.73567 1.364318,-0.69565 1.767927,-0.78376 3.005287,-0.65605 2.768189,0.2857 4.656699,2.35691 4.633219,5.08147 -0.0205,2.38883 -1.613279,4.40879 -4.018978,5.10091 -1.487805,0.42805 -2.030508,0.76741 -3.856006,2.41151 -1.588824,1.43097 -4.108253,4.24273 -5.598731,6.24835 -7.264639,9.775838 -9.623192,23.361958 -6.315577,36.435728 2.054483,8.12056 7.073436,16.48834 13.067341,21.78201 1.721471,1.52037 4.455437,4.35414 6.07548,6.29727 1.582156,1.89768 2.378906,3.61347 2.378906,5.12061 0,1.38531 -0.472851,2.50367 -1.428753,3.37684 -1.139626,1.04098 -3.107412,1.35086 -4.895359,0.85848 -0.07276,-0.02 -0.561233,-0.12 -1.085496,-0.22 z m 45.748383,-0.10858 c -2.14777,-0.78241 -3.61453,-2.68417 -3.95111,-5.12998 -0.19794,-1.43831 0.45781,-3.10903 1.83852,-4.68652 1.43936,-1.64452 4.3948,-4.68729 6.56764,-6.7617 7.39956,-7.06456 12.37199,-16.29918 14.15228,-26.29828 1.15546,-6.48972 1.15546,-13.43477 0,-19.924488 -1.78029,-9.9991 -6.75272,-19.23372 -14.15228,-26.29828 -2.17284,-2.07441 -5.12828,-5.11718 -6.56764,-6.7617 -1.43194,-1.63604 -2.00843,-3.32832 -1.74567,-5.12328 0.42065,-2.87353 3.0132,-4.88729 6.27964,-4.88052 1.58334,0.003 2.16279,0.22462 3.85601,1.47467 4.1923,3.09503 9.47548,8.23933 13.04505,12.69532 15.69411,19.587848 15.69411,48.169128 0,67.756978 -3.15801,3.94276 -8.44119,8.56715 -12.14399,10.62828 -1.63852,0.91206 -4.12059,1.60256 -5.17845,1.43124 -0.0728,-0.0159 -0.56123,-0.11273 -1.0855,-0.21512 z M 94.354381,145.01755 c -2.932479,-1.20592 -6.136015,-5.24241 -8.324424,-10.47772 -3.737156,-8.94042 -3.737156,-20.13924 0,-29.079658 2.01222,-4.80665 4.881268,-8.74902 7.828621,-10.74902 1.259276,-0.85452 2.09115,-1.02537 3.42436,-0.70295 2.142517,0.51817 3.513411,2.02897 3.735417,4.12214 0.170462,1.60718 -0.329759,2.83685 -1.76495,4.33943 -1.240562,1.29881 -3.37699,4.40989 -4.39417,6.39129 -3.812328,7.426358 -3.812328,15.720348 0,23.146708 1.01718,1.9814 3.153608,5.09248 4.39417,6.39129 1.435191,1.50258 1.935412,2.73225 1.76495,4.33943 -0.252061,2.37687 -1.970221,4.0322 -4.329712,4.16853 -0.749722,0.0433 -1.821379,-0.38076 -2.334262,-0.88948 z m 21.617549,-0.10858 c -2.18526,-0.86475 -3.42588,-2.6883 -3.23847,-4.74718 0.15842,-1.74026 0.81404,-3.21008 2.37891,-4.74751 1.24056,-1.22026 3.37699,-4.14304 4.39417,-6.0071 3.81233,-6.9765 3.81233,-14.76678 0,-21.743288 -1.01718,-1.86406 -3.15361,-4.78684 -4.39417,-6.0071 -1.56487,-1.53743 -2.22049,-3.00725 -2.37891,-4.74751 -0.21006,-2.30752 1.34685,-4.43954 3.69239,-5.0559 1.1395,-0.29944 2.21369,-0.14798 3.25049,0.45938 3.03362,1.77717 6.13636,5.72025 8.13426,10.33941 3.73715,8.633538 3.73715,19.434858 0,28.068398 -2.14811,4.96023 -5.44141,9.08803 -8.53856,10.68651 -1.41249,0.72901 -2.39659,0.85465 -3.30011,0.50189 z M 105.17359,127.93043 c -5.047575,-2.68452 -5.047575,-9.2458 0,-11.930318 2.80936,-1.49397 6.04634,0.089 6.84365,3.33799 0.44621,1.81845 0.15049,3.64024 -0.83856,5.16104 -1.48784,2.28779 -4.01768,3.95758 -5.9189,3.88214 -0.0242,-10e-4 -0.0538,-0.0463 -0.0862,-0.11085 z"/></g></svg>
            </button>
          </td>
        ` : '<td></td>'

        return `
        <tr style="cursor: pointer;" onclick="window.location='/spools?location_id=${loc.id}'">
          <td style="padding: 12px; font-weight: 500;">${loc.name}</td>
          <td style="padding: 12px; color: var(--text-muted); font-family: monospace; font-size: 0.85rem;">${loc.identifier || '-'}</td>
          <td style="padding: 12px; text-align: right; color: var(--text-muted);">${loc.spool_count || 0}</td>
          <td style="padding: 12px; text-align: right;" onclick="event.stopPropagation()">
            <button data-id="${loc.id}" data-name="${loc.name}" data-identifier="${loc.identifier || ''}" class="btn-edit" style="color: var(--accent); background: none; border: none; cursor: pointer; margin-right: 12px;">${t('common.edit')}</button>
            <button data-id="${loc.id}" class="btn-delete" style="color: var(--error-text); background: none; border: none; cursor: pointer;">${t('common.delete')}</button>
          </td>
          ${rfidIcon}
        </tr>
      `}).join('')
      
      translatePage()

      document.querySelectorAll('.btn-edit').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const target = e.currentTarget as HTMLButtonElement
          openModal(
            parseInt(target.dataset.id!),
            target.dataset.name!,
            target.dataset.identifier!
          )
        })
      })
      
      document.querySelectorAll('.btn-delete').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const target = e.currentTarget as HTMLButtonElement
          const id = parseInt(target.dataset.id!)
          
          if (!(await (window as any).__fmConfirm(t('locations.confirmDelete')))) return
          
          try {
            const response = await fetch(`/api/v1/locations/${id}`, {
              method: 'DELETE',
              headers: { 'X-CSRF-Token': getCsrfToken() },
              credentials: 'include',
            })
            
            if (!response.ok) {
              const data = await response.json()
              await (window as any).__fmAlert(data.message || t('locations.failedDelete'))
              return
            }
            
            loadLocations()
          } catch {
            await (window as any).__fmAlert(t('locations.failedDelete'))
          }
        })
      })
    }
    
    function openModal(id: number | null = null, name: string = '', identifier: string = '') {
      const container = document.getElementById('modal-container')!
      const title = document.getElementById('modal-title')!
      const idInput = document.getElementById('location-id') as HTMLInputElement
      const nameInput = document.getElementById('location-name') as HTMLInputElement
      const identifierInput = document.getElementById('location-identifier') as HTMLInputElement
      const error = document.getElementById('modal-error')!
      
      title.textContent = id ? t('locations.editLocation') : t('locations.addLocation')
      idInput.value = id ? String(id) : ''
      nameInput.value = name
      identifierInput.value = identifier
      error.classList.add('hidden')
      
      container.classList.add('open')
      nameInput.focus()
    }
    
    function closeModal() {
      document.getElementById('modal-container')!.classList.remove('open')
    }
    
    document.getElementById('btn-new')?.addEventListener('click', () => openModal())
    document.getElementById('modal-cancel')?.addEventListener('click', closeModal)
    
    document.getElementById('modal-form')?.addEventListener('submit', async (e) => {
      e.preventDefault()
      
      const id = (document.getElementById('location-id') as HTMLInputElement).value
      const name = (document.getElementById('location-name') as HTMLInputElement).value
      const identifier = (document.getElementById('location-identifier') as HTMLInputElement).value || null
      const error = document.getElementById('modal-error') as HTMLDivElement
      const submitBtn = document.getElementById('modal-submit') as HTMLButtonElement
      
      const data = { name, identifier }
      
      error.classList.add('hidden')
      submitBtn.disabled = true
      submitBtn.textContent = t('common.saving')
      
      try {
        const url = id ? `/api/v1/locations/${id}` : '/api/v1/locations'
        const method = id ? 'PATCH' : 'POST'
        
        const response = await fetch(url, {
          method,
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': getCsrfToken(),
          },
          credentials: 'include',
          body: JSON.stringify(data),
        })
        
        if (!response.ok) {
          const errorData = await response.json()
          throw new Error(errorData.message || t('locations.failedSave'))
        }
        
        closeModal()
        loadLocations()
      } catch (err: any) {
        error.textContent = err.message
        error.classList.remove('hidden')
      } finally {
        submitBtn.disabled = false
        submitBtn.textContent = t('common.save')
      }
    })
    
    // RFID Modal Logic
    let currentRfidLocationId: number | null = null
    
    ;(window as any).openRfidModal = (locationId: number) => {
      currentRfidLocationId = locationId
      const modal = document.getElementById('rfid-modal')!
      const text = document.getElementById('rfid-text')!
      const deviceSelectContainer = document.getElementById('rfid-device-select-container')!
      const deviceSelect = document.getElementById('rfid-device-select') as HTMLSelectElement
      const status = document.getElementById('rfid-status')!
      
      status.classList.add('hidden')
      
      if (activeDevices.length === 1) {
        text.textContent = t('rfid.confirmWrite', { device: activeDevices[0].name })
        deviceSelectContainer.classList.add('hidden')
      } else {
        text.textContent = t('rfid.selectDeviceToWrite')
        deviceSelectContainer.classList.remove('hidden')
        deviceSelect.innerHTML = activeDevices.map(d => `<option value="${d.id}">${d.name} (${d.ip_address})</option>`).join('')
      }
      
      modal.classList.add('open')
    }
    
    document.getElementById('rfid-cancel')?.addEventListener('click', () => {
      document.getElementById('rfid-modal')!.classList.remove('open')
    })
    
    document.getElementById('rfid-confirm')?.addEventListener('click', async () => {
      if (!currentRfidLocationId) return
      
      const deviceId = activeDevices.length === 1 
        ? activeDevices[0].id 
        : (document.getElementById('rfid-device-select') as HTMLSelectElement).value
      
      const device = activeDevices.find(d => String(d.id) === String(deviceId))
      if (!device || !device.ip_address) return
      
      const confirmBtn = document.getElementById('rfid-confirm') as HTMLButtonElement
      const cancelBtn = document.getElementById('rfid-cancel') as HTMLButtonElement
      const status = document.getElementById('rfid-status')!
      
      confirmBtn.disabled = true
      cancelBtn.disabled = true
      status.textContent = t('rfid.writing')
      status.className = 'fm-alert fm-alert-info'
      status.classList.remove('hidden')
      
      try {
        const response = await fetch(`http://${device.ip_address}/api/v1/rfid/write`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ location_id: currentRfidLocationId }),
        })
        
        if (!response.ok) throw new Error('Failed to write tag')
        
        status.textContent = t('rfid.writeSuccess')
        status.className = 'fm-alert fm-alert-success'
        
        setTimeout(() => {
          document.getElementById('rfid-modal')!.classList.remove('open')
          confirmBtn.disabled = false
          cancelBtn.disabled = false
        }, 1500)
      } catch (err) {
        status.textContent = t('rfid.writeError')
        status.className = 'fm-alert fm-alert-error'
        confirmBtn.disabled = false
        cancelBtn.disabled = false
      }
    })
    
    loadActiveDevices().then(() => loadLocations())
  </script>
</Layout>
