---
import Layout from '../../layouts/Layout.astro'
---

<Layout title="FilaMan - Spools">
  <style>
    .sortable { cursor: pointer; user-select: none; }
    .sortable:hover { background: var(--bg-hover); }
    .sortable::after { content: ' \2195'; opacity: 0.3; font-size: 0.8em; }
    .sortable.sort-asc::after { content: ' \2191'; opacity: 1; }
    .sortable.sort-desc::after { content: ' \2193'; opacity: 1; }
  </style>
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
    <h1 style="font-size: 1.8rem; font-weight: 700; margin: 0; font-family: var(--font-serif);" data-i18n="spools.title">Spools</h1>
    <a href="/spools/new" class="fm-btn fm-btn-primary" data-i18n="spools.addSpool">
      Add Spool
    </a>
  </div>
  
  <div style="margin-bottom: 16px; display: flex; gap: 16px;">
    <select id="filter-status" class="fm-select" style="width: auto; min-width: 160px;">
      <option value="" data-i18n="spools.allStatuses">All Statuses</option>
    </select>
    <select id="filter-location" class="fm-select" style="width: auto; min-width: 160px;">
      <option value="" data-i18n="spools.allLocations">All Locations</option>
    </select>
  </div>
  
  <div class="fm-card" style="padding: 0; overflow: hidden;">
    <table class="fm-table">
      <thead>
        <tr style="background: var(--bg-soft);">
          <th data-i18n="spools.id" data-sort="id" class="sortable">ID</th>
          <th data-i18n="spools.filament" data-sort="filament_id" class="sortable">Filament</th>
          <th data-i18n="spools.status" data-sort="status_id" class="sortable">Status</th>
          <th data-i18n="spools.remaining" data-sort="remaining_weight_g" class="sortable">Remaining</th>
          <th data-i18n="spools.location" data-sort="location_id" class="sortable">Location</th>
        </tr>
      </thead>
      <tbody id="spools-table">
        <tr>
          <td colspan="5" style="text-align: center; color: var(--text-muted);" data-i18n="common.loading">Loading...</td>
        </tr>
      </tbody>
    </table>
  </div>
  
  <div id="pagination" style="margin-top: 16px; display: flex; justify-content: space-between; align-items: center;"></div>
  
  <script>
    import { t, initI18n } from '../../lib/i18n'
    await initI18n()

    let currentPage = 1
    const pageSize = 50
    let statuses: any[] = []
    let locations: any[] = []
    let filaments: any[] = []
    let allSpools: any[] = []
    let sortKey: string | null = null
    let sortDirection: 'asc' | 'desc' | null = null

    function setupSortableHeaders() {
      document.querySelectorAll('th[data-sort]').forEach(th => {
        th.addEventListener('click', () => {
          const key = (th as HTMLElement).dataset.sort!
          if (sortKey === key) {
            if (sortDirection === 'asc') sortDirection = 'desc'
            else if (sortDirection === 'desc') { sortKey = null; sortDirection = null }
            else sortDirection = 'asc'
          } else {
            sortKey = key
            sortDirection = 'asc'
          }
          updateSortIndicators()
          renderSpools(allSpools)
        })
      })
    }

    function updateSortIndicators() {
      document.querySelectorAll('th[data-sort]').forEach(th => {
        const key = (th as HTMLElement).dataset.sort!
        th.classList.remove('sort-asc', 'sort-desc')
        if (sortKey === key && sortDirection) {
          th.classList.add(sortDirection === 'asc' ? 'sort-asc' : 'sort-desc')
        }
      })
    }

    function getSortValue(item: any, key: string): any {
      if (key === 'filament_id') return getFilamentName(item.filament_id)
      if (key === 'status_id') return getStatusLabel(item.status_id)
      if (key === 'location_id') return getLocationName(item.location_id)
      return item[key]
    }

    function sortSpools(spools: any[]): any[] {
      if (!sortKey || !sortDirection) return spools
      return [...spools].sort((a, b) => {
        const aVal = getSortValue(a, sortKey)
        const bVal = getSortValue(b, sortKey)
        let cmp = 0
        if (aVal == null && bVal == null) cmp = 0
        else if (aVal == null) cmp = 1
        else if (bVal == null) cmp = -1
        else if (typeof aVal === 'string') cmp = aVal.localeCompare(bVal)
        else cmp = aVal - bVal
        return sortDirection === 'asc' ? cmp : -cmp
      })
    }
    
    async function loadFilters() {
      try {
        const [statusesRes, locationsRes, filamentsRes] = await Promise.all([
          fetch('/api/v1/spools/statuses', { credentials: 'include' }).catch(() => null),
          fetch('/api/v1/locations?page_size=200', { credentials: 'include' }),
          fetch('/api/v1/filaments?page_size=200', { credentials: 'include' }),
        ])

        if (statusesRes?.ok) {
          statuses = await statusesRes.json()
          const select = document.getElementById('filter-status') as HTMLSelectElement
          statuses.forEach((s: any) => {
            const opt = document.createElement('option')
            opt.value = s.id
            const i18nKey = `spools.status${s.key.charAt(0).toUpperCase() + s.key.slice(1)}`
            opt.textContent = t(i18nKey) || s.label
            select.appendChild(opt)
          })
        }
        
        if (locationsRes?.ok) {
          const data = await locationsRes.json()
          locations = data.items
          const select = document.getElementById('filter-location') as HTMLSelectElement
          locations.forEach((l: any) => {
            const opt = document.createElement('option')
            opt.value = l.id
            opt.textContent = l.name
            select.appendChild(opt)
          })
        }
        
        if (filamentsRes?.ok) {
          const data = await filamentsRes.json()
          filaments = data.items
        }
      } catch (error) {
        console.error('Failed to load filters:', error)
      }
    }
    
    async function loadSpools(page: number = 1) {
      const statusId = (document.getElementById('filter-status') as HTMLSelectElement).value
      const locationId = (document.getElementById('filter-location') as HTMLSelectElement).value
      
      let url = `/api/v1/spools?page=${page}&page_size=${pageSize}`
      if (statusId) url += `&status_id=${statusId}`
      if (locationId) url += `&location_id=${locationId}`
      
      try {
        const response = await fetch(url, { credentials: 'include' })
        
        if (!response.ok) throw new Error('Failed to fetch spools')
        
        const data = await response.json()
        allSpools = data.items
        renderSpools(allSpools)
        renderPagination(data.total, data.page)
      } catch (error) {
        console.error('Failed to load spools:', error)
        document.getElementById('spools-table')!.innerHTML = `
          <tr>
            <td colspan="5" style="text-align: center; color: var(--error-text);">${t('spools.failedLoad')}</td>
          </tr>
        `
      }
    }
    
    function getFilamentName(filamentId: number): string {
      const f = filaments.find(f => f.id === filamentId)
      return f ? `${f.designation} (${f.type})` : `#${filamentId}`
    }

    function getStatusLabel(statusId: number): string {
      const s = statuses.find((s: any) => s.id === statusId)
      if (!s) return `#${statusId}`
      const i18nKey = `spools.status${s.key.charAt(0).toUpperCase() + s.key.slice(1)}`
      return t(i18nKey) || s.label
    }
    
    function getLocationName(locationId: number | null): string {
      if (!locationId) return '-'
      const l = locations.find(l => l.id === locationId)
      return l ? l.name : `#${locationId}`
    }
    
    function renderSpools(spools: any[]) {
      const tbody = document.getElementById('spools-table')!
      const sorted = sortSpools(spools)
      
      if (sorted.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5" style="text-align: center; color: var(--text-muted);">
              ${t('spools.noSpools')} <a href="/spools/new" style="color: var(--accent);">${t('spools.addOne')}</a>.
            </td>
          </tr>
        `
        return
      }
      
      tbody.innerHTML = sorted.map(s => {
        const isLow = s.remaining_weight_g !== null && 
                      s.remaining_weight_g > 0 && 
                      s.remaining_weight_g <= s.low_weight_threshold_g
        const isEmpty = s.remaining_weight_g !== null && s.remaining_weight_g <= 0
        
        let weightStyle = ''
        if (isEmpty) weightStyle = 'color: var(--error-text); font-weight: 500;'
        else if (isLow) weightStyle = 'color: var(--accent-3); font-weight: 500;'
        
        return `
          <tr style="cursor: pointer;" onclick="window.location='/spools/${s.id}'">
            <td style="padding: 12px; font-weight: 500;">${t('spools.spoolId', { id: s.id })}</td>
            <td style="padding: 12px;">${getFilamentName(s.filament_id)}</td>
            <td style="padding: 12px;">${getStatusLabel(s.status_id)}</td>
            <td style="padding: 12px; font-family: monospace; ${weightStyle}">
              ${s.remaining_weight_g !== null ? s.remaining_weight_g.toFixed(0) + 'g' : '-'}
            </td>
            <td style="padding: 12px;">${getLocationName(s.location_id)}</td>
          </tr>
        `
      }).join('')
    }
    
    function renderPagination(total: number, page: number) {
      const totalPages = Math.ceil(total / pageSize)
      const container = document.getElementById('pagination')!
      
      if (totalPages <= 1) {
        container.innerHTML = `<div style="font-size: 0.85rem; color: var(--text-muted);">${t('spools.spoolCount', { count: total })}</div>`
        return
      }
      
      container.innerHTML = `
        <div style="font-size: 0.85rem; color: var(--text-muted);">
          ${t('common.showing')} ${((page - 1) * pageSize) + 1}-${Math.min(page * pageSize, total)} ${t('common.of')} ${total}
        </div>
        <div style="display: flex; gap: 8px;">
          <button 
            id="prev-btn"
            class="fm-btn fm-btn-outline"
            style="padding: 6px 14px; font-size: 0.85rem;"
            ${page <= 1 ? 'disabled' : ''}
          >
            ${t('common.previous')}
          </button>
          <button 
            id="next-btn"
            class="fm-btn fm-btn-outline"
            style="padding: 6px 14px; font-size: 0.85rem;"
            ${page >= totalPages ? 'disabled' : ''}
          >
            ${t('common.next')}
          </button>
        </div>
      `
      
      document.getElementById('prev-btn')?.addEventListener('click', () => {
        if (page > 1) loadSpools(page - 1)
      })
      document.getElementById('next-btn')?.addEventListener('click', () => {
        if (page < totalPages) loadSpools(page + 1)
      })
    }
    
    document.getElementById('filter-status')?.addEventListener('change', () => loadSpools(1))
    document.getElementById('filter-location')?.addEventListener('change', () => loadSpools(1))
    
    setupSortableHeaders()
    loadFilters().then(() => loadSpools())
  </script>
</Layout>
